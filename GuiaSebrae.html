<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Argumento de Solu√ß√µes Sebrae</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-blue: #00608B;
      --secondary-blue: #0092BA;
      --accent-cyan: #66C9D3;
      --light-blue: #A0C5CF;
      --very-light-blue: #E3ECEE;
      --accent-green: #00A859;
      --bg-gradient: linear-gradient(135deg, #00608B 0%, #0092BA 25%, #66C9D3 50%, #A0C5CF 100%);
      --card-shadow: 0 10px 40px rgba(0, 96, 139, 0.1);
      --card-shadow-hover: 0 20px 60px rgba(0, 96, 139, 0.2);
    }

    html {
      height: 100%;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 50%, #ffffff 100%);
      background-attachment: fixed;
    }
    
    body {
      box-sizing: border-box;
      font-family: 'Inter', 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 50%, #ffffff 100%);
      background-attachment: fixed;
      min-height: 100%;
    }
    
    * {
      box-sizing: border-box;
    }

    .sebrae-gradient {
      background: var(--bg-gradient);
      position: relative;
      overflow: hidden;
    }

    .sebrae-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }

    .card-option {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      border: 2px solid transparent;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .card-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .card-option:hover::before {
      left: 100%;
    }

    .card-option:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--card-shadow-hover);
      border-color: var(--primary-blue);
    }

    .card-option.selected {
      border-color: var(--accent-green);
      background: linear-gradient(135deg, #E8F7F0 0%, #ffffff 100%);
      box-shadow: 0 0 0 3px rgba(0, 168, 89, 0.1);
    }

    .step-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      background: #E0E0E0;
      color: #666;
      transition: all 0.3s ease;
    }

    .step-circle.active {
      background: #00608B;
      color: white;
      transform: scale(1.15);
    }

    .step-circle.completed {
      background: #00A859;
      color: white;
    }

    .step-line {
      flex: 1;
      height: 3px;
      background: #E0E0E0;
      transition: all 0.3s ease;
    }

    .step-line.completed {
      background: #00A859;
    }

    .btn-primary {
      transition: all 0.3s ease;
    }

    .btn-primary:hover:not(:disabled) {
      transform: scale(1.03);
      box-shadow: 0 8px 20px rgba(0, 92, 169, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      word-wrap: break-word;
      max-width: 100%;
      white-space: normal;
    }

    .resultado-card {
      transition: all 0.3s ease;
    }

    .resultado-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 92, 169, 0.15);
    }

    .resultado-card.card-clicavel {
      cursor: pointer;
    }

    .fluxo-trilha {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      flex-wrap: wrap;
    }

    .fluxo-etapa {
      padding: 0.4rem 0.6rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      background: #E3ECEE;
      color: #00608B;
      border: 2px solid rgba(0,92,169,0.3);
    }

    .fluxo-etapa--destaque {
      background: linear-gradient(135deg, #00608B 0%, #0092BA 100%);
      color: white;
      border-color: #00608B;
      font-size: 0.8rem;
      padding: 0.5rem 0.75rem;
      box-shadow: 0 2px 8px rgba(0,92,169,0.35);
    }

    .fluxo-seta {
      color: #00608B;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .trilha-timeline {
      position: relative;
      padding-left: 1.5rem;
      border-left: 3px solid #00608B;
    }

    /* Estilos para o Fluxograma/Trilha Din√¢mico - Design Moderno */
    .trilha-fluxograma {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 0;
      padding: 2rem 1rem;
      position: relative;
      overflow-x: auto;
      overflow-y: visible;
      scroll-behavior: smooth;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 1.5rem;
      min-height: 500px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .trilha-step {
      flex: 0 0 auto;
      min-width: 350px;
      max-width: 450px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 0 1.5rem;
      box-sizing: border-box;
    }

    /* Chevron (Seta) para ASSESSORIA */
    .trilha-assessoria-chevron {
      position: relative;
      width: 100%;
      max-width: 280px;
      height: 80px;
      background: linear-gradient(135deg, #00608B 0%, #0092BA 100%);
      clip-path: polygon(0 0, calc(100% - 30px) 0, 100% 50%, calc(100% - 30px) 100%, 0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
    }

    .trilha-assessoria-chevron:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(139, 92, 246, 0.5);
    }

    .trilha-assessoria-chevron::after {
      content: '';
      position: absolute;
      right: -30px;
      top: 0;
      width: 0;
      height: 0;
      border-left: 30px solid var(--chevron-color, #0092BA);
      border-top: 40px solid transparent;
      border-bottom: 40px solid transparent;
      opacity: 0.87;
    }

    .trilha-assessoria-text {
      color: white;
      font-size: 1.5rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      z-index: 1;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Linha tracejada vertical */
    .trilha-dashed-line {
      position: absolute;
      left: 50%;
      top: 80px;
      width: 2px;
      height: 40px;
      border-left: 2px dashed #9CA3AF;
      transform: translateX(-50%);
    }

    /* Hex√°gono roxo como conector */
    .trilha-hexagon {
      position: absolute;
      left: 50%;
      top: 120px;
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #00608B 0%, #0092BA 100%);
      clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%);
      transform: translateX(-50%);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
      z-index: 3;
    }

    .trilha-step-content {
      width: 100%;
      margin-top: 60px;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      padding-left: 1rem;
      box-sizing: border-box;
    }

    /* Container de Dor */
    .trilha-dor-container {
      border: 2px solid #A0C5CF;
      border-radius: 0.75rem;
      padding: 0.75rem;
      background: #E3ECEE;
      margin-bottom: 1.5rem;
    }

    .trilha-dor-header {
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.15);
    }

    .trilha-dor-solucoes {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .trilha-solucao-card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      background: white;
      width: 100%;
      max-width: 100%;
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      margin-left: 1rem;
      width: 100%;
      box-sizing: border-box;
    }

    .trilha-solucao-card::before {
      content: '';
      position: absolute;
      left: -1rem;
      top: 50%;
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, var(--card-hexagon-color, #00608B) 0%, var(--card-hexagon-color, #00608B)dd 100%);
      clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%);
      transform: translateY(-50%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 2;
    }

    .trilha-solucao-card:hover {
      transform: translateY(-6px) translateX(4px);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);
      border-color: #00608B;
    }

    /* Destaque de Pre√ßo e Tipo de Produto */
    .trilha-solucao-card .destaque-preco-tipo {
      background: linear-gradient(135deg, #E3ECEE 0%, #A0C5CF 100%);
      border: 2px solid #00608B;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 1rem;
    }

    /* Divisor vertical roxo entre steps */
    .trilha-step-divider {
      position: absolute;
      right: 0;
      top: 0;
      width: 3px;
      height: 100%;
      background: linear-gradient(180deg, #00608B 0%, #0092BA 100%);
      opacity: 0.6;
    }

    /* Conector horizontal entre steps */
    .trilha-connector {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      margin: 0;
      position: relative;
      align-self: center;
      min-width: 80px;
      height: 80px;
      flex-shrink: 0;
    }

    .trilha-connector-line {
      width: 60px;
      height: 4px;
      background: linear-gradient(90deg, #00608B 0%, #0092BA 100%);
      border-radius: 2px;
      animation: flowRight 2s ease-in-out infinite;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
    }

    @keyframes flowRight {
      0%, 100% { opacity: 0.6; transform: scaleX(1); }
      50% { opacity: 1; transform: scaleX(1.1); }
    }

    .trilha-connector-hexagon {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #00608B 0%, #0092BA 100%);
      clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%);
      margin-left: 0.5rem;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
      animation: pulseHexagon 2s ease-in-out infinite;
    }

    @keyframes pulseHexagon {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Responsividade para o fluxograma */
    @media (max-width: 1400px) {
      .trilha-step {
        min-width: 320px;
        max-width: 380px;
        padding: 0 1rem;
      }
      
      .trilha-assessoria-chevron {
        max-width: 240px;
        height: 75px;
      }

      .trilha-assessoria-text {
        font-size: 1.3rem;
      }
    }

    @media (max-width: 1024px) {
      .trilha-fluxograma {
        padding: 1.5rem 0.5rem;
      }

      .trilha-step {
        min-width: 300px;
        max-width: 350px;
        padding: 0 1rem;
      }
      
      .trilha-assessoria-chevron {
        max-width: 220px;
        height: 70px;
      }

      .trilha-assessoria-text {
        font-size: 1.2rem;
      }
      
      .trilha-connector {
        min-width: 50px;
      }
      
      .trilha-connector-line {
        width: 40px;
      }

      .trilha-step-content {
        padding-left: 0.5rem;
      }

      .trilha-solucao-card {
        margin-left: 0.5rem;
      }
    }

    @media (max-width: 768px) {
      .trilha-fluxograma {
        flex-direction: column;
        align-items: center;
        gap: 2rem;
        padding: 1.5rem 1rem;
        min-height: auto;
        overflow-x: visible;
      }

      .trilha-step {
        width: 100%;
        max-width: 100%;
        min-width: auto;
        padding: 0 0.5rem;
        align-items: center;
      }

      .trilha-step-divider {
        display: none;
      }

      .trilha-assessoria-chevron {
        width: 100%;
        max-width: 100%;
        height: 70px;
        clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 50%, calc(100% - 20px) 100%, 0 100%);
      }

      .trilha-assessoria-chevron::after {
        right: -20px;
        border-left-width: 20px;
        border-top-width: 35px;
        border-bottom-width: 35px;
      }

      .trilha-assessoria-text {
        font-size: 1.1rem;
        padding: 0 1rem;
      }

      .trilha-step-content {
        padding-left: 0;
        width: 100%;
        max-width: 100%;
        margin-top: 50px;
      }

      .trilha-solucao-card {
        margin-left: 0;
        width: 100%;
      }

      .trilha-solucao-card::before {
        display: none;
      }

      .trilha-connector {
        flex-direction: column;
        margin: 1rem 0;
        min-width: auto;
        height: auto;
        width: 100%;
      }

      .trilha-connector-line {
        width: 3px;
        height: 40px;
        background: linear-gradient(180deg, #00608B 0%, #0092BA 100%);
      }

      .trilha-connector-hexagon {
        margin-left: 0;
        margin-top: 0.5rem;
      }

      .trilha-dashed-line {
        display: none;
      }

      .trilha-hexagon {
        display: none;
      }

      .trilha-dor-container {
        width: 100%;
      }
    }

    /* Responsividade para banners */
    @media (max-width: 640px) {
      .trilha-fluxograma {
        padding: 1rem 0.5rem !important;
      }
    }

    @media (max-width: 480px) {
      .trilha-fluxograma {
        padding: 0.75rem 0.25rem;
      }

      .trilha-assessoria-chevron {
        height: 60px;
      }

      .trilha-assessoria-text {
        font-size: 0.9rem;
        padding: 0 0.5rem;
      }

      .trilha-step-content {
        margin-top: 40px;
      }

      .trilha-solucao-card {
        padding: 0.75rem !important;
        margin-bottom: 0.75rem !important;
      }

      .modal-content {
        padding: 1rem;
        margin: 0.5rem;
        width: 95%;
      }
    }

    /* Ajustes adicionais para telas muito pequenas */
    @media (max-width: 360px) {
      .trilha-assessoria-text {
        font-size: 0.8rem;
        letter-spacing: 0.05em;
      }

      .trilha-solucao-card {
        padding: 0.5rem !important;
      }

      .trilha-solucao-card h5 {
        font-size: 0.875rem;
      }

      .trilha-solucao-card p {
        font-size: 0.75rem;
      }
    }

    .trilha-timeline .etapa {
      position: relative;
      padding-bottom: 1rem;
    }

    .trilha-timeline .etapa::before {
      content: '';
      position: absolute;
      left: -1.65rem;
      top: 0.35rem;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #00608B;
    }

    .trilha-timeline .etapa:last-child {
      padding-bottom: 0;
    }

    .tab-button {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      position: relative;
      background: transparent;
    }

    .tab-button::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 80%;
      height: 3px;
      background: var(--primary-blue);
      transition: transform 0.3s ease;
    }

    .tab-button.active::after {
      transform: translateX(-50%) scaleX(1);
    }

    .tab-button.active {
      color: var(--primary-blue);
      font-weight: 700;
      background: rgba(0, 92, 169, 0.05);
    }

    .tab-button:hover:not(.active) {
      color: var(--primary-blue);
      background: rgba(0, 92, 169, 0.03);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: var(--card-shadow);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
      padding: 1rem;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      margin: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      animation: slideUp 0.3s ease;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .modal-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    @media (max-width: 640px) {
      .modal-overlay {
        padding: 0;
        align-items: flex-end;
        padding-top: 0;
      }
      
      .modal-content {
        max-width: 100%;
        width: 100%;
        max-height: 90vh;
        padding: 1rem;
        border-radius: 20px 20px 0 0;
        margin: 0;
        margin-top: auto;
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        max-height: 95vh;
        padding: 0.875rem;
      }
      
      .modal-content h2 {
        font-size: 1.125rem !important;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .input-modern {
      transition: all 0.3s ease;
      border: 2px solid #e5e7eb;
    }

    .input-modern:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 4px rgba(0, 92, 169, 0.1);
      outline: none;
    }

    .btn-modern {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn-modern::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn-modern:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-modern:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 92, 169, 0.3);
    }

    /* --- Sidebar lateral: azul escura (guide) + abrir/fechar em todos os tamanhos --- */
    #app-root { display: flex; min-height: 100vh; }
    #main-wrap { flex: 1; display: flex; flex-direction: column; min-width: 0; background: transparent; min-height: 100vh; }
    #app-wrapper { background: transparent; }

    #sidebar {
      width: 280px;
      max-width: 85vw;
      flex-shrink: 0;
      background: linear-gradient(180deg, #004d6d 0%, #00608B 50%, #0077a3 100%);
      border-right: 1px solid rgba(0,0,0,0.15);
      box-shadow: 4px 0 24px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1), box-shadow 0.35s ease;
      z-index: 100;
    }

    .sidebar-brand {
      padding: 1.25rem 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .sidebar-brand a {
      font-size: 1.05rem;
      font-weight: 800;
      color: #fff;
      text-decoration: none;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      min-width: 0;
    }
    .sidebar-brand a:hover { color: rgba(255,255,255,0.9); }
    .sidebar-brand .logo-icon { font-size: 1.4rem; flex-shrink: 0; }
    #btn-sidebar-close {
      flex-shrink: 0;
      width: 36px; height: 36px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    #btn-sidebar-close:hover { background: rgba(255,255,255,0.25); }
    #btn-sidebar-close svg { width: 20px; height: 20px; }

    .sidebar-nav { padding: 1rem 0.75rem; flex: 1; overflow-y: auto; }
    .sidebar-nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.25rem;
      border-radius: 12px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.88);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      text-align: left;
      transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
    }
    .sidebar-nav-item:hover {
      background: rgba(255,255,255,0.12);
      color: #fff;
      transform: translateX(4px);
    }
    .sidebar-nav-item:focus-visible {
      outline: 2px solid rgba(255,255,255,0.6);
      outline-offset: 2px;
    }
    .sidebar-nav-item.active {
      background: rgba(255,255,255,0.18);
      color: #fff;
      border-left: 4px solid #fff;
      padding-left: calc(1rem - 4px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .sidebar-nav-item .nav-icon { font-size: 1.25rem; flex-shrink: 0; width: 1.5rem; text-align: center; }
    .sidebar-nav-item .nav-icon--lock { opacity: 0.9; }

    .sidebar-footer { padding: 1rem 0.75rem; border-top: 1px solid rgba(255,255,255,0.12); }
    .sidebar-nav-item.sidebar-sair { color: rgba(255,255,255,0.8); }
    .sidebar-nav-item.sidebar-sair:hover { background: rgba(220,38,38,0.3); color: #fff; }

    #sidebar-backdrop {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(2px);
      z-index: 90;
      animation: fadeIn 0.25s ease;
    }
    #sidebar-backdrop.backdrop--on { display: block; }

    #btn-sidebar-open {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      z-index: 95;
      width: 44px;
      height: 56px;
      border: none;
      border-radius: 0 12px 12px 0;
      background: linear-gradient(90deg, #004d6d 0%, #00608B 100%);
      color: #fff;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 4px 0 12px rgba(0,0,0,0.2);
      transition: opacity 0.2s, left 0.2s;
    }
    #btn-sidebar-open:hover { opacity: 0.95; left: 2px; }
    #btn-sidebar-open svg { width: 24px; height: 24px; }
    #btn-sidebar-open.sidebar-open--visible { display: flex; }

    #topbar-mobile {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.97);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0,92,169,0.1);
      flex-shrink: 0;
    }
    #btn-menu-mobile {
      padding: 0.5rem;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: var(--primary-blue);
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }
    #btn-menu-mobile:hover { background: rgba(0,92,169,0.08); }
    #btn-menu-mobile:active { transform: scale(0.96); }
    #btn-menu-mobile svg { width: 24px; height: 24px; }
    .topbar-logo { font-size: 1rem; font-weight: 700; color: var(--primary-blue); text-decoration: none; }

    /* Comportamento √∫nico: sidebar pode ser fechada/aberta em qualquer viewport */
    #sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
    }
    @media (max-width: 1023px) {
      #sidebar {
        transform: translateX(-100%);
        box-shadow: none;
      }
      #sidebar.sidebar--open { transform: translateX(0); box-shadow: 8px 0 32px rgba(0,0,0,0.25); }
      #main-wrap { margin-left: 0; padding-top: 0; }
      /* No responsivo usa-se s√≥ o bot√£o do canto superior esquerdo (topbar), n√£o o flutuante */
      #btn-sidebar-open { display: none !important; }
    }
    @media (min-width: 1024px) {
      #sidebar {
        transform: translateX(0);
      }
      #sidebar.sidebar--closed {
        transform: translateX(-100%);
        box-shadow: none;
      }
      #main-wrap { margin-left: 280px; transition: margin-left 0.35s cubic-bezier(0.4,0,0.2,1); }
      #main-wrap.sidebar-closed-margin { margin-left: 0; }
      #topbar-mobile { display: none; }
      #btn-sidebar-open.sidebar-open--visible { display: flex; }
    }

    @media (prefers-reduced-motion: reduce) {
      #sidebar, .sidebar-nav-item, #sidebar-backdrop, #main-wrap { transition: none; }
      .sidebar-nav-item:hover { transform: none; }
    }

    /* Responsividade geral */
    .tab-content { min-height: 0; }
    #app-wrapper { -webkit-overflow-scrolling: touch; }
    img { max-width: 100%; height: auto; }
    table { display: block; overflow-x: auto; }
    @media (max-width: 640px) {
      .glass-card, .rounded-2xl { border-radius: 1rem; }
      .p-6 { padding: 1rem; }
      .text-3xl { font-size: 1.5rem; }
      .text-2xl { font-size: 1.25rem; }
    }
    @media (max-width: 360px) {
      .glass-card, .rounded-2xl { border-radius: 0.75rem; }
      .p-6 { padding: 0.75rem; }
      .w-full.max-w-7xl.mx-auto { padding-left: 0.75rem; padding-right: 0.75rem; }
    }

    /* Estilos do Calend√°rio */
    .evento-dia {
      transition: all 0.2s ease;
      word-wrap: break-word;
      overflow: hidden;
      display: block;
      line-height: 1.2;
      white-space: nowrap;
      text-overflow: ellipsis;
      width: 100%;
    }

    .evento-dia:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    #calendario-container {
      width: 100%;
      overflow: hidden;
    }

    #calendario-container table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      table-layout: fixed;
    }

    #calendario-container th {
      width: calc(100% / 7);
      padding: 0.5rem;
      text-align: center;
      font-weight: bold;
      color: white;
      background: var(--primary-blue);
      border-right: 1px solid rgba(255,255,255,0.2);
      box-sizing: border-box;
    }

    #calendario-container th:last-child {
      border-right: none;
    }

    #calendario-container td {
      vertical-align: top;
      position: relative;
      width: calc(100% / 7);
      height: 140px;
      min-height: 140px;
      max-height: 140px;
      padding: 0.5rem;
      overflow: hidden;
      box-sizing: border-box;
      border: 1px solid #e5e7eb;
    }

    .eventos-container {
      max-height: calc(140px - 2.5rem);
      overflow-y: auto;
      overflow-x: hidden;
      width: 100%;
    }

    .eventos-container::-webkit-scrollbar {
      width: 4px;
    }

    .eventos-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .eventos-container::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 2px;
    }

    #calendario-container th {
      border-right: 1px solid rgba(255,255,255,0.2);
      width: 14.28%;
    }

    #calendario-container th:last-child {
      border-right: none;
    }

    @media (max-width: 768px) {
      #calendario-container table {
        width: 100%;
        table-layout: fixed;
      }
      
      #calendario-container th {
        width: calc(100% / 7);
        padding: 0.4rem 0.25rem;
        font-size: 0.7rem;
        box-sizing: border-box;
      }
      
      #calendario-container td {
        width: calc(100% / 7);
        height: 100px;
        min-height: 100px;
        max-height: 100px;
        padding: 0.25rem;
        font-size: 0.7rem;
        box-sizing: border-box;
      }

      .eventos-container {
        max-height: calc(100px - 2rem);
      }
      
      .evento-dia {
        font-size: 0.65rem;
        padding: 0.25rem 0.4rem;
        margin-bottom: 0.25rem;
      }
    }

    @media (max-width: 640px) {
      #calendario-container th {
        width: calc(100% / 7);
        padding: 0.3rem 0.2rem;
        font-size: 0.65rem;
        box-sizing: border-box;
      }

      #calendario-container td {
        width: calc(100% / 7);
        height: 80px;
        min-height: 80px;
        max-height: 80px;
        padding: 0.2rem;
        box-sizing: border-box;
      }

      .eventos-container {
        max-height: calc(80px - 1.5rem);
      }
      
      .evento-dia {
        font-size: 0.6rem;
        padding: 0.2rem 0.3rem;
        margin-bottom: 0.2rem;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app-root" class="flex min-h-screen">
    <!-- Bot√£o flutuante para abrir a sidebar quando estiver fechada -->
    <button type="button" id="btn-sidebar-open" onclick="abrirSidebar();" aria-label="Abrir menu" title="Abrir menu">
     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <!-- Sidebar lateral -->
    <aside id="sidebar" role="navigation" aria-label="Menu principal">
     <div class="sidebar-brand">
      <a href="#" onclick="trocarAba('consulta'); fecharSidebar(); return false;">
       <span class="logo-icon" aria-hidden="true">üó∫Ô∏è</span>
       <span>Jornada de Solu√ß√µes</span>
      </a>
      <button type="button" id="btn-sidebar-close" onclick="fecharSidebar();" aria-label="Fechar menu" title="Fechar menu">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
     </div>
     <nav class="sidebar-nav">
      <button type="button" id="nav-busca" class="sidebar-nav-item active" onclick="trocarAba('consulta'); fecharSidebar();" aria-current="page">
       <span class="nav-icon" aria-hidden="true">üîç</span>
       <span>Busca</span>
      </button>
      <button type="button" id="nav-jornadas" class="sidebar-nav-item" onclick="trocarAba('jornadas'); fecharSidebar();">
       <span class="nav-icon" aria-hidden="true">üó∫Ô∏è</span>
       <span>Jornadas</span>
      </button>
      <button type="button" id="nav-ferramentas" class="sidebar-nav-item" onclick="trocarAba('ferramentas'); fecharSidebar();">
       <span class="nav-icon" aria-hidden="true">üõ†Ô∏è</span>
       <span>Ferramentas</span>
      </button>
      <button type="button" id="nav-calendario" class="sidebar-nav-item" onclick="trocarAba('calendario'); fecharSidebar();">
       <span class="nav-icon" aria-hidden="true">üìÖ</span>
       <span>Calend√°rio</span>
      </button>
      <button type="button" id="nav-gestao" class="sidebar-nav-item" onclick="verificarGestor(); fecharSidebar();">
       <span id="nav-gestao-lock" class="nav-icon nav-icon--lock" aria-hidden="true">üîí</span>
       <span id="nav-gestao-ok" class="nav-icon hidden" aria-hidden="true">‚öôÔ∏è</span>
       <span>Gest√£o</span>
       <span class="text-xs ml-auto opacity-75" id="nav-gestao-hint">(login)</span>
      </button>
     </nav>
     <div class="sidebar-footer" id="nav-sair-wrap" style="display: none;">
      <button type="button" id="nav-sair" class="sidebar-nav-item sidebar-sair" onclick="desautenticarGestor(); fecharSidebar();">
       <span class="nav-icon" aria-hidden="true">üö™</span>
       <span>Sair</span>
      </button>
     </div>
    </aside>
    <div id="sidebar-backdrop" onclick="fecharSidebar();" aria-hidden="true"></div>

    <div id="main-wrap" class="flex-1 flex flex-col min-w-0">
     <header id="topbar-mobile" class="lg:hidden" role="banner">
      <button type="button" id="btn-menu-mobile" onclick="abrirSidebar();" aria-label="Abrir menu">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
      <a href="#" onclick="trocarAba('consulta'); return false;" class="topbar-logo">Solu√ß√µes de Diagn√≥stico</a>
      <span style="width: 40px;"></span>
     </header>
     <main id="app-wrapper" class="flex-1 overflow-auto">
      <div class="w-full max-w-7xl mx-auto px-4 py-6 md:py-10">
    <!-- Modal de Login para Gestor -->
    <div id="modal-login" class="modal-overlay hidden">
     <div class="modal-content">
      <div class="text-center mb-6">
       <h2 class="text-2xl font-bold mb-2" style="color: var(--primary-blue);">Acesso de Gestor</h2>
       <p class="text-sm" style="color: #666;">Digite suas credenciais para acessar o painel de gerenciamento</p>
      </div>
      <form id="form-login-gestor" class="space-y-4">
       <div>
        <label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Usu√°rio</label>
        <input type="text" id="login-usuario" required class="input-modern w-full px-4 py-3 rounded-xl" placeholder="Digite seu usu√°rio">
       </div>
       <div>
        <label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Senha</label>
        <input type="password" id="login-senha" required class="input-modern w-full px-4 py-3 rounded-xl" placeholder="Digite sua senha">
       </div>
       <div id="login-erro" class="hidden text-sm text-red-600 bg-red-50 p-3 rounded-lg"></div>
       <div class="flex gap-3">
        <button type="submit" class="btn-modern flex-1 px-6 py-3 text-white font-bold rounded-xl" style="background: var(--primary-blue);">
         Entrar
        </button>
        <button type="button" onclick="fecharLoginGestor()" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 font-semibold rounded-xl transition-all" style="color: #666;">
         Cancelar
        </button>
       </div>
      </form>
     </div>
    </div>
    <!-- Modal Detalhes da Solu√ß√£o / Trilha -->
    <div id="modal-detalhe-solucao" class="modal-overlay hidden" onclick="if(event.target===this)fecharDetalheSolucao()">
     <div class="modal-content">
      <div class="flex items-start justify-between mb-4 flex-shrink-0">
       <h2 id="detalhe-titulo" class="text-lg md:text-xl font-bold pr-2" style="color: var(--primary-blue); word-wrap: break-word;"></h2>
       <button type="button" onclick="fecharDetalheSolucao()" class="text-2xl leading-none opacity-70 hover:opacity-100 flex-shrink-0" style="color: #666;">&times;</button>
      </div>
      <div class="flex-1 overflow-y-auto min-h-0">
       <p id="detalhe-descricao" class="text-sm mb-4" style="color: #666; word-wrap: break-word;"></p>
       <div class="mb-4 p-3 rounded-xl border-2" style="background: #FFFBEB; border-color: #F59E0B;">
        <p class="text-xs font-semibold mb-1" style="color: #B45309;">Pr√≥xima data</p>
        <p id="detalhe-proxima-data" class="text-base md:text-lg font-bold" style="color: #B45309; word-wrap: break-word;"></p>
       </div>
       <div id="detalhe-carga-horaria-area" class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-3" style="display: none;"></div>
       <div class="flex flex-wrap gap-2 mb-4" id="detalhe-badges"></div>
      </div>
      <div class="flex gap-3 flex-shrink-0 mt-4" id="detalhe-botoes">
       <button type="button" onclick="fecharDetalheSolucao()" class="w-full py-3 bg-gray-100 hover:bg-gray-200 font-semibold rounded-xl" style="color: #333;">Fechar</button>
      </div>
     </div>
    </div>
    <!-- Aba Consulta -->
    <div id="aba-consulta" class="tab-content active">
     <!-- Header -->
     <header class="text-center mb-8 md:mb-12">
     <div class="sebrae-gradient text-white py-8 md:py-12 px-4 md:px-8 rounded-3xl shadow-2xl relative overflow-hidden">
      <div class="relative z-10">
       <h1 id="titulo-principal" class="text-3xl md:text-5xl font-bold mb-3 drop-shadow-lg"> Guia de Solu√ß√µes</h1>
       <p id="subtitulo" class="text-lg md:text-xl opacity-95 drop-shadow-md">Encontre a solu√ß√£o ideal para o diagn√≥stico</p>
      </div>
     </div>
    </header><!-- Progress Indicator -->
    <div class="glass-card rounded-2xl p-4 md:p-6 mb-6 md:mb-8">
     <div class="flex items-center justify-between max-w-3xl mx-auto">
      <div class="step-indicator flex-1">
       <div class="step-circle active" id="step-1">
        1
       </div>
       <div class="step-line" id="line-1"></div>
      </div>
      <div class="step-indicator flex-1">
       <div class="step-circle" id="step-2">
        2
       </div>
       <div class="step-line" id="line-2"></div>
      </div>
      <div class="step-circle" id="step-3">
       3
      </div>
     </div>
     <div class="flex justify-between mt-3 text-xs md:text-sm font-semibold text-center" style="color: #00608B;"><span class="flex-1">Momento</span> <span class="flex-1">Porte</span> <span class="flex-1">Setor</span>
     </div>
    </div>    <!-- Step 1: Momento da Empresa -->
    <section id="step-momento" class="fade-in">
     <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 md:mb-8" style="color: var(--primary-blue);">Qual o momento da empresa?</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><button onclick="selecionarMomento('empresarial')" class="card-option rounded-2xl p-6 text-left">
       <div class="flex items-center gap-3 mb-3"><span class="text-3xl">üè¢</span>
        <h3 class="text-xl font-bold" style="color: var(--primary-blue);">Momento Empresarial</h3>
       </div><p class="text-sm leading-relaxed" style="color: #666;">Para empresas focadas em estrutura√ß√£o e gest√£o</p></button> <button onclick="selecionarMomento('crescimento')" class="card-option rounded-2xl p-6 text-left">
       <div class="flex items-center gap-3 mb-3"><span class="text-3xl">üìà</span>
        <h3 class="text-xl font-bold" style="color: var(--primary-blue);">Crescimento Empresarial</h3>
       </div><p class="text-sm leading-relaxed" style="color: #666;">Para empresas em fase de expans√£o e escalabilidade</p></button>
     </div>
    </section><!-- Step 1.1: Cards Momento Empresarial -->
    <section id="cards-empresarial" class="hidden fade-in"><button onclick="voltarEtapa('momento')" class="mb-4 text-sm font-semibold flex items-center gap-2" style="color: #00608B;"> ‚Üê Voltar </button>
     <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 md:mb-8" style="color: #00608B;">Selecione o foco principal</h2>
     <div class="flex justify-center gap-4 mb-6 flex-wrap"><button onclick="selecionarTodos('empresarial')" class="btn-modern px-6 py-3 glass-card border-2 rounded-xl font-semibold" style="border-color: var(--primary-blue); color: var(--primary-blue);"> ‚úì Todos </button> <button onclick="selecionarNenhum('empresarial')" class="btn-modern px-6 py-3 glass-card border-2 rounded-xl font-semibold" style="border-color: #DC2626; color: #DC2626;"> ‚úó Nenhum </button>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="grid-empresarial"></div>
     <div class="text-center"><button onclick="avancarParaPorte()" id="btn-avancar-momento" disabled class="btn-primary btn-modern px-8 py-4 text-white font-bold rounded-xl text-lg" style="background: var(--primary-blue);"> Avan√ßar para Porte ‚Üí </button>
     </div>
    </section><!-- Step 1.2: Cards Crescimento Empresarial -->
    <section id="cards-crescimento" class="hidden fade-in"><button onclick="voltarEtapa('momento')" class="mb-4 text-sm font-semibold flex items-center gap-2" style="color: #00608B;"> ‚Üê Voltar </button>
     <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 md:mb-8" style="color: #00608B;">Selecione a √°rea de crescimento</h2>
     <div class="flex justify-center gap-4 mb-6 flex-wrap"><button onclick="selecionarTodos('crescimento')" class="btn-modern px-6 py-3 glass-card border-2 rounded-xl font-semibold" style="border-color: var(--primary-blue); color: var(--primary-blue);"> ‚úì Todos </button> <button onclick="selecionarNenhum('crescimento')" class="btn-modern px-6 py-3 glass-card border-2 rounded-xl font-semibold" style="border-color: #DC2626; color: #DC2626;"> ‚úó Nenhum </button>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="grid-crescimento"></div>
     <div class="text-center"><button onclick="avancarParaPorte()" id="btn-avancar-crescimento" disabled class="btn-primary btn-modern px-8 py-4 text-white font-bold rounded-xl text-lg" style="background: var(--primary-blue);"> Avan√ßar para Porte ‚Üí </button>
     </div>
    </section><!-- Step 2: Porte -->
    <section id="step-porte" class="hidden fade-in"><button onclick="voltarEtapa('cards')" class="mb-4 text-sm font-semibold flex items-center gap-2" style="color: #00608B;"> ‚Üê Voltar </button>
     <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 md:mb-8" style="color: #00608B;">Qual o porte da empresa?</h2>
     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><button onclick="selecionarPorte('MEI')" class="card-option bg-white rounded-xl shadow-lg p-6"> <span class="text-4xl mb-3 block">üë§</span> <h3 class="text-xl font-bold mb-2" style="color: #00608B;">MEI</h3><p class="text-sm" style="color: #666;">Microempreendedor Individual</p></button> <button onclick="selecionarPorte('ME')" class="card-option bg-white rounded-xl shadow-lg p-6"> <span class="text-4xl mb-3 block">üë•</span> <h3 class="text-xl font-bold mb-2" style="color: #00608B;">ME</h3><p class="text-sm" style="color: #666;">Microempresa</p></button> <button onclick="selecionarPorte('EPP')" class="card-option bg-white rounded-xl shadow-lg p-6"> <span class="text-4xl mb-3 block">üè¢</span> <h3 class="text-xl font-bold mb-2" style="color: #00608B;">EPP</h3><p class="text-sm" style="color: #666;">Empresa de Pequeno Porte</p></button>
     </div>
    </section><!-- Step 3: Setor -->
    <section id="step-setor" class="hidden fade-in"><button onclick="voltarEtapa('porte')" class="mb-4 text-sm font-semibold flex items-center gap-2" style="color: #00608B;"> ‚Üê Voltar </button>
     <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 md:mb-8" style="color: #00608B;">Qual o setor de atua√ß√£o?</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"><button onclick="selecionarSetor('Comercio')" class="card-option bg-white rounded-xl shadow-lg p-6"> <span class="text-4xl mb-3 block">üõí</span> <h3 class="text-xl font-bold mb-2" style="color: #00608B;">Com√©rcio</h3><p class="text-sm" style="color: #666;">Compra e venda de produtos</p></button> <button onclick="selecionarSetor('Industria')" class="card-option bg-white rounded-xl shadow-lg p-6"> <span class="text-4xl mb-3 block">üè≠</span> <h3 class="text-xl font-bold mb-2" style="color: #00608B;">Ind√∫stria</h3><p class="text-sm" style="color: #666;">Produ√ß√£o e transforma√ß√£o</p></button> <button onclick="selecionarSetor('Servicos')" class="card-option bg-white rounded-xl shadow-lg p-6"> <span class="text-4xl mb-3 block">üíº</span> <h3 class="text-xl font-bold mb-2" style="color: #00608B;">Servi√ßos</h3><p class="text-sm" style="color: #666;">Presta√ß√£o de servi√ßos</p></button> <button onclick="selecionarSetor('Multissetorial')" class="card-option bg-white rounded-xl shadow-lg p-6"> <span class="text-4xl mb-3 block">üåê</span> <h3 class="text-xl font-bold mb-2" style="color: #00608B;">Multissetorial</h3><p class="text-sm" style="color: #666;">M√∫ltiplos setores</p></button>
     </div>
    </section>    <!-- Resultados -->
    <section id="step-resultados" class="hidden fade-in">
     <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
      <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
       <h3 class="text-xl font-bold" style="color: #00608B;">Sua sele√ß√£o:</h3>
       <div class="flex items-center gap-3 flex-wrap">
        <button onclick="selecionarTodasSolucoes()" class="px-4 py-2 rounded-lg font-semibold transition-all hover:scale-105 text-sm" style="background: #E8F7F0; color: #00A859; border: 2px solid #00A859;">
         ‚úì Selecionar Todas
        </button>
        <button onclick="desselecionarTodasSolucoes()" class="px-4 py-2 rounded-lg font-semibold transition-all hover:scale-105 text-sm" style="background: #FFF4E6; color: #FF8C00; border: 2px solid #FF8C00;">
         ‚úó Desselecionar Todas
        </button>
       </div>
      </div>
      <div class="flex flex-wrap gap-2" id="resumo-selecao"></div>
     </div>
     <div class="mb-8 hidden" id="header-trilha-container">
      <h3 class="text-2xl md:text-3xl font-bold text-center mb-4" style="color: #00608B;">Sua Trilha de Solu√ß√µes</h3>
      <p class="text-center mb-6 text-gray-600">As solu√ß√µes est√£o organizadas em assessorias sequenciais. Complete cada etapa para avan√ßar na sua jornada.</p>
      <div class="bg-gradient-to-r rounded-2xl p-6 md:p-8 mb-6 shadow-xl" id="header-trilha" style="background: linear-gradient(135deg, #00608B 0%, #0092BA 100%);">
       <h2 class="text-3xl md:text-4xl font-bold text-white mb-2" id="header-trilha-titulo">Gerencie</h2>
       <p class="text-purple-100 text-lg" id="header-trilha-desc">Processo simplificado de estrutura√ß√£o e gest√£o empresarial</p>
      </div>
     </div>
     <div id="resultados-container" class="mb-8"></div>
     <div id="mensagem-sem-resultados" class="hidden text-center py-12">
      <svg class="w-20 h-20 mx-auto mb-4 opacity-50" fill="none" stroke="#00608B" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p class="text-xl font-semibold mb-3" style="color: #666;">Nenhuma Solu√ß√£o encontrada</p>
      <p style="color: #999;">N√£o h√° solu√ß√£o cadastradas para esta combina√ß√£o</p>
     </div>
     <!-- Box de Sugest√£o de Ferramenta -->
     <div id="box-sugestao-ferramenta" class="hidden mt-12 mb-8">
      <div class="bg-gradient-to-br rounded-2xl shadow-xl p-6 md:p-8 border-4" style="background: linear-gradient(135deg, #E3ECEE 0%, #A0C5CF 100%); border-color: #00608B;">
       <div class="flex items-start gap-4 mb-4">
        <div class="flex-shrink-0 w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg" style="background: linear-gradient(135deg, #00608B 0%, #0092BA 100%);">
         üí°
        </div>
        <div class="flex-1">
         <h3 id="sugestao-ferramenta-titulo" class="text-2xl font-bold mb-2" style="color: #00608B;">Ferramenta Recomendada</h3>
         <p id="sugestao-ferramenta-subtitulo" class="text-sm" style="color: #666;">Uma sugest√£o especial para o seu perfil</p>
        </div>
       </div>
       <div id="sugestao-conteudo" class="space-y-4">
        <!-- Conte√∫do ser√° preenchido dinamicamente -->
       </div>
      </div>
     </div>
     <!-- Bot√£o Nova Consulta -->
     <div class="text-center mt-12 mb-8">
      <button onclick="reiniciar()" class="btn-modern px-8 py-4 text-white font-bold rounded-xl text-lg shadow-lg hover:shadow-xl transition-all" style="background: linear-gradient(135deg, #00608B 0%, #0092BA 100%);">
       ‚Üê Nova Consulta
      </button>
     </div>
    </section>
    </div>
    <!-- Aba Jornadas -->
    <div id="aba-jornadas" class="tab-content">
     <div class="glass-card rounded-2xl p-6 md:p-8 border-t-4 mb-6" style="border-color: var(--primary-blue);">
      <div class="text-center mb-8">
       <h2 class="text-3xl md:text-4xl font-bold mb-4" style="color: var(--primary-blue);">Todas as Jornadas</h2>
       <p class="text-lg" style="color: #666;">Explore todas as solu√ß√µes dispon√≠veis, organizadas por assessorias sequenciais</p>
      </div>
      <div id="jornadas-container" class="mb-8">
       <div class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2" style="border-color: var(--primary-blue);"></div>
        <p class="mt-4" style="color: #666;">Carregando jornadas...</p>
       </div>
      </div>
     </div>
    </div>
    <!-- Aba Ferramentas -->
    <div id="aba-ferramentas" class="tab-content">
     <div class="glass-card rounded-2xl p-6 md:p-8 border-t-4 mb-6" style="border-color: var(--primary-blue);">
      <div class="text-center mb-8">
       <h2 class="text-3xl md:text-4xl font-bold mb-4" style="color: var(--primary-blue);">Ferramentas</h2>
       <p class="text-lg" style="color: #666;">Filtre e explore ferramentas por momento e √°rea de foco (dor)</p>
      </div>
      <!-- Filtros -->
      <div class="mb-8 p-6 rounded-2xl border-2" style="background: #E3ECEE; border-color: #A0C5CF;">
       <h3 class="text-lg font-bold mb-4" style="color: #00608B;">Filtros</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
         <label class="block text-sm font-semibold mb-2" style="color: #00608B;">Tipo de Momento</label>
         <select id="ferramentas-tipo-momento" class="input-modern w-full px-4 py-3 rounded-xl" onchange="atualizarFiltroDorFerramentas(); renderListaFerramentas();">
          <option value="">Todos</option>
          <option value="empresarial">Momento Empresarial</option>
          <option value="crescimento">Crescimento Empresarial</option>
         </select>
        </div>
        <div>
         <label class="block text-sm font-semibold mb-2" style="color: #00608B;">√Årea de Crescimento (Dor)</label>
         <select id="ferramentas-dor" class="input-modern w-full px-4 py-3 rounded-xl" onchange="renderListaFerramentas();">
          <option value="">Todas</option>
         </select>
        </div>
       </div>
      </div>
      <!-- Lista de ferramentas -->
      <div id="ferramentas-vazia" class="hidden text-center py-12">
       <p class="text-lg font-semibold mb-2" style="color: #666;">Nenhuma ferramenta encontrada</p>
       <p class="text-sm" style="color: #999;">Ajuste os filtros ou cadastre sugest√µes na aba Gest√£o</p>
      </div>
      <div id="lista-ferramentas" class="space-y-4">
       <!-- Cards preenchidos por renderListaFerramentas() -->
      </div>
     </div>
    </div>
    <!-- Aba Calend√°rio -->
    <div id="aba-calendario" class="tab-content">
     <div class="glass-card rounded-2xl p-6 md:p-8 border-t-4 mb-6" style="border-color: var(--primary-blue);">
      <!-- Header -->
      <div class="text-center mb-6">
       <h2 class="text-3xl md:text-4xl font-bold mb-2" style="color: var(--primary-blue);">üìÖ Calend√°rio de Solu√ß√µes</h2>
       <p class="text-lg" style="color: #666;">Solu√ß√µes com data de validade</p>
      </div>
      
      <!-- Controles do Calend√°rio -->
      <div class="mb-6 p-4 bg-white rounded-xl border-2" style="border-color: #A0C5CF;">
       <div class="flex flex-wrap items-center justify-center gap-4">
        <button onclick="calendarioMesAnterior()" class="btn-modern px-4 py-2 text-white font-semibold rounded-lg" style="background: var(--primary-blue);">
         ‚óÄ 
        </button>
        <div class="text-xl font-bold" style="color: var(--primary-blue);" id="calendario-mes-atual"></div>
        <button onclick="calendarioProximoMes()" class="btn-modern px-4 py-2 text-white font-semibold rounded-lg" style="background: var(--primary-blue);">
         ‚ñ∂
        </button>
       </div>
      </div>

      <!-- Layout Principal: Sidebar + Calend√°rio -->
      <div class="flex flex-col lg:flex-row gap-6">
       <!-- Sidebar com Legenda -->
       <div class="lg:w-64 flex-shrink-0 order-2 lg:order-1">
        <div class="bg-white rounded-xl border-2 p-4 lg:sticky lg:top-4" style="border-color: #A0C5CF;">
         <h3 class="font-bold mb-4 text-sm uppercase" style="color: var(--primary-blue);">Status</h3>
         <div class="space-y-3 mb-6">
          <div class="flex items-center gap-2">
           <div class="w-4 h-4 rounded flex-shrink-0" style="background: var(--accent-green);"></div>
           <span class="text-xs font-semibold" style="color: #666;">V√°lida</span>
          </div>
          <div class="flex items-center gap-2">
           <div class="w-4 h-4 rounded flex-shrink-0" style="background: #f39c12;"></div>
           <span class="text-xs font-semibold" style="color: #666;">Expira em breve</span>
          </div>
          <div class="flex items-center gap-2">
           <div class="w-4 h-4 rounded flex-shrink-0" style="background: #e74c3c;"></div>
           <span class="text-xs font-semibold" style="color: #666;">Expirada</span>
          </div>
         </div>
         <div class="border-t pt-4" style="border-color: #A0C5CF;">
          <h3 class="font-bold mb-3 text-sm uppercase" style="color: var(--primary-blue);">Estat√≠sticas</h3>
          <div id="calendario-stats-sidebar" class="space-y-2">
           <!-- Preenchido dinamicamente -->
          </div>
         </div>
        </div>
       </div>

       <!-- Calend√°rio Principal -->
       <div class="flex-1 order-1 lg:order-2 min-w-0">
        <div id="calendario-container" class="mb-6 w-full">
         <div class="text-center py-12">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2" style="border-color: var(--primary-blue);"></div>
          <p class="mt-4" style="color: #666;">Carregando calend√°rio...</p>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
    <!-- Aba Gerenciamento -->
    <div id="aba-gerenciamento" class="tab-content">
     <div class="glass-card rounded-2xl p-6 md:p-8 border-t-4" style="border-color: var(--primary-blue);">
      <div class="flex items-center justify-between mb-6">
       <div>
        <h3 class="text-2xl font-bold mb-2" style="color: var(--primary-blue);">Gerenciar Solu√ß√µes</h3>
        <p class="text-sm" style="color: #666;">Cadastre e gerencie as solu√ß√µes que aparecer√£o nos resultados filtrados</p>
       </div>
       <div class="flex items-center gap-4">
        <div class="text-right">
         <p class="text-sm font-semibold" style="color: #666;">Total cadastrado:</p>
         <p class="text-3xl font-bold" style="color: var(--accent-green);" id="total-assessorias">0</p>
        </div>
        <button onclick="desautenticarGestor()" class="px-4 py-2 text-sm font-semibold rounded-lg transition-all hover:bg-red-50" style="color: #DC2626;">
         üö™ Sair
        </button>
       </div>
      </div>
      <!-- Importa√ß√£o de Planilha -->
      <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-xl border-2 border-dashed" style="border-color: var(--primary-blue);">
       <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
         <h4 class="font-bold mb-1" style="color: var(--primary-blue);">üìä Importar Planilha</h4>
         <p class="text-sm" style="color: #666;">Importe uma planilha CSV ou Excel para cadastrar m√∫ltiplas solu√ß√µes de uma vez</p>
        </div>
        <div class="flex flex-wrap gap-2">
         <input type="file" id="file-import" accept=".csv,.xlsx,.xls" class="hidden" onchange="processarImportacao(event)">
         <label for="file-import" class="btn-modern px-6 py-3 text-white font-semibold rounded-xl cursor-pointer" style="background: var(--primary-blue);">
          üìÅ Importar (CSV/Excel)
         </label>
         <button onclick="exportarParaExcel()" class="btn-modern px-6 py-3 glass-card border-2 rounded-xl font-semibold" style="border-color: #059669; color: #059669;">
          üì§ Exportar Excel
         </button>
         <button onclick="baixarModeloPlanilha()" class="btn-modern px-6 py-3 glass-card border-2 rounded-xl font-semibold" style="border-color: var(--accent-green); color: var(--accent-green);">
          üì• Baixar Modelo
         </button>
        </div>
       </div>
       <div id="import-status" class="hidden mt-4 p-3 rounded-lg"></div>
      </div>
      <form id="cadastro-form" class="space-y-4">
       <!-- Crit√©rios de oferta: momento empresarial + foco da dor -->
       <div class="p-4 rounded-xl border-2" style="background: #EFF6FF; border-color: var(--primary-blue);">
         <p class="text-sm font-semibold mb-1" style="color: var(--primary-blue);">üìå Crit√©rios de oferta</p>
         <p class="text-xs" style="color: #1e40af;">As solu√ß√µes s√£o ofertadas de acordo com o <strong>momento empresarial</strong> e o <strong>foco principal da dor</strong> selecionados. Preencha os campos abaixo para que esta solu√ß√£o apare√ßa nas recomenda√ß√µes corretas da consulta.</p>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Momento empresarial -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Momento empresarial *</label> <select id="cad-tipo-momento" required class="input-modern w-full px-4 py-3 rounded-xl"> <option value="">Selecione...</option> <option value="empresarial">Momento Empresarial (estrutura√ß√£o e gest√£o)</option> <option value="crescimento">Crescimento Empresarial (expans√£o e escalabilidade)</option> </select>
        </div>
        <!-- Foco principal da dor -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Foco principal da dor *</label> <select id="cad-categoria" required class="input-modern w-full px-4 py-3 rounded-xl"> <option value="">Selecione o momento empresarial primeiro</option> </select><p class="text-xs mt-1" style="color: #666;">√Årea/foco que define quando esta solu√ß√£o ser√° recomendada.</p>
        </div>
        <!-- C√≥digo -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">C√≥digo</label> <input type="text" id="cad-codigo" placeholder="Ex: 6174" class="input-modern w-full px-4 py-3 rounded-xl">
        </div>
        <!-- T√≠tulo/Nome da Solu√ß√£o -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">T√≠tulo/Nome da Solu√ß√£o *</label> <input type="text" id="cad-nome" required placeholder="Ex: Consultoria em Gest√£o Estrat√©gica" class="input-modern w-full px-4 py-3 rounded-xl">
        </div>
        <!-- Porte -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Porte/P√∫blico Alvo *</label> <select id="cad-porte" required class="input-modern w-full px-4 py-3 rounded-xl"> <option value="">Selecione...</option> <option value="MEI">MEI - Microempreendedor Individual</option> <option value="ME">ME - Microempresa</option> <option value="EPP">EPP - Empresa de Pequeno Porte</option> </select>
        </div>        <!-- Setor -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Setor *</label> <select id="cad-setor" required class="input-modern w-full px-4 py-3 rounded-xl"> <option value="">Selecione...</option> <option value="Comercio">Com√©rcio</option> <option value="Industria">Ind√∫stria</option> <option value="Servicos">Servi√ßos</option> <option value="Multissetorial">Multissetorial</option> </select>
        </div>
        <!-- Segmento -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Segmento</label> <input type="text" id="cad-segmento" placeholder="Ex: Vestu√°rio, J√≥ias" class="input-modern w-full px-4 py-3 rounded-xl">
        </div>
        <!-- √Årea de Conhecimento -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">√Årea de Conhecimento</label> <input type="text" id="cad-area-conhecimento" placeholder="Ex: Gest√£o da Produ√ß√£o" class="input-modern w-full px-4 py-3 rounded-xl">
        </div>
        <!-- Carga Hor√°ria -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Carga Hor√°ria</label> <input type="number" id="cad-carga-horaria" placeholder="Ex: 14" class="input-modern w-full px-4 py-3 rounded-xl">
        </div>
        <!-- Instrumento -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Instrumento</label> <input type="text" id="cad-instrumento" placeholder="Ex: Cursos Presenciais" class="input-modern w-full px-4 py-3 rounded-xl">
        </div>
        <!-- Fornecedor Executor -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Fornecedor Executor</label> <input type="text" id="cad-fornecedor" placeholder="Ex: SENAI" class="input-modern w-full px-4 py-3 rounded-xl">
        </div>
        <!-- Pr√≥xima data -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Pr√≥xima data</label> <input type="text" id="cad-proxima-data" placeholder="Ex: 15/03/2026 ou A definir" class="input-modern w-full px-4 py-3 rounded-xl"><p class="text-xs mt-1" style="color: #666;">Data da pr√≥xima turma/edi√ß√£o para exibir na trilha.</p>
        </div>
        <!-- Data de Validade -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Data de Validade (Opcional)</label> <input type="date" id="cad-data-validade" class="input-modern w-full px-4 py-3 rounded-xl"><p class="text-xs mt-1" style="color: #666;">Data de validade da solu√ß√£o. Deixe em branco se n√£o possui validade.</p>
        </div>
        <!-- Valor (0 = gratuito) -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Valor (R$) *</label> <input type="number" id="cad-valor" min="0" step="0.01" value="0" placeholder="0 = gratuito" class="input-modern w-full px-4 py-3 rounded-xl"><p class="text-xs mt-1" style="color: #666;">Zero = gratuito. Informe o valor quando for pago.</p>
        </div>
        <!-- Ordem -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Ordem de Exibi√ß√£o *</label> <select id="cad-ordem" required class="input-modern w-full px-4 py-3 rounded-xl"> <option value="">Selecione...</option> <option value="1">1 - Primeira Assessoria</option> <option value="2">2 - Segunda Assessoria</option> </select>
        </div>
        <!-- Link de Direcionamento -->
        <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Link de Direcionamento</label> <input type="url" id="cad-link-direcionamento" placeholder="Ex: https://www.sebrae.com.br/solucao" class="input-modern w-full px-4 py-3 rounded-xl"><p class="text-xs mt-1" style="color: #666;">URL para direcionar o usu√°rio √† solu√ß√£o.</p>
        </div>
       </div>
       <!-- Descri√ß√£o -->
       <div><label class="block text-sm font-semibold mb-2" style="color: var(--primary-blue);">Descri√ß√£o da Solu√ß√£o *</label> <textarea id="cad-descricao" required rows="4" placeholder="Descreva os benef√≠cios e diferenciais desta solu√ß√£o..." class="input-modern w-full px-4 py-3 rounded-xl"></textarea>
       </div>
       <button type="submit" id="btn-cadastrar" class="btn-primary btn-modern w-full px-6 py-4 text-white font-bold rounded-xl text-lg" style="background: var(--accent-green);"> ‚úì Cadastrar Solu√ß√£o </button>
      </form>      <!-- Lista de Solu√ß√µes Cadastradas -->
      <div class="mt-8 pt-8 border-t-2" style="border-color: #E0E0E0;">
       <h4 class="text-xl font-bold mb-4" style="color: #00608B;">üìã Solu√ß√µes Cadastradas</h4>
       
       <!-- Filtro por Data -->
       <div class="mb-4 p-4 rounded-xl border-2" style="background: #E3ECEE; border-color: #A0C5CF;">
        <h5 class="text-sm font-bold mb-3" style="color: #00608B;">üîç Filtro por Data</h5>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
         <div>
          <label class="block text-xs font-semibold mb-2" style="color: #00608B;">Data Inicial</label>
          <input type="date" id="filtro-data-inicial" class="input-modern w-full px-3 py-2 rounded-lg text-sm" onchange="aplicarFiltroData()">
         </div>
         <div>
          <label class="block text-xs font-semibold mb-2" style="color: #00608B;">Data Final</label>
          <input type="date" id="filtro-data-final" class="input-modern w-full px-3 py-2 rounded-lg text-sm" onchange="aplicarFiltroData()">
         </div>
         <div class="flex items-end">
          <button onclick="limparFiltroData()" class="btn-modern px-4 py-2 glass-card border-2 rounded-lg font-semibold text-sm w-full" style="border-color: #6c757d; color: #6c757d;">
           üîÑ Limpar Filtro
          </button>
         </div>
        </div>
        <p class="text-xs mt-2" style="color: #666;">Filtre solu√ß√µes pela <strong>pr√≥xima data</strong>. Deixe em branco para mostrar todas.</p>
       </div>

       <div id="barra-exclusao-massa" class="hidden flex flex-wrap items-center gap-4 mb-4 p-3 rounded-xl border-2" style="border-color: #FEE2E2; background: #FEF2F2;">
         <label class="flex items-center gap-2 cursor-pointer font-semibold" style="color: #991B1B;"><input type="checkbox" id="cb-selecionar-todas" onchange="marcarDesmarcarTodas(this.checked)"> Selecionar todas</label>
         <button type="button" onclick="marcarDesmarcarTodas(false)" class="px-4 py-2 rounded-lg font-semibold transition-all hover:bg-gray-200" style="background: #E5E7EB; color: #374151;">Desmarcar</button>
         <button type="button" id="btn-excluir-selecionadas" onclick="excluirSelecionadas()" disabled class="px-4 py-2 rounded-lg font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed" style="background: #DC2626; color: white;">Excluir selecionadas</button>
       </div>
       <div id="lista-assessorias" class="space-y-3 max-h-96 overflow-y-auto"></div>
       <div id="lista-vazia" class="text-center py-8 hidden">
        <p style="color: #999;">Nenhuma solu√ß√£o cadastrada ainda</p>
       </div>
      </div>
      <!-- Gest√£o de Sugest√µes de Ferramentas -->
      <div class="mt-12 pt-8 border-t-4" style="border-color: #00608B;">
       <h4 class="text-xl font-bold mb-4" style="color: #00608B;">üí° Gerenciar Sugest√µes de Ferramentas</h4>
       <p class="text-sm mb-6" style="color: #666;">Configure ferramentas que aparecer√£o como sugest√µes ao final da consulta, baseadas no perfil do usu√°rio</p>
       <!-- Importar/Exportar Ferramentas -->
       <div class="mb-6 p-4 rounded-xl border-2" style="background: #F0F9FF; border-color: #B3E5FC;">
        <div>
         <h4 class="font-bold mb-1" style="color: var(--primary-blue);">üìä Importar/Exportar Ferramentas</h4>
         <p class="text-sm" style="color: #666;">Importe uma planilha CSV ou Excel para cadastrar m√∫ltiplas ferramentas de uma vez</p>
        </div>
        <div class="flex flex-wrap gap-2 mt-3">
         <input type="file" id="file-import-ferramentas" accept=".csv,.xlsx,.xls" class="hidden" onchange="processarImportacaoFerramentas(event)">
         <label for="file-import-ferramentas" class="btn-modern px-6 py-3 text-white font-semibold rounded-xl cursor-pointer" style="background: var(--primary-blue);">
          üìÅ Importar Ferramentas (CSV/Excel)
         </label>
         <button onclick="exportarFerramentasParaExcel()" class="btn-modern px-6 py-3 glass-card border-2 rounded-xl font-semibold" style="border-color: #059669; color: #059669;">
          üì§ Exportar Ferramentas Excel
         </button>
         <button onclick="baixarModeloPlanilhaFerramentas()" class="btn-modern px-6 py-3 glass-card border-2 rounded-xl font-semibold" style="border-color: var(--accent-green); color: var(--accent-green);">
          üì• Baixar Modelo Ferramentas
         </button>
        </div>
       </div>
       <div id="import-status-ferramentas" class="hidden mt-4 p-3 rounded-lg"></div>
       <form id="form-sugestao" class="space-y-4 mb-6 p-4 rounded-xl border-2" style="background: #E3ECEE; border-color: #A0C5CF;">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">T√≠tulo da Ferramenta *</label> <input type="text" id="sug-titulo" required placeholder="Ex: Calculadora de Precifica√ß√£o" class="input-modern w-full px-4 py-3 rounded-xl"></div>
         <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">Link</label> <input type="url" id="sug-link" placeholder="https://..." class="input-modern w-full px-4 py-3 rounded-xl"></div>
        </div>
        <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">Descri√ß√£o</label> <textarea id="sug-descricao" rows="3" placeholder="Descreva a ferramenta e seus benef√≠cios..." class="input-modern w-full px-4 py-3 rounded-xl"></textarea></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">Tipo de Momento</label> <select id="sug-tipo-momento" class="input-modern w-full px-4 py-3 rounded-xl"> <option value="">Todos</option> <option value="empresarial">Momento Empresarial</option> <option value="crescimento">Crescimento Empresarial</option> </select></div>
         <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">√Årea de Crescimento (Dor)</label> <select id="sug-crescimento" class="input-modern w-full px-4 py-3 rounded-xl"> <option value="">Selecione o tipo de momento primeiro</option> </select></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">Porte</label> <select id="sug-porte" class="input-modern w-full px-4 py-3 rounded-xl"> <option value="">Todos</option> <option value="MEI">MEI</option> <option value="ME">ME</option> <option value="EPP">EPP</option> </select></div>
         <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">Setor</label> <select id="sug-setor" class="input-modern w-full px-4 py-3 rounded-xl"> <option value="">Todos</option> <option value="Comercio">Com√©rcio</option> <option value="Industria">Ind√∫stria</option> <option value="Servicos">Servi√ßos</option> <option value="Multissetorial">Multissetorial</option> </select></div>
        </div>
        <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">Ordem de Exibi√ß√£o</label> <input type="number" id="sug-ordem" min="1" value="1" class="input-modern w-full px-4 py-3 rounded-xl"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">Restritivos</label> <textarea id="sug-restritivos" rows="2" placeholder="Ex.: Apenas para MEI, Apenas para Com√©rcio" class="input-modern w-full px-4 py-3 rounded-xl"></textarea><p class="text-xs mt-1" style="color: #666;">Restri√ß√µes de uso da ferramenta</p></div>
         <div><label class="block text-sm font-semibold mb-2" style="color: #00608B;">Desconto</label> <input type="text" id="sug-desconto" placeholder="Ex.: 10%, Cupom SEBRAE10" class="input-modern w-full px-4 py-3 rounded-xl"><p class="text-xs mt-1" style="color: #666;">Informa√ß√£o de desconto ou cupom</p></div>
        </div>
        <div class="flex items-center gap-2"><input type="checkbox" id="sug-ativo" checked class="h-4 w-4"> <label for="sug-ativo" class="text-sm font-semibold" style="color: #00608B;">Ativo</label></div>
        <button type="button" id="btn-salvar-sugestao" onclick="salvarSugestao()" class="btn-modern w-full px-6 py-3 text-white font-bold rounded-xl" style="background: linear-gradient(135deg, #00608B 0%, #0092BA 100%);">üíæ Salvar Sugest√£o</button>
       </form>
       <div id="lista-sugestoes" class="space-y-3 max-h-96 overflow-y-auto"></div>
      </div>
     </div>
    </div>
   </div>
  </main>
  </div><!-- /main-wrap -->
  </div><!-- /app-root -->
  <script>
    const defaultConfig = {
      titulo_principal: "Guia de Solu√ß√µes",
      subtitulo: "Encontre a solu√ß√£o ideal para  empresa em 3 passos",
      cor_principal: "#00608B",
      cor_secundaria: "#00A859",
      cor_fundo: "#f0f7ff",
      cor_texto: "#333333",
      fonte_familia: "Montserrat",
      tamanho_fonte: 16
    };

    const momentoEmpresarial = [
      { id: 'Gerencie', titulo: '01 ‚Äì Gerencie', emoji: 'üìä', descricao: 'Um excelente resultado √© adotar ferramentas de gest√£o mais eficientes, garantindo organiza√ß√£o, visibilidade, cumprimento de prazos e maior produtividade para acompanhar o crescimento do neg√≥cio.' },
      { id: 'Planeje', titulo: '02 ‚Äì Planeje', emoji: 'üìã', descricao: 'Ter processos otimizados, custos reduzidos, alta efici√™ncia operacional e qualidade superior, permitindo crescimento sustent√°vel, competitividade e maior satisfa√ß√£o dos clientes.' },
      { id: 'Organize', titulo: '03 ‚Äì Organize', emoji: 'üóÇÔ∏è', descricao: 'Processos totalmente padronizados, documentados e consistentes, garantindo efici√™ncia, menos erros, uso otimizado de recursos e uma opera√ß√£o preparada para crescer de forma sustent√°vel.' },
      { id: 'Lidere', titulo: '04 ‚Äì Lidere', emoji: 'üëî', descricao: 'Ouvir clientes e aplicar melhorias impulsiona inova√ß√£o, competitividade e diversifica√ß√£o. Abrir-se a mudan√ßas e parcerias fortalece crescimento, adapta√ß√£o e oportunidades no mercado.' },
      { id: 'Potencialize', titulo: '05 ‚Äì Potencialize', emoji: '‚ö°', descricao: 'Priorizar melhorias estrat√©gicas, buscar parcerias, analisar efici√™ncia, explorar financiamentos e incentivar inova√ß√£o garante adapta√ß√£o e futuro sustent√°vel.' }
    ];

    const crescimentoEmpresarial = [
      { id: 'Marketing e Vendas', titulo: '01 ‚Äì Marketing e Vendas', emoji: 'üì¢', descricao: 'Alta estabilidade, senso de estrat√©gia, n√£o depende de demanda espont√¢nea, conhece seu p√∫blico e tem previsibilidade do seu faturamento.' },
      { id: 'Financas', titulo: '02 ‚Äì Finan√ßas', emoji: 'üí∞', descricao: 'Precifica√ß√£o clara garante lucro previs√≠vel, fluxo de caixa saud√°vel, reposi√ß√£o de estoque, pagamento correto de impostos e competitividade com decis√µes seguras baseadas em dados.' },
      { id: 'Planejamento', titulo: '03 ‚Äì Planejamento', emoji: 'üéØ', descricao: 'Clareza das prioridades, organiza√ß√£o dos processos, decis√µes mais estrat√©gicas, metas simples e planejamento estruturado que aumentam foco, oportunidades e potencial de crescimento.' },
      { id: 'Pessoas', titulo: '04 ‚Äì Pessoas', emoji: 'üë•', descricao: 'Gest√£o estruturada aumenta motiva√ß√£o, produtividade e qualidade. Com pap√©is claros, recrutamento b√°sico, treinamentos e a√ß√µes de engajamento, a equipe melhora desempenho e resultados.' },
      { id: 'Operacoes', titulo: '05 ‚Äì Opera√ß√µes', emoji: '‚öôÔ∏è', descricao: 'Processos mapeados e documentados reduzem erros e retrabalho. Com equipe capacitada e indicadores claros, a opera√ß√£o ganha efici√™ncia, organiza√ß√£o e melhoria cont√≠nua.' }
    ];

    let assessoriasData = [];
    let ultimosResultados = [];
    let sugestoesData = [];
    let todasJornadasData = []; // Armazenar todas as jornadas para uso no modal
    let solucoesSelecionadas = new Set(); // Armazenar IDs das solu√ß√µes selecionadas para relat√≥rio
    let selecao = {
      tipoMomento: null,
      categorias: [],
      porte: null,
      setor: null
    };
    const STORAGE_KEY = 'guia_sebrae_solucoes';
    const STORAGE_KEY_SUGESTOES = 'guia_sebrae_sugestoes';

    // --- Supabase: configura√ß√£o do projeto Guia de Solu√ß√µes Sebrae ---
    const SUPABASE_URL = 'https://gzhjmyzsiqmpmavvnevm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6aGpteXpzaXFtcG1hdnZuZXZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxOTE5ODMsImV4cCI6MjA4NDc2Nzk4M30.WMKB9u_mv7eSdWSukEVZ5colTgnDBpE_cS7aO_C_iRI';
    let supabaseClient = null;
    /*
    SQL para criar a tabela no Supabase (Table Editor ou SQL Editor):
    CREATE TABLE solucoes (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      codigo TEXT, momento_empresarial TEXT, crescimento_empresarial TEXT, porte TEXT, setor TEXT,
      assessoria_nome TEXT NOT NULL, assessoria_descricao TEXT, segmento TEXT, area_conhecimento TEXT,
      temas TEXT, carga_horaria TEXT, instrumento TEXT, fornecedor TEXT, proxima_data TEXT,
      valor NUMERIC DEFAULT 0, ordem INT DEFAULT 1, criado_em TIMESTAMPTZ DEFAULT now()
    );
    -- Se a tabela j√° existir: ALTER TABLE solucoes ADD COLUMN IF NOT EXISTS proxima_data TEXT;
    -- Habilite RLS e pol√≠ticas conforme sua necessidade.
    */

    /** @returns {'supabase'|'local'} */
    async function carregarDados() {
      if (supabaseClient) {
        try {
          const { data, error } = await supabaseClient.from('solucoes').select('id, codigo, porte, setor, momento_empresarial, crescimento_empresarial, assessoria_nome, assessoria_descricao, segmento, area_conhecimento, temas, carga_horaria, instrumento, fornecedor, valor, ordem, link_direcionamento, proxima_data, data_validade, criado_em');
          if (error) throw error;
          assessoriasData = (data || []).map(a => {
            if (!a.__backendId) a.__backendId = a.id;
            return a;
          });
          return 'supabase';
        } catch (e) {
          console.warn('Supabase: erro ao carregar, usando localStorage:', e);
        }
      }
      try {
        const s = localStorage.getItem(STORAGE_KEY);
        assessoriasData = s ? JSON.parse(s) : [];
        assessoriasData.forEach(a => { if (!a.__backendId) a.__backendId = a.id; });
      } catch (e) {
        assessoriasData = [];
      }
      return 'local';
    }


    function persistirDados() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(assessoriasData));
      } catch (e) {
        console.error('Erro ao salvar no armazenamento local:', e);
      }
    }

    async function adicionarSolucao(obj) {
      console.log('üìù adicionarSolucao chamado, supabaseClient:', supabaseClient ? 'existe' : 'n√£o existe');
      if (supabaseClient) {
        try {
          const toInsert = {
            codigo: obj.codigo || null,
            momento_empresarial: obj.momento_empresarial || null,
            crescimento_empresarial: obj.crescimento_empresarial || null,
            porte: obj.porte,
            setor: obj.setor,
            assessoria_nome: obj.assessoria_nome,
            assessoria_descricao: obj.assessoria_descricao || null,
            segmento: obj.segmento || null,
            area_conhecimento: obj.area_conhecimento || null,
            temas: obj.temas || null,
            carga_horaria: (obj.carga_horaria !== undefined && obj.carga_horaria !== null && String(obj.carga_horaria).trim() !== '') ? String(obj.carga_horaria).trim() : null,
            instrumento: obj.instrumento || null,
            fornecedor: obj.fornecedor || null,
            proxima_data: obj.proxima_data || null,
            valor: (obj.valor != null && obj.valor !== '') ? Number(obj.valor) : 0,
            ordem: (obj.ordem != null && obj.ordem !== '') ? parseInt(obj.ordem, 10) : 1,
            link_direcionamento: obj.link_direcionamento || null
          };
          console.log('Tentando inserir no Supabase:', toInsert);
          const { data, error } = await supabaseClient.from('solucoes').insert(toInsert).select().single();
          if (error) {
            console.error('‚ùå Erro do Supabase ao inserir:', error);
            console.error('Dados tentados:', JSON.stringify(toInsert, null, 2));
            return { isOk: false, error: error.message || 'Erro desconhecido do Supabase' };
          }
          const item = { ...data, __backendId: data.id };
          assessoriasData.push(item);
          return { isOk: true };
        } catch (e) {
          console.error('Erro ao adicionar solu√ß√£o:', e);
          return { isOk: false, error: e.message };
        }
      }
      obj.id = obj.id || ('assess-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9));
      obj.__backendId = obj.id;
      assessoriasData.push(obj);
      persistirDados();
      return { isOk: true };
    }

    async function removerSolucao(assessoria) {
      const id = assessoria.__backendId || assessoria.id;
      if (supabaseClient && id) {
        try {
          const { error } = await supabaseClient.from('solucoes').delete().eq('id', id);
          if (error) return { isOk: false };
        } catch (e) {
          return { isOk: false };
        }
      }
      assessoriasData = assessoriasData.filter(a => (a.__backendId || a.id) !== id);
      if (!supabaseClient) persistirDados();
      return { isOk: true };
    }

    async function onConfigChange(config) {
      const tituloPrincipal = config.titulo_principal || defaultConfig.titulo_principal;
      const subtitulo = config.subtitulo || defaultConfig.subtitulo;
      const corPrincipal = config.cor_principal || defaultConfig.cor_principal;
      const corSecundaria = config.cor_secundaria || defaultConfig.cor_secundaria;
      const corFundo = config.cor_fundo || defaultConfig.cor_fundo;
      const corTexto = config.cor_texto || defaultConfig.cor_texto;
      const fonteFamilia = config.fonte_familia || defaultConfig.fonte_familia;
      const tamanhoFonte = config.tamanho_fonte || defaultConfig.tamanho_fonte;

      document.getElementById('titulo-principal').textContent = tituloPrincipal;
      document.getElementById('subtitulo').textContent = subtitulo;

      const fontStack = `${fonteFamilia}, Montserrat, sans-serif`;
      document.body.style.fontFamily = fontStack;
      
      document.getElementById('titulo-principal').style.fontSize = `${tamanhoFonte * 3.125}px`;
      document.getElementById('subtitulo').style.fontSize = `${tamanhoFonte * 1.25}px`;

      document.documentElement.style.setProperty('--cor-principal', corPrincipal);
      document.documentElement.style.setProperty('--cor-secundaria', corSecundaria);
      
      // Removido: background do app-wrapper para manter fundo √∫nico no body/html
      // document.getElementById('app-wrapper').style.background = `linear-gradient(to bottom, ${corFundo} 0%, #ffffff 100%)`;
    }

    // Sistema de Autentica√ß√£o de Gestor
    const GESTOR_CREDENTIALS = {
      usuario: 'gestor',
      senha: 'sebrae2024'
    };

    function verificarGestorAutenticado() {
      return localStorage.getItem('gestor_autenticado') === 'true';
    }

    function autenticarGestor(usuario, senha) {
      if (usuario === GESTOR_CREDENTIALS.usuario && senha === GESTOR_CREDENTIALS.senha) {
        localStorage.setItem('gestor_autenticado', 'true');
        return true;
      }
      return false;
    }

    function desautenticarGestor() {
      localStorage.removeItem('gestor_autenticado');
      atualizarVisibilidadeAbaGestor();
    }

    function atualizarVisibilidadeAbaGestor() {
      const wrap = document.getElementById('nav-sair-wrap');
      const lock = document.getElementById('nav-gestao-lock');
      const ok = document.getElementById('nav-gestao-ok');
      const hint = document.getElementById('nav-gestao-hint');
      if (verificarGestorAutenticado()) {
        if (wrap) wrap.style.display = '';
        if (lock) lock.classList.add('hidden');
        if (ok) ok.classList.remove('hidden');
        if (hint) hint.textContent = '';
      } else {
        if (wrap) wrap.style.display = 'none';
        if (lock) lock.classList.remove('hidden');
        if (ok) ok.classList.add('hidden');
        if (hint) hint.textContent = '(login)';
      }
    }

    function abrirSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainWrap = document.getElementById('main-wrap');
      const btnOpen = document.getElementById('btn-sidebar-open');
      const isMobile = window.matchMedia('(max-width: 1023px)').matches;
      sidebar.classList.remove('sidebar--closed');
      sidebar.classList.add('sidebar--open');
      if (mainWrap) mainWrap.classList.remove('sidebar-closed-margin');
      if (btnOpen) btnOpen.classList.remove('sidebar-open--visible');
      if (isMobile) {
        document.getElementById('sidebar-backdrop').classList.add('backdrop--on');
        document.body.style.overflow = 'hidden';
      }
    }

    function fecharSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainWrap = document.getElementById('main-wrap');
      const btnOpen = document.getElementById('btn-sidebar-open');
      sidebar.classList.remove('sidebar--open');
      document.getElementById('sidebar-backdrop').classList.remove('backdrop--on');
      document.body.style.overflow = '';
      if (window.matchMedia('(min-width: 1024px)').matches) {
        sidebar.classList.add('sidebar--closed');
        if (mainWrap) mainWrap.classList.add('sidebar-closed-margin');
      }
      if (btnOpen) btnOpen.classList.add('sidebar-open--visible');
    }

    function abrirSidebarMobile() { abrirSidebar(); }
    function fecharSidebarMobile() { fecharSidebar(); }

    function abrirLoginGestor() {
      document.getElementById('modal-login').classList.remove('hidden');
      document.getElementById('login-erro').classList.add('hidden');
      document.getElementById('login-usuario').value = '';
      document.getElementById('login-senha').value = '';
    }

    function fecharLoginGestor() {
      document.getElementById('modal-login').classList.add('hidden');
    }

    function verificarGestor() {
      if (verificarGestorAutenticado()) {
        trocarAba('gerenciamento');
      } else {
        abrirLoginGestor();
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      renderCardsEmpresarial();
      renderCardsCrescimento();
      atualizarVisibilidadeAbaGestor();
      
      // Bot√£o flutuante ser√° criado apenas ap√≥s uma busca ser realizada

      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.cor_principal || defaultConfig.cor_principal,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.cor_principal = value;
                    window.elementSdk.setConfig({ cor_principal: value });
                  }
                }
              },
              {
                get: () => config.cor_secundaria || defaultConfig.cor_secundaria,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.cor_secundaria = value;
                    window.elementSdk.setConfig({ cor_secundaria: value });
                  }
                }
              },
              {
                get: () => config.cor_fundo || defaultConfig.cor_fundo,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.cor_fundo = value;
                    window.elementSdk.setConfig({ cor_fundo: value });
                  }
                }
              },
              {
                get: () => config.cor_texto || defaultConfig.cor_texto,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.cor_texto = value;
                    window.elementSdk.setConfig({ cor_texto: value });
                  }
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.fonte_familia || defaultConfig.fonte_familia,
              set: (value) => {
                if (window.elementSdk && window.elementSdk.config) {
                  window.elementSdk.config.fonte_familia = value;
                  window.elementSdk.setConfig({ fonte_familia: value });
                }
              }
            },
            fontSizeable: {
              get: () => config.tamanho_fonte || defaultConfig.tamanho_fonte,
              set: (value) => {
                if (window.elementSdk && window.elementSdk.config) {
                  window.elementSdk.config.tamanho_fonte = value;
                  window.elementSdk.setConfig({ tamanho_fonte: value });
                }
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["titulo_principal", config.titulo_principal || defaultConfig.titulo_principal],
            ["subtitulo", config.subtitulo || defaultConfig.subtitulo]
          ])
        });
      }

      // Supabase: criar client se URL e anon key estiverem preenchidos
      if (SUPABASE_URL && SUPABASE_ANON_KEY && !/^\s*$/.test(SUPABASE_URL) && !/^\s*$/.test(SUPABASE_ANON_KEY)) {
        try {
          // Aguardar um pouco para garantir que o script do CDN foi carregado
          await new Promise(resolve => setTimeout(resolve, 100));
          
          let createClientFn = null;
          
          // Tentar diferentes formas de acessar o Supabase do CDN
          // O CDN UMD exp√µe como window.supabase ou supabase global
          if (typeof window !== 'undefined' && window.supabase && window.supabase.createClient) {
            createClientFn = window.supabase.createClient;
            console.log('‚úÖ Supabase: Usando window.supabase.createClient');
          } else if (typeof supabase !== 'undefined' && supabase.createClient) {
            createClientFn = supabase.createClient;
            console.log('‚úÖ Supabase: Usando supabase.createClient');
          } else {
            // Fallback para import din√¢mico
            console.log('‚ö†Ô∏è Supabase: Tentando import din√¢mico...');
            const module = await import('https://esm.sh/@supabase/supabase-js@2');
            createClientFn = module.createClient;
            console.log('‚úÖ Supabase: Usando import din√¢mico');
          }
          
          if (createClientFn) {
            supabaseClient = createClientFn(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('‚úÖ Supabase: Cliente criado com sucesso');
            console.log('URL:', SUPABASE_URL);
            
            // Testar conex√£o
            try {
              const { data: testData, error: testError } = await supabaseClient.from('solucoes').select('id').limit(1);
              if (testError) {
                console.warn('‚ö†Ô∏è Supabase: Erro ao testar conex√£o:', testError);
                console.warn('Detalhes:', JSON.stringify(testError, null, 2));
              } else {
                console.log('‚úÖ Supabase: Conex√£o testada com sucesso');
              }
            } catch (testErr) {
              console.warn('‚ö†Ô∏è Supabase: Erro ao testar conex√£o:', testErr);
            }
          } else {
            throw new Error('N√£o foi poss√≠vel encontrar createClient do Supabase. Verifique se o script foi carregado.');
          }
        } catch (e) {
          console.error('‚ùå Supabase: falha ao carregar client, usando localStorage:', e);
          console.error('Stack:', e.stack);
          supabaseClient = null;
        }
      } else {
        console.warn('‚ö†Ô∏è Supabase: URL ou ANON_KEY n√£o configurados');
        console.warn('URL:', SUPABASE_URL);
        console.warn('Key:', SUPABASE_ANON_KEY ? 'Configurada' : 'N√£o configurada');
      }
      await carregarDados();
      await carregarSugestoes();
      atualizarListaAssessorias();
      atualizarListaSugestoes();

      document.getElementById('cadastro-form').addEventListener('submit', handleCadastro);
      
      // Restaurar bot√£o de cadastro ao resetar formul√°rio
      document.getElementById('cadastro-form').addEventListener('reset', () => {
        const btnCadastrar = document.getElementById('btn-cadastrar');
        btnCadastrar.textContent = '‚úì Cadastrar Solu√ß√£o';
        btnCadastrar.onclick = null;
        btnCadastrar.type = 'submit';
      });
      document.getElementById('cad-tipo-momento').addEventListener('change', atualizarCategorias);
      
      // Event listener para atualizar categorias no formul√°rio de sugest√£o
      const sugTipoMomento = document.getElementById('sug-tipo-momento');
      if (sugTipoMomento) {
        sugTipoMomento.addEventListener('change', atualizarCategoriasSugestao);
        // Inicializar com todas as op√ß√µes (quando "Todos" est√° selecionado)
        atualizarCategoriasSugestao();
      }
      
      // Formul√°rio de login de gestor
      document.getElementById('form-login-gestor').addEventListener('submit', (e) => {
        e.preventDefault();
        const usuario = document.getElementById('login-usuario').value;
        const senha = document.getElementById('login-senha').value;
        const erroDiv = document.getElementById('login-erro');
        
        if (autenticarGestor(usuario, senha)) {
          fecharLoginGestor();
          atualizarVisibilidadeAbaGestor();
          trocarAba('gerenciamento');
          showToast('‚úì Login realizado com sucesso!', 'success');
        } else {
          erroDiv.textContent = 'Usu√°rio ou senha incorretos. Tente novamente.';
          erroDiv.classList.remove('hidden');
        }
      });
      
      // Fechar modal ao clicar fora
      document.getElementById('modal-login').addEventListener('click', (e) => {
        if (e.target.id === 'modal-login') {
          fecharLoginGestor();
        }
      });
      
      atualizarListaAssessorias();
    });

    function renderCardsEmpresarial() {
      const grid = document.getElementById('grid-empresarial');
      const cardsHTML = momentoEmpresarial.map(item => `
        <button onclick="selecionarCategoria('${item.id}')" data-card="${item.id}" class="card-option bg-white rounded-xl shadow-lg p-6 text-left">
          <div class="flex items-center gap-3 mb-3">
            <span class="text-3xl">${item.emoji}</span>
            <h3 class="text-lg font-bold" style="color: #00608B;">${item.titulo}</h3>
          </div>
          <p class="text-sm" style="color: #666;">${item.descricao}</p>
        </button>
      `).join('');
      
      // Adicionar "N√£o preciso melhorar" ao final do grid (ao lado do 5)
      const naoPrecisoMelhorarHTML = `
        <button onclick="naoPresisoMelhorar()" class="card-option bg-white rounded-xl shadow-lg p-6 text-left border-2 hover:shadow-xl transition-all hover:scale-105" style="border-color: #2196F3; border-width: 2px;">
          <div class="flex items-center gap-3 mb-3">
            <span class="text-3xl">‚ú®</span>
            <h3 class="text-lg font-bold" style="color: #00608B;">N√£o preciso melhorar</h3>
          </div>
          <p class="text-sm" style="color: #666;">Minha empresa j√° est√° bem estruturada e n√£o necessita de melhorias no momento.</p>
        </button>
      `;
      
      grid.innerHTML = cardsHTML + naoPrecisoMelhorarHTML;
    }

    function renderCardsCrescimento() {
      const grid = document.getElementById('grid-crescimento');
      const cardsHTML = crescimentoEmpresarial.map(item => `
        <button onclick="selecionarCategoria('${item.id}')" data-card="${item.id}" class="card-option bg-white rounded-xl shadow-lg p-6 text-left">
          <div class="flex items-center gap-3 mb-3">
            <span class="text-3xl">${item.emoji}</span>
            <h3 class="text-lg font-bold" style="color: #00608B;">${item.titulo}</h3>
          </div>
          <p class="text-sm" style="color: #666;">${item.descricao}</p>
        </button>
      `).join('');
      
      // Adicionar "N√£o preciso melhorar" ao final do grid (ao lado do √∫ltimo card)
      const naoPrecisoMelhorarHTML = `
        <button onclick="naoPresisoMelhorar()" class="card-option bg-white rounded-xl shadow-lg p-6 text-left border-2 hover:shadow-xl transition-all hover:scale-105" style="border-color: #2196F3; border-width: 2px;">
          <div class="flex items-center gap-3 mb-3">
            <span class="text-3xl">‚ú®</span>
            <h3 class="text-lg font-bold" style="color: #00608B;">N√£o preciso melhorar</h3>
          </div>
          <p class="text-sm" style="color: #666;">Minha empresa j√° est√° bem estruturada e n√£o necessita de melhorias no momento.</p>
        </button>
      `;
      
      grid.innerHTML = cardsHTML + naoPrecisoMelhorarHTML;
    }

    function selecionarMomento(tipo) {
      selecao.tipoMomento = tipo;
      
      document.getElementById('step-momento').classList.add('hidden');
      
      if (tipo === 'empresarial') {
        document.getElementById('cards-empresarial').classList.remove('hidden');
      } else {
        document.getElementById('cards-crescimento').classList.remove('hidden');
      }
    }

    function selecionarCategoria(categoria) {
      const gridAtual = selecao.tipoMomento === 'empresarial' ? 'grid-empresarial' : 'grid-crescimento';
      const card = document.querySelector(`#${gridAtual} [data-card="${categoria}"]`);
      
      if (selecao.categorias.includes(categoria)) {
        selecao.categorias = selecao.categorias.filter(c => c !== categoria);
        card.classList.remove('selected');
      } else {
        selecao.categorias.push(categoria);
        card.classList.add('selected');
      }
      
      const btnId = selecao.tipoMomento === 'empresarial' ? 'btn-avancar-momento' : 'btn-avancar-crescimento';
      document.getElementById(btnId).disabled = selecao.categorias.length === 0;
    }

    function selecionarTodos(tipo) {
      const lista = tipo === 'empresarial' ? momentoEmpresarial : crescimentoEmpresarial;
      const gridAtual = tipo === 'empresarial' ? 'grid-empresarial' : 'grid-crescimento';
      
      selecao.categorias = lista.map(item => item.id);
      
      document.querySelectorAll(`#${gridAtual} .card-option`).forEach(card => {
        card.classList.add('selected');
      });
      
      const btnId = tipo === 'empresarial' ? 'btn-avancar-momento' : 'btn-avancar-crescimento';
      document.getElementById(btnId).disabled = false;
    }

    function selecionarNenhum(tipo) {
      const gridAtual = tipo === 'empresarial' ? 'grid-empresarial' : 'grid-crescimento';
      
      selecao.categorias = [];
      
      document.querySelectorAll(`#${gridAtual} .card-option`).forEach(card => {
        card.classList.remove('selected');
      });
      
      const btnId = tipo === 'empresarial' ? 'btn-avancar-momento' : 'btn-avancar-crescimento';
      document.getElementById(btnId).disabled = true;
    }

    function avancarParaPorte() {
      document.getElementById('cards-empresarial').classList.add('hidden');
      document.getElementById('cards-crescimento').classList.add('hidden');
      document.getElementById('step-porte').classList.remove('hidden');
      
      document.getElementById('step-1').classList.remove('active');
      document.getElementById('step-1').classList.add('completed');
      document.getElementById('line-1').classList.add('completed');
      document.getElementById('step-2').classList.add('active');
    }

    function selecionarPorte(porte) {
      selecao.porte = porte;
      
      document.querySelectorAll('#step-porte .card-option').forEach(card => {
        card.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
      
      setTimeout(() => {
        document.getElementById('step-porte').classList.add('hidden');
        document.getElementById('step-setor').classList.remove('hidden');
        
        document.getElementById('step-2').classList.remove('active');
        document.getElementById('step-2').classList.add('completed');
        document.getElementById('line-2').classList.add('completed');
        document.getElementById('step-3').classList.add('active');
      }, 300);
    }

    function selecionarSetor(setor) {
      selecao.setor = setor;
      
      document.querySelectorAll('#step-setor .card-option').forEach(card => {
        card.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
      
      setTimeout(() => {
        buscarAssessorias();
      }, 300);
    }

    const VALID_EMPRESARIAL = ['Gerencie','Planeje','Organize','Lidere','Potencialize'];
    const VALID_CRESCIMENTO = ['Marketing e Vendas','Financas','Planejamento','Pessoas','Operacoes'];

    function buscarAssessorias() {
      document.getElementById('step-setor').classList.add('hidden');
      document.getElementById('step-resultados').classList.remove('hidden');
      
      document.getElementById('step-3').classList.remove('active');
      document.getElementById('step-3').classList.add('completed');
      
      // Limpar sele√ß√µes anteriores ao fazer nova busca
      solucoesSelecionadas.clear();
      atualizarContadorSelecionadas();
      
      const resultados = assessoriasData.filter(a => {
        const categoriaAtual = selecao.tipoMomento === 'empresarial' 
          ? a.momento_empresarial 
          : a.crescimento_empresarial;
        
        var categoriaMatch;
        if (selecao.categorias.indexOf('Nenhuma') >= 0) {
          // Se "Nenhuma" foi selecionado, buscar solu√ß√µes sem categoria (null ou vazio)
          categoriaMatch = !categoriaAtual || categoriaAtual === '' || categoriaAtual === null;
        } else {
          var validas = selecao.tipoMomento === 'empresarial' ? VALID_EMPRESARIAL : VALID_CRESCIMENTO;
          if (categoriaAtual && validas.indexOf(categoriaAtual) >= 0) {
            categoriaMatch = selecao.categorias.indexOf(categoriaAtual) >= 0;
          } else {
            var padrao = selecao.tipoMomento === 'empresarial' ? 'Gerencie' : 'Marketing e Vendas';
            categoriaMatch = selecao.categorias.indexOf(padrao) >= 0;
          }
        }
        
        // Normalizar setor para compara√ß√£o
        let setorA = a.setor || '';
        if (setorA === 'Com√©rcio') setorA = 'Comercio';
        else if (setorA === 'Ind√∫stria') setorA = 'Industria';
        else if (setorA === 'Servi√ßos') setorA = 'Servicos';
        
        return categoriaMatch && 
               a.porte === selecao.porte && 
               setorA === selecao.setor;
      }).sort((a, b) => (a.ordem || 0) - (b.ordem || 0));

      renderResumoSelecao();
      ultimosResultados = resultados;

      if (resultados.length > 0) {
        renderResultados(resultados);
        document.getElementById('mensagem-sem-resultados').classList.add('hidden');
        
        // Criar e exibir bot√£o flutuante apenas quando houver resultados
        criarModalSelecaoRelatorio();
        mostrarBotaoFlutuante();
      } else {
        document.getElementById('resultados-container').innerHTML = '';
        document.getElementById('mensagem-sem-resultados').classList.remove('hidden');
        
        // Ocultar bot√£o flutuante quando n√£o houver resultados
        ocultarBotaoFlutuante();
      }
      
      // Buscar e exibir sugest√£o de ferramenta
      buscarEExibirSugestao();
    }

    function renderResumoSelecao() {
      const resumo = document.getElementById('resumo-selecao');
      const tipoTexto = selecao.tipoMomento === 'empresarial' ? 'Momento Empresarial' : 'Crescimento Empresarial';
      
      // Mapeamento de cores para momentos empresariais
      const coresMomentoEmpresarial = {
        'Gerencie': { bg: '#FF6B35', color: '#FFFFFF' }, // Laranja vibrante
        'Planeje': { bg: '#2BB29D', color: '#FFFFFF' }, // Teal
        'Organize': { bg: '#FF6B35', color: '#FFFFFF' }, // Laranja vibrante
        'Lidere': { bg: '#0066CC', color: '#FFFFFF' }, // Azul vibrante
        'Potencialize': { bg: '#FF6B35', color: '#FFFFFF' } // Laranja vibrante
      };
      
      const categoriasBadges = selecao.categorias.map(cat => {
        const cor = coresMomentoEmpresarial[cat] || { bg: '#E3ECEE', color: '#00608B' };
        return `<span class="badge" style="background-color: ${cor.bg}; color: ${cor.color}; font-weight: 600;">${cat}</span>`;
      }).join('');
      
      resumo.innerHTML = `
        <span class="badge" style="background-color: #E3ECEE; color: #00608B;">${tipoTexto}</span>
        ${categoriasBadges}
        <span class="badge" style="background-color: #E8F7F0; color: #00A859;">${selecao.porte}</span>
        <span class="badge" style="background-color: #FFF4E6; color: #FF8C00;">${selecao.setor}</span>
      `;
      
      // Atualizar header do fluxograma
      const headerTitleEl = document.getElementById('header-trilha-titulo');
      const headerDescEl = document.getElementById('header-trilha-desc');
      const headerContainer = document.getElementById('header-trilha');
      
      if (headerTitleEl && headerDescEl) {
        const headerTitle = selecao.categorias.length > 0 && selecao.categorias[0] !== 'Nenhuma' 
          ? selecao.categorias[0] 
          : (selecao.tipoMomento === 'empresarial' ? 'Gerencie' : 'Crescimento');
        const headerDesc = selecao.tipoMomento === 'empresarial' 
          ? 'Processo simplificado de estrutura√ß√£o e gest√£o empresarial'
          : 'Jornada de crescimento e expans√£o empresarial';
        headerTitleEl.textContent = headerTitle;
        headerDescEl.textContent = headerDesc;
        
        // Aplicar cores do momento empresarial ao container
        if (headerContainer && selecao.tipoMomento === 'empresarial' && selecao.categorias.length > 0 && selecao.categorias[0] !== 'Nenhuma') {
          const momentoSelecionado = selecao.categorias[0];
          const coresContainer = {
            'Gerencie': 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)', // Laranja vibrante
            'Planeje': 'linear-gradient(135deg, #2BB29D 0%, #3DD4B8 100%)', // Teal
            'Organize': 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)', // Laranja vibrante
            'Lidere': 'linear-gradient(135deg, #0066CC 0%, #0080FF 100%)', // Azul vibrante
            'Potencialize': 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)' // Laranja vibrante
          };
          
          const corContainer = coresContainer[momentoSelecionado] || 'linear-gradient(135deg, #00608B 0%, #0092BA 100%)';
          headerContainer.style.background = corContainer;
        } else if (headerContainer) {
          // Cor padr√£o para crescimento empresarial ou quando n√£o h√° categoria
          headerContainer.style.background = 'linear-gradient(135deg, #00608B 0%, #0092BA 100%)';
        }
      }
    }

    function renderResultados(assessorias) {
      const container = document.getElementById('resultados-container');
      
      // Agrupar solu√ß√µes por momento empresarial > ordem (assessoria) > dor
      // Cada momento empresarial ter√° seu pr√≥prio container separado
      const solucoesPorMomento = {};
      assessorias.forEach((assessoria, index) => {
        const momento = assessoria.momento_empresarial || 'Sem Momento';
        const ordem = assessoria.ordem || 1;
        // Usar o valor real armazenado, ou 'Nenhuma' se for null/undefined/vazio
        const dor = (assessoria.crescimento_empresarial && String(assessoria.crescimento_empresarial).trim() !== '') 
          ? String(assessoria.crescimento_empresarial).trim() 
          : 'Nenhuma';
        
        if (!solucoesPorMomento[momento]) {
          solucoesPorMomento[momento] = {};
        }
        if (!solucoesPorMomento[momento][ordem]) {
          solucoesPorMomento[momento][ordem] = {};
        }
        if (!solucoesPorMomento[momento][ordem][dor]) {
          solucoesPorMomento[momento][ordem][dor] = [];
        }
        solucoesPorMomento[momento][ordem][dor].push({ ...assessoria, __index: index });
      });
      
      // Ordenar momentos (usar ordem espec√≠fica)
      const ordemMomentos = ['Gerencie', 'Planeje', 'Organize', 'Lidere', 'Potencialize'];
      const momentosOrdenados = Object.keys(solucoesPorMomento).sort((a, b) => {
        const idxA = ordemMomentos.indexOf(a);
        const idxB = ordemMomentos.indexOf(b);
        if (idxA === -1 && idxB === -1) return a.localeCompare(b);
        if (idxA === -1) return 1;
        if (idxB === -1) return -1;
        return idxA - idxB;
      });
      
      // Mapear nomes de dor para exibi√ß√£o (com varia√ß√µes poss√≠veis)
      const nomesDor = {
        'Marketing e Vendas': 'üì¢ Marketing e Vendas',
        'Marketing e vendas': 'üì¢ Marketing e Vendas',
        'marketing e vendas': 'üì¢ Marketing e Vendas',
        'Financas': 'üí∞ Finan√ßas',
        'Finan√ßas': 'üí∞ Finan√ßas',
        'financas': 'üí∞ Finan√ßas',
        'Planejamento': 'üéØ Planejamento',
        'planejamento': 'üéØ Planejamento',
        'Pessoas': 'üë• Pessoas',
        'pessoas': 'üë• Pessoas',
        'Operacoes': '‚öôÔ∏è Opera√ß√µes',
        'Opera√ß√µes': '‚öôÔ∏è Opera√ß√µes',
        'operacoes': '‚öôÔ∏è Opera√ß√µes',
        'Nenhuma': '‚ú® Sem dor espec√≠fica',
        'nenhuma': '‚ú® Sem dor espec√≠fica'
      };
      
      // Mapeamento de cores e nomes para momentos empresariais
      const momentosInfo = {
        'Gerencie': { nome: 'Gerencie', cor: '#FF6B35', emoji: 'üìä' },
        'Planeje': { nome: 'Planeje', cor: '#2BB29D', emoji: 'üìã' },
        'Organize': { nome: 'Organize', cor: '#FF6B35', emoji: 'üóÇÔ∏è' },
        'Lidere': { nome: 'Lidere', cor: '#0066CC', emoji: 'üëî' },
        'Potencialize': { nome: 'Potencialize', cor: '#FF6B35', emoji: '‚ö°' },
        'Sem Momento': { nome: 'Sem Momento', cor: '#00608B', emoji: '‚ùì' }
      };
      
      // Mapear cores para cada dor
      const coresDor = {
        'Marketing e Vendas': { 
          primaria: '#FF6B35', 
          secundaria: '#FF8C5A',
          gradiente: 'linear-gradient(90deg, #FF6B35 0%, #FF8C5A 100%)',
          badgeGradiente: 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)'
        },
        'Marketing e vendas': { 
          primaria: '#FF6B35', 
          secundaria: '#FF8C5A',
          gradiente: 'linear-gradient(90deg, #FF6B35 0%, #FF8C5A 100%)',
          badgeGradiente: 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)'
        },
        'marketing e vendas': { 
          primaria: '#FF6B35', 
          secundaria: '#FF8C5A',
          gradiente: 'linear-gradient(90deg, #FF6B35 0%, #FF8C5A 100%)',
          badgeGradiente: 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)'
        },
        'Financas': { 
          primaria: '#00A859', 
          secundaria: '#00C96B',
          gradiente: 'linear-gradient(90deg, #00A859 0%, #00C96B 100%)',
          badgeGradiente: 'linear-gradient(135deg, #00A859 0%, #00C96B 100%)'
        },
        'Finan√ßas': { 
          primaria: '#00A859', 
          secundaria: '#00C96B',
          gradiente: 'linear-gradient(90deg, #00A859 0%, #00C96B 100%)',
          badgeGradiente: 'linear-gradient(135deg, #00A859 0%, #00C96B 100%)'
        },
        'financas': { 
          primaria: '#00A859', 
          secundaria: '#00C96B',
          gradiente: 'linear-gradient(90deg, #00A859 0%, #00C96B 100%)',
          badgeGradiente: 'linear-gradient(135deg, #00A859 0%, #00C96B 100%)'
        },
        'Planejamento': { 
          primaria: '#0066CC', 
          secundaria: '#0080FF',
          gradiente: 'linear-gradient(90deg, #0066CC 0%, #0080FF 100%)',
          badgeGradiente: 'linear-gradient(135deg, #0066CC 0%, #0080FF 100%)'
        },
        'planejamento': { 
          primaria: '#0066CC', 
          secundaria: '#0080FF',
          gradiente: 'linear-gradient(90deg, #0066CC 0%, #0080FF 100%)',
          badgeGradiente: 'linear-gradient(135deg, #0066CC 0%, #0080FF 100%)'
        },
        'Pessoas': { 
          primaria: '#9B59B6', 
          secundaria: '#BB6BD9',
          gradiente: 'linear-gradient(90deg, #9B59B6 0%, #BB6BD9 100%)',
          badgeGradiente: 'linear-gradient(135deg, #9B59B6 0%, #BB6BD9 100%)'
        },
        'pessoas': { 
          primaria: '#9B59B6', 
          secundaria: '#BB6BD9',
          gradiente: 'linear-gradient(90deg, #9B59B6 0%, #BB6BD9 100%)',
          badgeGradiente: 'linear-gradient(135deg, #9B59B6 0%, #BB6BD9 100%)'
        },
        'Operacoes': { 
          primaria: '#2BB29D', 
          secundaria: '#3DD4B8',
          gradiente: 'linear-gradient(90deg, #2BB29D 0%, #3DD4B8 100%)',
          badgeGradiente: 'linear-gradient(135deg, #2BB29D 0%, #3DD4B8 100%)'
        },
        'Opera√ß√µes': { 
          primaria: '#2BB29D', 
          secundaria: '#3DD4B8',
          gradiente: 'linear-gradient(90deg, #2BB29D 0%, #3DD4B8 100%)',
          badgeGradiente: 'linear-gradient(135deg, #2BB29D 0%, #3DD4B8 100%)'
        },
        'operacoes': { 
          primaria: '#2BB29D', 
          secundaria: '#3DD4B8',
          gradiente: 'linear-gradient(90deg, #2BB29D 0%, #3DD4B8 100%)',
          badgeGradiente: 'linear-gradient(135deg, #2BB29D 0%, #3DD4B8 100%)'
        }
      };
      
      // Fun√ß√£o para obter cor da dor (com fallback para laranja padr√£o)
      const obterCorDor = (dor) => {
        return coresDor[dor] || {
          primaria: '#FF6B35',
          secundaria: '#FF8C5A',
          gradiente: 'linear-gradient(90deg, #FF6B35 0%, #FF8C5A 100%)',
          badgeGradiente: 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)'
        };
      };
      
      const inst = (a) => (a.instrumento && String(a.instrumento).trim()) ? a.instrumento : 'Solu√ß√£o';
      
      // Renderizar containers separados para cada Momento Empresarial
      const html = momentosOrdenados.map((momento, momentoIndex) => {
        const infoMomento = momentosInfo[momento] || momentosInfo['Sem Momento'];
        const solucoesPorOrdem = solucoesPorMomento[momento];
        
        // Agrupar solu√ß√µes por dor dentro deste momento
        const solucoesPorDorNoMomento = {};
        Object.keys(solucoesPorOrdem).forEach(ordem => {
          Object.keys(solucoesPorOrdem[ordem]).forEach(dor => {
            if (!solucoesPorDorNoMomento[dor]) {
              solucoesPorDorNoMomento[dor] = {};
            }
            if (!solucoesPorDorNoMomento[dor][ordem]) {
              solucoesPorDorNoMomento[dor][ordem] = [];
            }
            solucoesPorDorNoMomento[dor][ordem].push(...solucoesPorOrdem[ordem][dor]);
          });
        });
        
        // Verificar se h√° solu√ß√µes neste momento
        const todasOrdens = new Set();
        Object.keys(solucoesPorDorNoMomento).forEach(dor => {
          Object.keys(solucoesPorDorNoMomento[dor]).forEach(ordem => {
            todasOrdens.add(ordem);
          });
        });
        
        if (todasOrdens.size === 0) return '';
        
        // Ordenar dores (colocar "Nenhuma" por √∫ltimo)
        const doresOrdenadasNoMomento = Object.keys(solucoesPorDorNoMomento)
          .filter(dor => dor !== 'Nenhuma' && dor !== 'nenhuma')
          .sort()
          .concat(Object.keys(solucoesPorDorNoMomento).filter(dor => dor === 'Nenhuma' || dor === 'nenhuma'));
        
        return `
          <div class="bg-white rounded-xl shadow-lg border-2 p-4 md:p-6 mb-6 fade-in" style="border-color: ${infoMomento.cor}; animation-delay: ${momentoIndex * 0.1}s;">
            <!-- Banner do Momento Empresarial -->
            <div class="mb-4 md:mb-6 fade-in" style="animation-delay: ${momentoIndex * 0.1}s;">
              <div class="inline-flex items-center px-4 py-3 md:px-8 md:py-4 rounded-xl shadow-lg w-full sm:w-auto" style="background: linear-gradient(135deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);">
                <span class="text-lg md:text-xl font-bold text-white text-center sm:text-left" style="font-family: 'Montserrat', sans-serif; letter-spacing: 0.5px;">${infoMomento.nome}</span>
              </div>
            </div>
            
            ${doresOrdenadasNoMomento.map((dor, dorIndex) => {
              const nomeDor = nomesDor[dor] || dor;
              const isSemDor = dor === 'Nenhuma' || dor === 'nenhuma' || !dor || dor.trim() === '';
              const solucoesPorOrdemNaDor = solucoesPorDorNoMomento[dor];
              const ordensOrdenadasNaDor = Object.keys(solucoesPorOrdemNaDor).map(Number).sort((a, b) => a - b);
              const corDor = obterCorDor(dor);
              
              return `
                <!-- Container da Dor -->
                <div class="mb-8 ${dorIndex > 0 ? 'mt-8' : ''}">
                  <!-- Nome da Dor - Banner acima dos fluxos -->
                  ${!isSemDor ? `
                  <div class="mb-4 md:mb-6 fade-in" style="animation-delay: ${dorIndex * 0.1}s;">
                    <div class="inline-flex items-center px-4 py-3 md:px-8 md:py-4 rounded-xl shadow-lg w-full sm:w-auto" style="background: ${corDor.badgeGradiente};">
                      <span class="text-lg md:text-xl font-bold text-white text-center sm:text-left" style="font-family: 'Montserrat', sans-serif; letter-spacing: 0.5px;">${nomeDor.replace(/^[üì¢üí∞üéØüë•‚öôÔ∏è‚ú®]\s*/, '')}</span>
                    </div>
                  </div>
                  ` : ''}
                  
                  <!-- Fluxograma de Assessorias para esta Dor -->
                  <div class="trilha-fluxograma" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 1.5rem; padding: 1rem 0.5rem; min-height: 300px;">
                    ${ordensOrdenadasNaDor.map((ordem, ordemIndex) => {
                      const solucoes = solucoesPorOrdemNaDor[ordem];
                      const isLast = ordemIndex === ordensOrdenadasNaDor.length - 1;
                
                return `
                  <div class="trilha-step fade-in" style="animation-delay: ${ordemIndex * 0.2}s;">
                    ${!isLast ? `<div class="trilha-step-divider" style="background: linear-gradient(180deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);"></div>` : ''}
                    
                    <!-- Chevron ASSESSORIA -->
                    <div class="trilha-assessoria-chevron" style="background: linear-gradient(135deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%); --chevron-color: ${infoMomento.cor};">
                      <div class="trilha-assessoria-text">ASSESSORIA ${ordem}</div>
                    </div>
                    
                    <!-- Linha tracejada e hex√°gono -->
                    <div class="trilha-dashed-line"></div>
                    <div class="trilha-hexagon" style="background: linear-gradient(135deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);"></div>
                    
                    <div class="trilha-step-content">
                      <div class="trilha-dor-solucoes">
                        ${solucoes.map((assessoria, solIndex) => {
                                const instrumento = inst(assessoria);
                                const v = assessoria.valor;
                                const n = (v != null && v !== '') ? Number(v) : NaN;
                                const temValor = !isNaN(n) && n > 0;
                                const valorTexto = temValor ? ('R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })) : 'Gratuito';
                                const valorBadgeColor = temValor ? '#B45309' : '#00A859';
                                const valorBadgeBg = temValor ? '#FFEDD5' : '#E8F7F0';
                                
                                const solucaoId = assessoria.id || `sol_${assessoria.__index}`;
                                const isSelected = solucoesSelecionadas.has(solucaoId);
                                
                                return `
                                  <div class="trilha-solucao-card p-4 md:p-5 mb-3 md:mb-4 fade-in relative" style="animation-delay: ${(ordemIndex * 0.2) + (dorIndex * 0.15) + (solIndex * 0.1)}s; --card-hexagon-color: ${infoMomento.cor}; ${isSelected ? 'border: 3px solid #00A859; background-color: #F0FDF4;' : ''}">
                                    <!-- Destaque: Pre√ßo e Tipo de Produto -->
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 md:mb-4 p-2 md:p-3 rounded-lg gap-2" style="background: linear-gradient(135deg, #E3ECEE 0%, #A0C5CF 100%); border: 2px solid ${infoMomento.cor};">
                                      <div class="flex-1 w-full sm:w-auto">
                                        <p class="text-xs font-semibold mb-1" style="color: #00608B;">Tipo de Produto</p>
                                        <p class="text-sm md:text-base font-bold" style="color: #00608B;">${instrumento}</p>
                                      </div>
                                      <div class="text-left sm:text-right w-full sm:w-auto sm:ml-4">
                                        <p class="text-xs font-semibold mb-1" style="color: #00608B;">Pre√ßo</p>
                                        <span class="inline-block px-2 md:px-3 py-1 rounded-lg font-bold text-sm md:text-lg" style="background-color: ${valorBadgeBg}; color: ${valorBadgeColor};">
                                          ${valorTexto}
                                        </span>
                                      </div>
                                    </div>
                                    
                                    <h3 class="text-lg md:text-xl font-bold mb-2 md:mb-3" style="color: #1F2937;">${assessoria.assessoria_nome}</h3>
                                    <p class="mb-3 md:mb-4 leading-relaxed line-clamp-3 text-sm md:text-base" style="color: #4B5563;">${assessoria.assessoria_descricao || ''}</p>
                                    ${assessoria.proxima_data ? `<div class="border-t-2 pt-2 md:pt-3 mt-2 md:mt-3 mb-3" style="border-color: #E5E7EB;"><p class="text-xs" style="color: #6B7280;">üìÖ Pr√≥xima turma: <strong style="color: #1F2937;">${assessoria.proxima_data}</strong></p></div>` : ''}
                                    
                                    <!-- CTAs: Saiba Mais e Selecionar -->
                                    <div class="flex gap-2 mt-4">
                                      <button onclick="abrirDetalheSolucao(${assessoria.__index})" 
                                              class="flex-1 px-4 py-2 rounded-lg font-semibold text-sm transition-all hover:scale-105 shadow-md"
                                              style="background: linear-gradient(135deg, #00608B 0%, #0092BA 100%); color: white;">
                                        ‚ÑπÔ∏è Saiba Mais
                                      </button>
                                      <button onclick="toggleSelecaoSolucao('${solucaoId}', ${assessoria.__index}, event)" 
                                              class="flex-1 px-4 py-2 rounded-lg font-semibold text-sm transition-all hover:scale-105 shadow-md ${isSelected ? '' : ''}"
                                              style="${isSelected ? 'background: linear-gradient(135deg, #00A859 0%, #059669 100%); color: white;' : 'background: #E8F7F0; color: #00A859; border: 2px solid #00A859;'}">
                                        ${isSelected ? '‚úì Selecionado' : '‚ûï Selecionar'}
                                      </button>
                                    </div>
                                  </div>
                                `;
                              }).join('')}
                      </div>
                    </div>
                  </div>
                  ${!isLast ? `
                  <div class="trilha-connector">
                    <div class="trilha-connector-line" style="background: linear-gradient(90deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);"></div>
                    <div class="trilha-connector-hexagon" style="background: linear-gradient(135deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);"></div>
                  </div>
                  ` : ''}
                `;
              }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }).filter(html => html !== '').join('');
      
      container.innerHTML = html;
      
      // Atualizar contador de sele√ß√µes ap√≥s renderizar
      atualizarContadorSelecionadas();
    }

    async function carregarTodasJornadas() {
      const container = document.getElementById('jornadas-container');
      if (!container) return;
      
      try {
        // Carregar todas as solu√ß√µes do banco de dados
        let todasSolucoes = [];
        if (supabaseClient) {
          const { data, error } = await supabaseClient
            .from('solucoes')
            .select('id, codigo, porte, setor, momento_empresarial, crescimento_empresarial, assessoria_nome, assessoria_descricao, segmento, area_conhecimento, temas, carga_horaria, instrumento, fornecedor, valor, ordem, link_direcionamento, proxima_data, criado_em')
            .order('ordem', { ascending: true });
          
          if (error) throw error;
          todasSolucoes = data || [];
        } else {
          // Se n√£o houver Supabase, usar dados locais
          todasSolucoes = assessoriasData || [];
        }
        
        if (todasSolucoes.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12">
              <svg class="w-20 h-20 mx-auto mb-4 opacity-50" fill="none" stroke="#00608B" viewbox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <p class="text-xl font-semibold mb-3" style="color: #666;">Nenhuma jornada encontrada</p>
              <p style="color: #999;">N√£o h√° solu√ß√µes cadastradas no sistema</p>
            </div>
          `;
          return;
        }
        
        // Adicionar √≠ndices para uso no modal de detalhes
        todasSolucoes = todasSolucoes.map((sol, idx) => ({ ...sol, __index: idx }));
        
        // Armazenar globalmente para uso no modal
        todasJornadasData = todasSolucoes;
        
        // Renderizar usando a mesma fun√ß√£o renderResultados
        renderTodasJornadas(todasSolucoes, container);
      } catch (error) {
        console.error('Erro ao carregar jornadas:', error);
        container.innerHTML = `
          <div class="text-center py-12">
            <p class="text-xl font-semibold mb-3 text-red-600">Erro ao carregar jornadas</p>
            <p style="color: #999;">${error.message || 'Erro desconhecido'}</p>
          </div>
        `;
      }
    }

    function renderTodasJornadas(assessorias, container) {
      // Agrupar solu√ß√µes por: Porte > Dor > Momento Empresarial > Ordem (Assessoria)
      // Cada dor ter√° seu pr√≥prio fluxograma de assessorias
      // Cada momento empresarial dentro de uma dor ter√° seu pr√≥prio container
      const solucoesPorPorte = {};
      
      assessorias.forEach((assessoria, index) => {
        const porte = assessoria.porte || 'Sem Porte';
        const dor = (assessoria.crescimento_empresarial && String(assessoria.crescimento_empresarial).trim() !== '') 
          ? String(assessoria.crescimento_empresarial).trim() 
          : 'Nenhuma';
        const momento = assessoria.momento_empresarial || 'Sem Momento';
        const ordem = assessoria.ordem || 1;
        
        if (!solucoesPorPorte[porte]) {
          solucoesPorPorte[porte] = {};
        }
        if (!solucoesPorPorte[porte][dor]) {
          solucoesPorPorte[porte][dor] = {};
        }
        if (!solucoesPorPorte[porte][dor][momento]) {
          solucoesPorPorte[porte][dor][momento] = {};
        }
        if (!solucoesPorPorte[porte][dor][momento][ordem]) {
          solucoesPorPorte[porte][dor][momento][ordem] = [];
        }
        solucoesPorPorte[porte][dor][momento][ordem].push({ ...assessoria, __index: index });
      });
      
      // Mapear nomes de dor para exibi√ß√£o
      const nomesDor = {
        'Marketing e Vendas': 'üì¢ Marketing e Vendas',
        'Marketing e vendas': 'üì¢ Marketing e Vendas',
        'marketing e vendas': 'üì¢ Marketing e Vendas',
        'Financas': 'üí∞ Finan√ßas',
        'Finan√ßas': 'üí∞ Finan√ßas',
        'financas': 'üí∞ Finan√ßas',
        'Planejamento': 'üéØ Planejamento',
        'planejamento': 'üéØ Planejamento',
        'Pessoas': 'üë• Pessoas',
        'pessoas': 'üë• Pessoas',
        'Operacoes': '‚öôÔ∏è Opera√ß√µes',
        'Opera√ß√µes': '‚öôÔ∏è Opera√ß√µes',
        'operacoes': '‚öôÔ∏è Opera√ß√µes',
        'Nenhuma': '‚ú® Sem dor espec√≠fica',
        'nenhuma': '‚ú® Sem dor espec√≠fica'
      };
      
      // Mapear cores para cada dor
      const coresDor = {
        'Marketing e Vendas': { 
          primaria: '#FF6B35', 
          secundaria: '#FF8C5A',
          gradiente: 'linear-gradient(90deg, #FF6B35 0%, #FF8C5A 100%)',
          badgeGradiente: 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)'
        },
        'Marketing e vendas': { 
          primaria: '#FF6B35', 
          secundaria: '#FF8C5A',
          gradiente: 'linear-gradient(90deg, #FF6B35 0%, #FF8C5A 100%)',
          badgeGradiente: 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)'
        },
        'marketing e vendas': { 
          primaria: '#FF6B35', 
          secundaria: '#FF8C5A',
          gradiente: 'linear-gradient(90deg, #FF6B35 0%, #FF8C5A 100%)',
          badgeGradiente: 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)'
        },
        'Financas': { 
          primaria: '#00A859', 
          secundaria: '#00C96B',
          gradiente: 'linear-gradient(90deg, #00A859 0%, #00C96B 100%)',
          badgeGradiente: 'linear-gradient(135deg, #00A859 0%, #00C96B 100%)'
        },
        'Finan√ßas': { 
          primaria: '#00A859', 
          secundaria: '#00C96B',
          gradiente: 'linear-gradient(90deg, #00A859 0%, #00C96B 100%)',
          badgeGradiente: 'linear-gradient(135deg, #00A859 0%, #00C96B 100%)'
        },
        'financas': { 
          primaria: '#00A859', 
          secundaria: '#00C96B',
          gradiente: 'linear-gradient(90deg, #00A859 0%, #00C96B 100%)',
          badgeGradiente: 'linear-gradient(135deg, #00A859 0%, #00C96B 100%)'
        },
        'Planejamento': { 
          primaria: '#0066CC', 
          secundaria: '#0080FF',
          gradiente: 'linear-gradient(90deg, #0066CC 0%, #0080FF 100%)',
          badgeGradiente: 'linear-gradient(135deg, #0066CC 0%, #0080FF 100%)'
        },
        'planejamento': { 
          primaria: '#0066CC', 
          secundaria: '#0080FF',
          gradiente: 'linear-gradient(90deg, #0066CC 0%, #0080FF 100%)',
          badgeGradiente: 'linear-gradient(135deg, #0066CC 0%, #0080FF 100%)'
        },
        'Pessoas': { 
          primaria: '#9B59B6', 
          secundaria: '#BB6BD9',
          gradiente: 'linear-gradient(90deg, #9B59B6 0%, #BB6BD9 100%)',
          badgeGradiente: 'linear-gradient(135deg, #9B59B6 0%, #BB6BD9 100%)'
        },
        'pessoas': { 
          primaria: '#9B59B6', 
          secundaria: '#BB6BD9',
          gradiente: 'linear-gradient(90deg, #9B59B6 0%, #BB6BD9 100%)',
          badgeGradiente: 'linear-gradient(135deg, #9B59B6 0%, #BB6BD9 100%)'
        },
        'Operacoes': { 
          primaria: '#2BB29D', 
          secundaria: '#3DD4B8',
          gradiente: 'linear-gradient(90deg, #2BB29D 0%, #3DD4B8 100%)',
          badgeGradiente: 'linear-gradient(135deg, #2BB29D 0%, #3DD4B8 100%)'
        },
        'Opera√ß√µes': { 
          primaria: '#2BB29D', 
          secundaria: '#3DD4B8',
          gradiente: 'linear-gradient(90deg, #2BB29D 0%, #3DD4B8 100%)',
          badgeGradiente: 'linear-gradient(135deg, #2BB29D 0%, #3DD4B8 100%)'
        },
        'operacoes': { 
          primaria: '#2BB29D', 
          secundaria: '#3DD4B8',
          gradiente: 'linear-gradient(90deg, #2BB29D 0%, #3DD4B8 100%)',
          badgeGradiente: 'linear-gradient(135deg, #2BB29D 0%, #3DD4B8 100%)'
        }
      };
      
      // Fun√ß√£o para obter cor da dor (com fallback para laranja padr√£o)
      const obterCorDor = (dor) => {
        return coresDor[dor] || {
          primaria: '#FF6B35',
          secundaria: '#FF8C5A',
          gradiente: 'linear-gradient(90deg, #FF6B35 0%, #FF8C5A 100%)',
          badgeGradiente: 'linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%)'
        };
      };
      
      // Mapeamento de cores e nomes para momentos empresariais
      const momentosInfo = {
        'Gerencie': { nome: 'Gerencie', cor: '#FF6B35', emoji: 'üìä' },
        'Planeje': { nome: 'Planeje', cor: '#2BB29D', emoji: 'üìã' },
        'Organize': { nome: 'Organize', cor: '#FF6B35', emoji: 'üóÇÔ∏è' },
        'Lidere': { nome: 'Lidere', cor: '#0066CC', emoji: 'üëî' },
        'Potencialize': { nome: 'Potencialize', cor: '#FF6B35', emoji: '‚ö°' },
        'Sem Momento': { nome: 'Sem Momento', cor: '#00608B', emoji: '‚ùì' }
      };
      
      // Mapeamento de nomes para portes
      const portesInfo = {
        'MEI': { nome: 'MEI - Microempreendedor Individual', emoji: 'üë§' },
        'ME': { nome: 'ME - Microempresa', emoji: 'üë•' },
        'EPP': { nome: 'EPP - Empresa de Pequeno Porte', emoji: 'üè¢' },
        'Sem Porte': { nome: '‚ùì Sem Porte', emoji: '‚ùì' }
      };
      
      const coresMomentoEmpresarial = {
        'Gerencie': { bg: '#FF6B35', color: '#FFFFFF', border: '#FF6B35' },
        'Planeje': { bg: '#2BB29D', color: '#FFFFFF', border: '#2BB29D' },
        'Organize': { bg: '#FF6B35', color: '#FFFFFF', border: '#FF6B35' },
        'Lidere': { bg: '#0066CC', color: '#FFFFFF', border: '#0066CC' },
        'Potencialize': { bg: '#FF6B35', color: '#FFFFFF', border: '#FF6B35' }
      };
      
      const inst = (a) => (a.instrumento && String(a.instrumento).trim()) ? a.instrumento : 'Solu√ß√£o';
      
      // Ordenar portes
      const ordemPortes = ['MEI', 'ME', 'EPP'];
      const portesOrdenados = Object.keys(solucoesPorPorte).sort((a, b) => {
        const idxA = ordemPortes.indexOf(a);
        const idxB = ordemPortes.indexOf(b);
        if (idxA === -1 && idxB === -1) return a.localeCompare(b);
        if (idxA === -1) return 1;
        if (idxB === -1) return -1;
        return idxA - idxB;
      });
      
      // Ordenar momentos (usar ordem espec√≠fica)
      const ordemMomentos = ['Gerencie', 'Planeje', 'Organize', 'Lidere', 'Potencialize'];
      const ordenarMomentos = (momentos) => {
        return Object.keys(momentos).sort((a, b) => {
          const idxA = ordemMomentos.indexOf(a);
          const idxB = ordemMomentos.indexOf(b);
          if (idxA === -1 && idxB === -1) return a.localeCompare(b);
          if (idxA === -1) return 1;
          if (idxB === -1) return -1;
          return idxA - idxB;
        });
      };
      
      // Renderizar containers separados para cada Momento Empresarial
      // Cada momento ter√° seu pr√≥prio container independente, como na imagem
      const html = portesOrdenados.map((porte, porteIndex) => {
        const infoPorte = portesInfo[porte] || portesInfo['Sem Porte'];
        const solucoesPorDor = solucoesPorPorte[porte];
        
        // Coletar todos os momentos √∫nicos de todas as dores deste porte
        const todosMomentos = new Set();
        Object.keys(solucoesPorDor).forEach(dor => {
          Object.keys(solucoesPorDor[dor]).forEach(momento => {
            todosMomentos.add(momento);
          });
        });
        
        const momentosOrdenados = ordenarMomentos(Array.from(todosMomentos).reduce((acc, m) => {
          acc[m] = {};
          return acc;
        }, {}));
        
        return `
          <div class="mb-12 fade-in" style="animation-delay: ${porteIndex * 0.1}s;">
            <!-- Header do Porte -->
            <div class="mb-6">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-3xl">${infoPorte.emoji}</span>
                <h2 class="text-2xl md:text-3xl font-bold" style="color: #00608B;">
                  ${infoPorte.nome}
                </h2>
              </div>
            </div>
            
            <!-- Containers separados para cada Momento Empresarial -->
            <div class="space-y-6">
              ${momentosOrdenados.map((momento, momentoIndex) => {
                const infoMomento = momentosInfo[momento] || momentosInfo['Sem Momento'];
                
                // Agrupar solu√ß√µes por dor dentro deste momento (mantendo estrutura de dor)
                const solucoesPorDorNoMomento = {};
                Object.keys(solucoesPorDor).forEach(dor => {
                  if (solucoesPorDor[dor][momento]) {
                    Object.keys(solucoesPorDor[dor][momento]).forEach(ordem => {
                      if (!solucoesPorDorNoMomento[dor]) {
                        solucoesPorDorNoMomento[dor] = {};
                      }
                      if (!solucoesPorDorNoMomento[dor][ordem]) {
                        solucoesPorDorNoMomento[dor][ordem] = [];
                      }
                      solucoesPorDorNoMomento[dor][ordem].push(...solucoesPorDor[dor][momento][ordem]);
                    });
                  }
                });
                
                // Verificar se h√° solu√ß√µes neste momento
                const todasOrdens = new Set();
                Object.keys(solucoesPorDorNoMomento).forEach(dor => {
                  Object.keys(solucoesPorDorNoMomento[dor]).forEach(ordem => {
                    todasOrdens.add(ordem);
                  });
                });
                
                if (todasOrdens.size === 0) return '';
                
                // Ordenar dores (colocar "Nenhuma" por √∫ltimo)
                const doresOrdenadasNoMomento = Object.keys(solucoesPorDorNoMomento)
                  .filter(dor => dor !== 'Nenhuma' && dor !== 'nenhuma')
                  .sort()
                  .concat(Object.keys(solucoesPorDorNoMomento).filter(dor => dor === 'Nenhuma' || dor === 'nenhuma'));
                
                return `
                  <div class="bg-white rounded-xl shadow-lg border-2 p-4 md:p-6 mb-6 fade-in" style="border-color: ${infoMomento.cor}; animation-delay: ${momentoIndex * 0.1}s;">
                    <!-- Banner do Momento Empresarial -->
                    <div class="mb-4 md:mb-6 fade-in" style="animation-delay: ${momentoIndex * 0.1}s;">
                      <div class="inline-flex items-center px-4 py-3 md:px-8 md:py-4 rounded-xl shadow-lg w-full sm:w-auto" style="background: linear-gradient(135deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);">
                        <span class="text-lg md:text-xl font-bold text-white text-center sm:text-left" style="font-family: 'Montserrat', sans-serif; letter-spacing: 0.5px;">${infoMomento.nome}</span>
                      </div>
                    </div>
                    
                    ${doresOrdenadasNoMomento.map((dor, dorIndex) => {
                      const nomeDor = nomesDor[dor] || dor;
                      const isSemDor = dor === 'Nenhuma' || dor === 'nenhuma' || !dor || dor.trim() === '';
                      const solucoesPorOrdemNaDor = solucoesPorDorNoMomento[dor];
                      const ordensOrdenadasNaDor = Object.keys(solucoesPorOrdemNaDor).map(Number).sort((a, b) => a - b);
                      const corDor = obterCorDor(dor);
                      
                      return `
                        <!-- Container da Dor -->
                        <div class="mb-8 ${dorIndex > 0 ? 'mt-8' : ''}">
                          <!-- Nome da Dor - Banner acima dos fluxos -->
                          ${!isSemDor ? `
                          <div class="mb-4 md:mb-6 fade-in" style="animation-delay: ${dorIndex * 0.1}s;">
                            <div class="inline-flex items-center px-4 py-3 md:px-8 md:py-4 rounded-xl shadow-lg w-full sm:w-auto" style="background: ${corDor.badgeGradiente};">
                              <span class="text-lg md:text-xl font-bold text-white text-center sm:text-left" style="font-family: 'Montserrat', sans-serif; letter-spacing: 0.5px;">${nomeDor.replace(/^[üì¢üí∞üéØüë•‚öôÔ∏è‚ú®]\s*/, '')}</span>
                            </div>
                          </div>
                          ` : ''}
                          
                          <!-- Fluxograma de Assessorias para esta Dor -->
                          <div class="trilha-fluxograma" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 1.5rem; padding: 1rem 0.5rem; min-height: 300px;">
                            ${ordensOrdenadasNaDor.map((ordem, ordemIndex) => {
                            const solucoes = solucoesPorOrdemNaDor[ordem];
                            const isLast = ordemIndex === ordensOrdenadasNaDor.length - 1;
                        
                        return `
                          <div class="trilha-step fade-in" style="animation-delay: ${ordemIndex * 0.2}s;">
                            ${!isLast ? `<div class="trilha-step-divider" style="background: linear-gradient(180deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);"></div>` : ''}
                            
                            <!-- Chevron ASSESSORIA -->
                            <div class="trilha-assessoria-chevron" style="background: linear-gradient(135deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%); --chevron-color: ${infoMomento.cor};">
                              <div class="trilha-assessoria-text">ASSESSORIA ${ordem}</div>
                            </div>
                            
                            <!-- Linha tracejada e hex√°gono -->
                            <div class="trilha-dashed-line"></div>
                            <div class="trilha-hexagon" style="background: linear-gradient(135deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);"></div>
                            
                            <div class="trilha-step-content">
                              <div class="trilha-dor-solucoes">
                                ${solucoes
                                  .sort((a, b) => {
                                    // Ordenar por valor: maior para menor
                                    const valorA = (a.valor != null && a.valor !== '') ? Number(a.valor) : 0;
                                    const valorB = (b.valor != null && b.valor !== '') ? Number(b.valor) : 0;
                                    return valorB - valorA; // Ordem decrescente (maior para menor)
                                  })
                                  .map((assessoria, solIndex) => {
                                  const instrumento = inst(assessoria);
                                  const v = assessoria.valor;
                                  const n = (v != null && v !== '') ? Number(v) : NaN;
                                  const temValor = !isNaN(n) && n > 0;
                                  const valorTexto = temValor ? ('R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })) : 'Gratuito';
                                  const valorBadgeColor = temValor ? '#B45309' : '#00A859';
                                  const valorBadgeBg = temValor ? '#FFEDD5' : '#E8F7F0';
                                  
                                  return `
                                    <div onclick="abrirDetalheSolucaoJornadas(${assessoria.__index})" class="trilha-solucao-card card-clicavel p-4 mb-3 fade-in" style="animation-delay: ${(ordemIndex * 0.2) + (solIndex * 0.1)}s; --card-hexagon-color: ${infoMomento.cor};">
                                      <!-- Destaque: Pre√ßo e Tipo de Produto -->
                                      <div class="flex items-center justify-between mb-3 p-2 rounded-lg" style="background: linear-gradient(135deg, #E3ECEE 0%, #A0C5CF 100%); border: 2px solid ${infoMomento.cor};">
                                        <div class="flex-1">
                                          <p class="text-xs font-semibold mb-1" style="color: #00608B;">Tipo de Produto</p>
                                          <p class="text-sm font-bold" style="color: #00608B;">${instrumento}</p>
                                        </div>
                                        <div class="text-right ml-2">
                                          <p class="text-xs font-semibold mb-1" style="color: #00608B;">Pre√ßo</p>
                                          <span class="inline-block px-2 py-1 rounded-lg font-bold text-sm" style="background-color: ${valorBadgeBg}; color: ${valorBadgeColor};">
                                            ${valorTexto}
                                          </span>
                                        </div>
                                      </div>
                                      
                                      <h5 class="text-sm font-bold mb-2" style="color: #1F2937;">${assessoria.assessoria_nome}</h5>
                                      <p class="text-xs leading-relaxed line-clamp-2 mb-2" style="color: #4B5563;">${assessoria.assessoria_descricao || ''}</p>
                                      ${assessoria.proxima_data ? `<p class="text-xs mb-1" style="color: #6B7280;">üìÖ <strong>${assessoria.proxima_data}</strong></p>` : ''}
                                    </div>
                                  `;
                                }).join('')}
                              </div>
                            </div>
                          </div>
                          ${!isLast ? `
                          <div class="trilha-connector">
                            <div class="trilha-connector-line" style="background: linear-gradient(90deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);"></div>
                            <div class="trilha-connector-hexagon" style="background: linear-gradient(135deg, ${infoMomento.cor} 0%, ${infoMomento.cor}dd 100%);"></div>
                          </div>
                          ` : ''}
                        `;
                      }).join('')}
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                `;
              }).filter(html => html !== '').join('')}
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }

    function abrirDetalheSolucaoJornadas(index) {
      const a = todasJornadasData[index];
      if (!a) return;
      const modal = document.getElementById('modal-detalhe-solucao');
      document.getElementById('detalhe-titulo').textContent = a.assessoria_nome;
      document.getElementById('detalhe-descricao').textContent = a.assessoria_descricao || '';
      document.getElementById('detalhe-proxima-data').textContent = (a.proxima_data && String(a.proxima_data).trim()) ? a.proxima_data : 'A definir';
      
      // Adicionar Carga Hor√°ria e √Årea de Conhecimento
      const cargaAreaContainer = document.getElementById('detalhe-carga-horaria-area');
      const temCargaHoraria = a.carga_horaria && String(a.carga_horaria).trim();
      const temAreaConhecimento = a.area_conhecimento && String(a.area_conhecimento).trim();
      
      if (temCargaHoraria || temAreaConhecimento) {
        cargaAreaContainer.style.display = 'grid';
        cargaAreaContainer.innerHTML = `
          ${temCargaHoraria ? `
            <div class="p-3 rounded-xl border-2" style="background: #EFF6FF; border-color: #3B82F6; word-wrap: break-word; overflow-wrap: break-word;">
              <p class="text-xs font-semibold mb-1" style="color: #1E40AF;">Carga Hor√°ria</p>
              <p class="text-sm font-bold" style="color: #1E40AF; word-wrap: break-word; overflow-wrap: break-word;">${a.carga_horaria}</p>
            </div>
          ` : ''}
          ${temAreaConhecimento ? `
            <div class="p-3 rounded-xl border-2" style="background: #F0FDF4; border-color: #10B981; word-wrap: break-word; overflow-wrap: break-word;">
              <p class="text-xs font-semibold mb-1" style="color: #065F46;">√Årea de Conhecimento</p>
              <p class="text-sm font-bold" style="color: #065F46; word-wrap: break-word; overflow-wrap: break-word;">${a.area_conhecimento}</p>
            </div>
          ` : ''}
        `;
      } else {
        cargaAreaContainer.style.display = 'none';
        cargaAreaContainer.innerHTML = '';
      }
      
      const badges = document.getElementById('detalhe-badges');
      badges.innerHTML = [
        ['Porte', a.porte, '#E8F7F0', '#00A859'],
        ['Setor', a.setor, '#FFF4E6', '#FF8C00'],
        ['Valor', (a.valor != null && Number(a.valor) > 0) ? ('R$ ' + Number(a.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })) : 'Gratuito', '#E8F7F0', '#00A859']
      ].map(([l, v, bg, c]) => `<span class="badge" style="background-color:${bg};color:${c};word-break: break-word;white-space: normal;max-width: 100%;">${l}: ${v}</span>`).join('');
      
      const botoesContainer = document.getElementById('detalhe-botoes');
      if (a.link_direcionamento) {
        botoesContainer.innerHTML = `
          <a href="${a.link_direcionamento}" target="_blank" rel="noopener noreferrer" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 font-semibold rounded-xl text-center transition-all" style="color: #333; text-decoration: none;">Saiba Mais</a>
          <button type="button" onclick="fecharDetalheSolucao()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 font-semibold rounded-xl" style="color: #333;">Fechar</button>
        `;
      } else {
        botoesContainer.innerHTML = `
          <button type="button" onclick="fecharDetalheSolucao()" class="w-full py-3 bg-gray-100 hover:bg-gray-200 font-semibold rounded-xl" style="color: #333;">Fechar</button>
        `;
      }
      
      modal.classList.remove('hidden');
    }

    function abrirDetalheSolucao(index) {
      const a = ultimosResultados[index];
      if (!a) return;
      const modal = document.getElementById('modal-detalhe-solucao');
      document.getElementById('detalhe-titulo').textContent = a.assessoria_nome;
      document.getElementById('detalhe-descricao').textContent = a.assessoria_descricao || '';
      document.getElementById('detalhe-proxima-data').textContent = (a.proxima_data && String(a.proxima_data).trim()) ? a.proxima_data : 'A definir';
      
      // Adicionar Carga Hor√°ria e √Årea de Conhecimento
      const cargaAreaContainer = document.getElementById('detalhe-carga-horaria-area');
      const temCargaHoraria = a.carga_horaria && String(a.carga_horaria).trim();
      const temAreaConhecimento = a.area_conhecimento && String(a.area_conhecimento).trim();
      
      if (temCargaHoraria || temAreaConhecimento) {
        cargaAreaContainer.style.display = 'grid';
        cargaAreaContainer.innerHTML = `
          ${temCargaHoraria ? `
            <div class="p-3 rounded-xl border-2" style="background: #EFF6FF; border-color: #3B82F6; word-wrap: break-word; overflow-wrap: break-word;">
              <p class="text-xs font-semibold mb-1" style="color: #1E40AF;">Carga Hor√°ria</p>
              <p class="text-sm font-bold" style="color: #1E40AF; word-wrap: break-word; overflow-wrap: break-word;">${a.carga_horaria}</p>
            </div>
          ` : ''}
          ${temAreaConhecimento ? `
            <div class="p-3 rounded-xl border-2" style="background: #F0FDF4; border-color: #10B981; word-wrap: break-word; overflow-wrap: break-word;">
              <p class="text-xs font-semibold mb-1" style="color: #065F46;">√Årea de Conhecimento</p>
              <p class="text-sm font-bold" style="color: #065F46; word-wrap: break-word; overflow-wrap: break-word;">${a.area_conhecimento}</p>
            </div>
          ` : ''}
        `;
      } else {
        cargaAreaContainer.style.display = 'none';
        cargaAreaContainer.innerHTML = '';
      }
      
      const badges = document.getElementById('detalhe-badges');
      badges.innerHTML = [
        ['Porte', a.porte, '#E8F7F0', '#00A859'],
        ['Setor', a.setor, '#FFF4E6', '#FF8C00'],
        ['Valor', (a.valor != null && Number(a.valor) > 0) ? ('R$ ' + Number(a.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })) : 'Gratuito', '#E8F7F0', '#00A859']
      ].map(([l, v, bg, c]) => `<span class="badge" style="background-color:${bg};color:${c};word-break: break-word;white-space: normal;max-width: 100%;">${l}: ${v}</span>`).join('');
      
      // Atualizar bot√µes do modal
      const botoesContainer = document.getElementById('detalhe-botoes');
      if (a.link_direcionamento) {
        botoesContainer.innerHTML = `
          <a href="${a.link_direcionamento}" target="_blank" rel="noopener noreferrer" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 font-semibold rounded-xl text-center transition-all" style="color: #333; text-decoration: none;">Saiba Mais</a>
          <button type="button" onclick="fecharDetalheSolucao()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 font-semibold rounded-xl" style="color: #333;">Fechar</button>
        `;
      } else {
        botoesContainer.innerHTML = `
          <button type="button" onclick="fecharDetalheSolucao()" class="w-full py-3 bg-gray-100 hover:bg-gray-200 font-semibold rounded-xl" style="color: #333;">Fechar</button>
        `;
      }
      
      modal.classList.remove('hidden');
    }

    function fecharDetalheSolucao() {
      document.getElementById('modal-detalhe-solucao').classList.add('hidden');
    }

    // Fun√ß√£o para alternar sele√ß√£o de solu√ß√£o
    function toggleSelecaoSolucao(solucaoId, index, event) {
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }
      
      if (solucoesSelecionadas.has(solucaoId)) {
        solucoesSelecionadas.delete(solucaoId);
      } else {
        solucoesSelecionadas.add(solucaoId);
      }
      
      atualizarContadorSelecionadas();
      atualizarVisualSelecao(solucaoId);
      
      // Re-renderizar resultados para atualizar os bot√µes
      if (ultimosResultados.length > 0) {
        renderResultados(ultimosResultados);
      }
      
      // Atualizar badge do bot√£o flutuante
      atualizarBadgeBotaoFlutuante();
      
      // Atualizar painel (carrinho) - sempre atualizar, mesmo se n√£o estiver vis√≠vel
      // Isso garante que o modal de relat√≥rio seja atualizado automaticamente
      atualizarPreviewSelecionadas();
      
      // Se o painel estiver aberto, atualizar tamb√©m a lista de dispon√≠veis
      const painel = document.getElementById('painel-selecao-relatorio');
      if (painel && !painel.classList.contains('hidden')) {
        renderizarListaDisponiveisPainel();
      }
    }

    // Fun√ß√£o para atualizar o contador de solu√ß√µes selecionadas
    function atualizarContadorSelecionadas() {
      // Fun√ß√£o mantida para compatibilidade, mas n√£o √© mais necess√°ria
      // pois o modal gerencia sua pr√≥pria sele√ß√£o
    }

    // Fun√ß√£o para atualizar o visual do card quando selecionado
    function atualizarVisualSelecao(solucaoId) {
      // Esta fun√ß√£o n√£o √© mais necess√°ria pois o visual √© atualizado via re-renderiza√ß√£o
      // Mantida para compatibilidade
    }

    // Fun√ß√£o para selecionar todas as solu√ß√µes
    function selecionarTodasSolucoes() {
      ultimosResultados.forEach((sol, index) => {
        const solucaoId = sol.id || `sol_${index}`;
        solucoesSelecionadas.add(solucaoId);
      });
      atualizarContadorSelecionadas();
      // Re-renderizar para atualizar os bot√µes
      if (ultimosResultados.length > 0) {
        renderResultados(ultimosResultados);
      }
      
      // Atualizar badge do bot√£o flutuante
      atualizarBadgeBotaoFlutuante();
      
      // Atualizar preview (que automaticamente abre/atualiza o modal)
      atualizarPreviewSelecionadas();
      
      // Se o painel estiver aberto, atualizar tamb√©m a lista de dispon√≠veis
      const painel = document.getElementById('painel-selecao-relatorio');
      if (painel && !painel.classList.contains('hidden')) {
        renderizarListaDisponiveisPainel();
      }
    }

    // Fun√ß√£o para desselecionar todas as solu√ß√µes
    function desselecionarTodasSolucoes() {
      solucoesSelecionadas.clear();
      atualizarContadorSelecionadas();
      // Re-renderizar para atualizar os bot√µes
      if (ultimosResultados.length > 0) {
        renderResultados(ultimosResultados);
      }
      
      // Atualizar badge do bot√£o flutuante
      atualizarBadgeBotaoFlutuante();
      
      // Atualizar preview (que automaticamente fecha o modal se n√£o houver sele√ß√µes)
      atualizarPreviewSelecionadas();
      
      // Se o painel estiver aberto, atualizar tamb√©m a lista de dispon√≠veis
      const painel = document.getElementById('painel-selecao-relatorio');
      if (painel && !painel.classList.contains('hidden')) {
        renderizarListaDisponiveisPainel();
      }
    }

    // Fun√ß√£o auxiliar para ordenar solu√ß√µes (reutiliz√°vel)
    // Ordena por: 1) Data (mais pr√≥xima de hoje primeiro), 2) Valor (menor primeiro) se n√£o houver data
    function ordenarSolucoes(solucoes) {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      
      return [...solucoes].sort((a, b) => {
        // Primeiro crit√©rio: DATA (mais pr√≥xima de hoje primeiro)
        const dataAStr = a.proxima_data || null;
        const dataBStr = b.proxima_data || null;
        
        let dataA = null;
        let dataB = null;
        
        if (dataAStr) {
          try {
            // Tentar parsear formato DD/MM/YYYY primeiro
            const partesBR = String(dataAStr).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (partesBR) {
              dataA = new Date(parseInt(partesBR[3]), parseInt(partesBR[2]) - 1, parseInt(partesBR[1]));
            } else {
              dataA = new Date(dataAStr);
            }
            dataA.setHours(0, 0, 0, 0);
            if (isNaN(dataA.getTime())) dataA = null;
          } catch (e) {
            dataA = null;
          }
        }
        
        if (dataBStr) {
          try {
            // Tentar parsear formato DD/MM/YYYY primeiro
            const partesBR = String(dataBStr).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (partesBR) {
              dataB = new Date(parseInt(partesBR[3]), parseInt(partesBR[2]) - 1, parseInt(partesBR[1]));
            } else {
              dataB = new Date(dataBStr);
            }
            dataB.setHours(0, 0, 0, 0);
            if (isNaN(dataB.getTime())) dataB = null;
          } catch (e) {
            dataB = null;
          }
        }
        
        // Se ambas t√™m data, ordenar pela mais pr√≥xima de hoje
        if (dataA && dataB) {
          // Calcular diferen√ßa absoluta em dias de hoje
          const diffA = Math.abs(dataA - hoje);
          const diffB = Math.abs(dataB - hoje);
          
          // A mais pr√≥xima vem primeiro
          return diffA - diffB;
        }
        
        // Se apenas uma tem data, ela vem primeiro
        if (dataA && !dataB) return -1;
        if (!dataA && dataB) return 1;
        
        // Se nenhuma tem data, ordenar por VALOR (menor primeiro)
        const valorA = (a.valor != null && a.valor !== '') ? Number(a.valor) : 999999;
        const valorB = (b.valor != null && b.valor !== '') ? Number(b.valor) : 999999;
        
        // Se ambos s√£o gratuitos (valor 0 ou null), manter ordem original
        if (valorA === 999999 && valorB === 999999) return 0;
        
        return valorA - valorB;
      });
    }

    // Fun√ß√£o para abrir/fechar painel de sele√ß√£o
    function togglePainelSelecaoRelatorio() {
      if (ultimosResultados.length === 0) {
        showToast('Nenhuma solu√ß√£o dispon√≠vel para sele√ß√£o', 'error');
        return;
      }

      // Criar painel se n√£o existir
      criarModalSelecaoRelatorio();
      
      const painel = document.getElementById('painel-selecao-relatorio');
      const overlay = document.getElementById('overlay-painel-relatorio');
      
      if (!painel || !overlay) return;
      
      const isAberto = !painel.classList.contains('translate-x-full');
      
      if (isAberto) {
        // Fechar
        painel.classList.add('translate-x-full');
        overlay.classList.add('hidden');
      } else {
        // Abrir
        painel.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');
        
        // Atualizar conte√∫do
        atualizarConteudoPainel();
      }
    }

    // Fun√ß√£o para abrir modal de sele√ß√£o de solu√ß√µes (mantida para compatibilidade)
    function abrirModalSelecaoRelatorio() {
      togglePainelSelecaoRelatorio();
    }

    // Fun√ß√£o para atualizar conte√∫do do painel
    function atualizarConteudoPainel() {
      // Atualizar total de solu√ß√µes
      const totalSolucoes = document.getElementById('total-solucoes-modal');
      if (totalSolucoes) {
        totalSolucoes.textContent = ultimosResultados.length;
      }
      
      // Renderizar lista de solu√ß√µes dispon√≠veis
      renderizarListaDisponiveisPainel();
      
      // Mostrar preview das selecionadas
      atualizarPreviewSelecionadas();
      
      // Atualizar badge do bot√£o flutuante
      atualizarBadgeBotaoFlutuante();
    }

    // Fun√ß√£o para renderizar lista de solu√ß√µes dispon√≠veis no painel
    function renderizarListaDisponiveisPainel() {
      const container = document.getElementById('lista-solucoes-disponiveis-painel');
      if (!container) return;

      const formatarData = (dataStr) => {
        if (!dataStr || String(dataStr).trim() === '') return 'A definir';
        try {
          // Tentar parsear data no formato DD/MM/YYYY primeiro (formato brasileiro comum)
          const partesBR = String(dataStr).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
          let data;
          if (partesBR) {
            // Formato brasileiro DD/MM/YYYY
            data = new Date(parseInt(partesBR[3]), parseInt(partesBR[2]) - 1, parseInt(partesBR[1]));
          } else {
            // Tentar formato ISO (YYYY-MM-DD) ou outros formatos
            data = new Date(dataStr);
          }
          
          // Verificar se a data √© v√°lida
          if (isNaN(data.getTime())) {
            return 'A definir';
          }
          
          // Verificar se a data n√£o √© muito antiga ou muito futura (indicando erro de parse)
          const ano = data.getFullYear();
          if (ano < 1900 || ano > 2100) {
            return 'A definir';
          }
          
          return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } catch {
          return 'A definir';
        }
      };

      const solucoesNaoSelecionadas = ultimosResultados.filter((sol, index) => {
        const solucaoId = sol.id || `sol_${index}`;
        return !solucoesSelecionadas.has(solucaoId);
      });

      if (solucoesNaoSelecionadas.length === 0) {
        container.innerHTML = '<p class="text-xs text-center py-4" style="color: #999;">Todas as solu√ß√µes j√° foram selecionadas</p>';
        return;
      }

      container.innerHTML = solucoesNaoSelecionadas.map((sol, idx) => {
        const index = ultimosResultados.findIndex(s => 
          (s.id && s.id === sol.id) || 
          (!s.id && !sol.id && s.assessoria_nome === sol.assessoria_nome)
        );
        const solucaoId = sol.id || `sol_${index}`;
        // Usar proxima_data diretamente da base
        const dataExibicao = sol.proxima_data || null;
        const dataFormatada = dataExibicao ? formatarData(dataExibicao) : 'A definir';
        const v = sol.valor;
        const n = (v != null && v !== '') ? Number(v) : NaN;
        const valorTexto = !isNaN(n) && n > 0 ? ('R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2 })) : 'Gratuito';
        
        return `
          <div class="bg-white rounded-lg p-3 border border-gray-200 hover:border-blue-400 transition-all cursor-pointer" 
               onclick="adicionarSolucaoAoPainel('${solucaoId}', ${index})">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h4 class="font-semibold text-sm mb-1" style="color: #1F2937;">${sol.assessoria_nome || 'Sem nome'}</h4>
                <div class="flex flex-wrap gap-1 text-xs mt-1">
                  <span class="px-2 py-0.5 rounded" style="background: #E8F7F0; color: #047857;">üìÖ ${dataFormatada}</span>
                  <span class="px-2 py-0.5 rounded" style="background: #FFF4E6; color: #B45309;">üí∞ ${valorTexto}</span>
                </div>
              </div>
              <button onclick="event.stopPropagation(); adicionarSolucaoAoPainel('${solucaoId}', ${index})" 
                      class="ml-2 text-green-600 hover:text-green-700 hover:bg-green-50 rounded-full p-1 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Fun√ß√£o para adicionar solu√ß√£o ao painel
    function adicionarSolucaoAoPainel(solucaoId, index) {
      solucoesSelecionadas.add(solucaoId);
      atualizarPreviewSelecionadas();
      renderizarListaDisponiveisPainel();
    }

    // Fun√ß√£o para toggle da se√ß√£o de adicionar
    function toggleSecaoAdicionar() {
      const secao = document.getElementById('secao-adicionar-solucoes');
      const icone = document.getElementById('icone-toggle-adicionar');
      if (secao && icone) {
        secao.classList.toggle('hidden');
        icone.textContent = secao.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
      }
    }

    // Fun√ß√£o para criar modal de sele√ß√£o
    function criarModalSelecaoRelatorio() {
      // Verificar se o bot√£o flutuante j√° existe
      if (document.getElementById('btn-abrir-painel-relatorio')) {
        return; // Bot√£o e painel j√° existem
      }

      // Criar bot√£o flutuante (inicialmente oculto)
      const botaoFlutuanteHTML = `
        <button id="btn-abrir-painel-relatorio" onclick="togglePainelSelecaoRelatorio()" 
                class="fixed bottom-6 right-6 z-40 w-16 h-16 rounded-full shadow-2xl flex items-center justify-center transition-all hover:scale-110 active:scale-95 hidden"
                style="background: linear-gradient(135deg, #00608B 0%, #6366F1 100%); color: white; display: none;"
                title="Ver solu√ß√µes selecionadas">
          <span class="text-2xl">üìä</span>
          <span id="badge-contador-painel" class="absolute -top-1 -right-1 min-w-[24px] h-6 rounded-full flex items-center justify-center text-xs font-bold hidden px-1" 
                style="background: #DC2626; color: white;">0</span>
        </button>
      `;

      // Criar painel lateral
      const painelHTML = `
        <!-- Overlay escuro -->
        <div id="overlay-painel-relatorio" onclick="togglePainelSelecaoRelatorio()" 
             class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden transition-opacity"></div>
        
        <!-- Painel lateral -->
        <div id="painel-selecao-relatorio" 
             class="fixed right-0 top-0 h-full w-full sm:w-[500px] md:w-[600px] lg:w-[700px] bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col"
             style="max-width: 95vw;">
          <!-- Header do painel -->
          <div class="p-6 border-b-2 flex items-center justify-between" style="background: linear-gradient(135deg, #00608B 0%, #0092BA 100%); border-color: #00608B;">
            <div class="flex items-center gap-3">
              <h2 class="text-xl md:text-2xl font-bold text-white">Selecionar Solu√ß√µes</h2>
              <span id="contador-painel-header" class="px-3 py-1 rounded-full text-sm font-bold bg-white" style="color: #00608B;">0</span>
            </div>
            <button onclick="togglePainelSelecaoRelatorio()" class="text-white hover:text-gray-200 text-2xl font-bold transition-all hover:scale-110">
              &times;
            </button>
          </div>
          
          <!-- Controles -->
          <div class="p-4 border-b-2 bg-gray-50" style="border-color: #E5E7EB;">
            <div class="flex items-center gap-2 flex-wrap mb-3">
              <button onclick="selecionarTodasNoModal()" class="px-3 py-2 rounded-lg font-semibold text-xs transition-all hover:scale-105" style="background: #E8F7F0; color: #00A859; border: 2px solid #00A859;">
                ‚úì Todas
              </button>
              <button onclick="desselecionarTodasNoModal()" class="px-3 py-2 rounded-lg font-semibold text-xs transition-all hover:scale-105" style="background: #FFF4E6; color: #FF8C00; border: 2px solid #FF8C00;">
                ‚úó Nenhuma
              </button>
              <span class="text-xs font-semibold ml-auto" style="color: #666;">
                <span id="contador-modal-selecao" style="color: #00608B; font-weight: bold;">0</span> de <span id="total-solucoes-modal">0</span>
              </span>
            </div>
            <p class="text-xs" style="color: #999;">Ordenadas por data (mais pr√≥xima primeiro) ou valor (menor primeiro)</p>
          </div>
          
          <!-- Conte√∫do scroll√°vel -->
          <div class="flex-1 overflow-y-auto p-4">
            <!-- Se√ß√£o de adicionar solu√ß√µes (colaps√°vel) -->
            <div class="mb-4">
              <button onclick="toggleSecaoAdicionar()" id="btn-toggle-adicionar" 
                      class="w-full p-3 rounded-lg font-semibold text-sm transition-all hover:bg-gray-100 flex items-center justify-between"
                      style="background: #F3F4F6; color: #00608B;">
                <span>‚ûï Adicionar Solu√ß√µes</span>
                <span id="icone-toggle-adicionar">‚ñº</span>
              </button>
              <div id="secao-adicionar-solucoes" class="hidden mt-3 max-h-[300px] overflow-y-auto space-y-2">
                <div id="lista-solucoes-disponiveis-painel">
                  <!-- Lista ser√° preenchida aqui -->
                </div>
              </div>
            </div>
            
            <!-- Preview das solu√ß√µes selecionadas -->
            <div>
              <h3 class="text-sm font-bold mb-3" style="color: #00608B;">Solu√ß√µes Selecionadas (Ordenadas)</h3>
              <div id="preview-selecionadas-modal" class="space-y-3">
                <p class="text-sm text-center py-8" style="color: #999;">Nenhuma solu√ß√£o selecionada</p>
              </div>
            </div>
          </div>
          
          <!-- Footer com bot√£o de a√ß√£o -->
          <div class="p-4 border-t-2 bg-gray-50" style="border-color: #E5E7EB;">
            <button onclick="confirmarSelecaoERelatorio()" id="btn-confirmar-selecao" 
                    class="w-full py-4 rounded-xl font-bold text-lg transition-all hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg" 
                    style="background: linear-gradient(135deg, #00608B 0%, #6366F1 100%); color: white;" disabled>
              üìä Gerar Relat√≥rio (<span id="contador-footer">0</span>)
            </button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', botaoFlutuanteHTML);
      document.body.insertAdjacentHTML('beforeend', painelHTML);
      
      // Inicializar badge do bot√£o flutuante
      atualizarBadgeBotaoFlutuante();
    }

    // Fun√ß√£o para renderizar lista de solu√ß√µes no modal (n√£o mais usada, mas mantida)
    function renderizarListaSelecaoModal(solucoes) {
      // Esta fun√ß√£o n√£o √© mais necess√°ria pois n√£o mostramos lista completa no painel
      // Apenas o preview das selecionadas
      return;

      const formatarData = (dataStr) => {
        if (!dataStr || String(dataStr).trim() === '') return 'A definir';
        try {
          // Tentar parsear data no formato DD/MM/YYYY primeiro (formato brasileiro comum)
          const partesBR = String(dataStr).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
          let data;
          if (partesBR) {
            // Formato brasileiro DD/MM/YYYY
            data = new Date(parseInt(partesBR[3]), parseInt(partesBR[2]) - 1, parseInt(partesBR[1]));
          } else {
            // Tentar formato ISO (YYYY-MM-DD) ou outros formatos
            data = new Date(dataStr);
          }
          
          // Verificar se a data √© v√°lida
          if (isNaN(data.getTime())) {
            return 'A definir';
          }
          
          // Verificar se a data n√£o √© muito antiga ou muito futura (indicando erro de parse)
          const ano = data.getFullYear();
          if (ano < 1900 || ano > 2100) {
            return 'A definir';
          }
          
          return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } catch {
          return 'A definir';
        }
      };

      container.innerHTML = solucoes.map((sol) => {
        // Encontrar √≠ndice original no ultimosResultados
        const indexOriginal = ultimosResultados.findIndex(s => 
          (s.id && s.id === sol.id) || 
          (!s.id && !sol.id && s.assessoria_nome === sol.assessoria_nome)
        );
        const index = indexOriginal >= 0 ? indexOriginal : sol.__index || 0;
        const solucaoId = sol.id || `sol_${index}`;
        const isSelected = solucoesSelecionadas.has(solucaoId);
        // Usar proxima_data diretamente da base
        const dataExibicao = sol.proxima_data || null;
        const dataFormatada = dataExibicao ? formatarData(dataExibicao) : 'A definir';
        const v = sol.valor;
        const n = (v != null && v !== '') ? Number(v) : NaN;
        const valorTexto = !isNaN(n) && n > 0 ? ('R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2 })) : 'Gratuito';
        
        return `
          <div class="bg-white rounded-lg p-4 border-2 transition-all hover:shadow-md cursor-pointer ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200'}" onclick="toggleSelecaoNoModal('${solucaoId}', ${index})">
            <div class="flex items-start gap-3">
              <input type="checkbox" 
                     id="modal-checkbox-${solucaoId}" 
                     class="w-5 h-5 mt-1 rounded cursor-pointer" 
                     style="accent-color: #00A859;"
                     ${isSelected ? 'checked' : ''}
                     onclick="event.stopPropagation(); toggleSelecaoNoModal('${solucaoId}', ${index})">
              <div class="flex-1">
                <h4 class="font-bold mb-1" style="color: #1F2937;">${sol.assessoria_nome || 'Sem nome'}</h4>
                <p class="text-xs mb-2 line-clamp-2" style="color: #666;">${sol.assessoria_descricao || 'Sem descri√ß√£o'}</p>
                <div class="flex flex-wrap gap-2 text-xs">
                  <span class="px-2 py-1 rounded" style="background: #E8F7F0; color: #047857;">üìÖ ${dataFormatada}</span>
                  <span class="px-2 py-1 rounded" style="background: #FFF4E6; color: #B45309;">üí∞ ${valorTexto}</span>
                  <span class="px-2 py-1 rounded" style="background: #E8F7F0; color: #047857;">üë§ ${sol.porte || 'N/A'}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Fun√ß√£o para atualizar preview das solu√ß√µes selecionadas
    function atualizarPreviewSelecionadas() {
      const preview = document.getElementById('preview-selecionadas-modal');
      const contador = document.getElementById('contador-modal-selecao');
      const btnConfirmar = document.getElementById('btn-confirmar-selecao');
      
      if (!preview) return;

      // Coletar solu√ß√µes selecionadas
      const solucoesSelecionadasArray = ultimosResultados.filter((sol, index) => {
        const solucaoId = sol.id || `sol_${index}`;
        return solucoesSelecionadas.has(solucaoId);
      });

      // Ordenar
      const solucoesOrdenadas = ordenarSolucoes(solucoesSelecionadasArray);

      // Atualizar contadores
      if (contador) {
        contador.textContent = solucoesSelecionadas.size;
      }
      
      const contadorHeader = document.getElementById('contador-painel-header');
      if (contadorHeader) {
        contadorHeader.textContent = solucoesSelecionadas.size;
      }
      
      const contadorFooter = document.getElementById('contador-footer');
      if (contadorFooter) {
        contadorFooter.textContent = solucoesSelecionadas.size;
      }

      // Atualizar bot√£o
      if (btnConfirmar) {
        btnConfirmar.disabled = solucoesSelecionadas.size === 0;
      }
      
      // Atualizar badge do bot√£o flutuante
      atualizarBadgeBotaoFlutuante();

      // Renderizar preview
      if (solucoesOrdenadas.length === 0) {
        preview.innerHTML = '<p class="text-sm text-center py-8" style="color: #999;">Nenhuma solu√ß√£o selecionada</p>';
        // Fechar modal de relat√≥rio se n√£o houver sele√ß√µes
        const modalRelatorio = document.getElementById('modal-relatorio');
        if (modalRelatorio && !modalRelatorio.classList.contains('hidden')) {
          fecharRelatorioModal();
        }
        return;
      }

      const formatarData = (dataStr) => {
        if (!dataStr || String(dataStr).trim() === '') return 'A definir';
        try {
          // Tentar parsear data no formato DD/MM/YYYY primeiro (formato brasileiro comum)
          const partesBR = String(dataStr).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
          let data;
          if (partesBR) {
            // Formato brasileiro DD/MM/YYYY
            data = new Date(parseInt(partesBR[3]), parseInt(partesBR[2]) - 1, parseInt(partesBR[1]));
          } else {
            // Tentar formato ISO (YYYY-MM-DD) ou outros formatos
            data = new Date(dataStr);
          }
          
          // Verificar se a data √© v√°lida
          if (isNaN(data.getTime())) {
            return 'A definir';
          }
          
          // Verificar se a data n√£o √© muito antiga ou muito futura (indicando erro de parse)
          const ano = data.getFullYear();
          if (ano < 1900 || ano > 2100) {
            return 'A definir';
          }
          
          return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } catch {
          return 'A definir';
        }
      };

      // Encontrar √≠ndice original para cada solu√ß√£o
      preview.innerHTML = solucoesOrdenadas.map((sol, index) => {
        const indexOriginal = ultimosResultados.findIndex(s => 
          (s.id && s.id === sol.id) || 
          (!s.id && !sol.id && s.assessoria_nome === sol.assessoria_nome)
        );
        const idx = indexOriginal >= 0 ? indexOriginal : sol.__index || 0;
        const solucaoId = sol.id || `sol_${idx}`;
        
        // Usar proxima_data diretamente da base
        const dataExibicao = sol.proxima_data || null;
        const dataFormatada = dataExibicao ? formatarData(dataExibicao) : 'A definir';
        const v = sol.valor;
        const n = (v != null && v !== '') ? Number(v) : NaN;
        const valorTexto = !isNaN(n) && n > 0 ? ('R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2 })) : 'Gratuito';
        
        return `
          <div class="bg-white rounded-lg p-4 border-l-4 shadow-sm hover:shadow-md transition-all" style="border-color: #00608B;">
            <div class="flex items-start justify-between mb-2">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-lg font-bold" style="color: #00608B;">${index + 1}.</span>
                  <h4 class="font-bold flex-1" style="color: #1F2937;">${sol.assessoria_nome || 'Sem nome'}</h4>
                </div>
                <p class="text-xs mb-2 line-clamp-2" style="color: #666;">${sol.assessoria_descricao || 'Sem descri√ß√£o'}</p>
              </div>
              <button onclick="removerSolucaoDoPainel('${solucaoId}', ${idx})" 
                      class="ml-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full p-1 transition-all" 
                      title="Remover">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <span class="px-2 py-1 rounded" style="background: #E8F7F0; color: #047857;">üìÖ ${dataFormatada}</span>
              <span class="px-2 py-1 rounded" style="background: #FFF4E6; color: #B45309;">üí∞ ${valorTexto}</span>
              <span class="px-2 py-1 rounded" style="background: #E8F7F0; color: #047857;">üë§ ${sol.porte || 'N/A'}</span>
              <span class="px-2 py-1 rounded" style="background: #FFF4E6; color: #B45309;">üè¢ ${sol.setor || 'N/A'}</span>
            </div>
          </div>
        `;
      }).join('');
      
      // Modal de relat√≥rio s√≥ abre ao clicar em "Gerar Relat√≥rio", n√£o ao selecionar solu√ß√µes
    }

    // Fun√ß√£o para alternar sele√ß√£o no modal (mantida para compatibilidade)
    function toggleSelecaoNoModal(solucaoId, index) {
      if (solucoesSelecionadas.has(solucaoId)) {
        solucoesSelecionadas.delete(solucaoId);
      } else {
        solucoesSelecionadas.add(solucaoId);
      }
      atualizarPreviewSelecionadas();
    }

    // Fun√ß√£o para remover solu√ß√£o do painel
    function removerSolucaoDoPainel(solucaoId, index) {
      solucoesSelecionadas.delete(solucaoId);
      atualizarPreviewSelecionadas();
    }

    // Fun√ß√£o para selecionar todas no modal
    function selecionarTodasNoModal() {
      ultimosResultados.forEach((sol, index) => {
        const solucaoId = sol.id || `sol_${index}`;
        solucoesSelecionadas.add(solucaoId);
      });
      atualizarPreviewSelecionadas();
    }

    // Fun√ß√£o para desselecionar todas no modal
    function desselecionarTodasNoModal() {
      solucoesSelecionadas.clear();
      atualizarPreviewSelecionadas();
    }

    // Fun√ß√£o para confirmar sele√ß√£o e gerar relat√≥rio
    function confirmarSelecaoERelatorio() {
      if (solucoesSelecionadas.size === 0) {
        showToast('Selecione pelo menos uma solu√ß√£o para gerar o relat√≥rio', 'error');
        return;
      }

      // Fechar painel de sele√ß√£o
      togglePainelSelecaoRelatorio();

      // Coletar solu√ß√µes selecionadas
      const solucoesRelatorio = ultimosResultados.filter((sol, index) => {
        const solucaoId = sol.id || `sol_${index}`;
        return solucoesSelecionadas.has(solucaoId);
      });

      // Ordenar
      const solucoesOrdenadas = ordenarSolucoes(solucoesRelatorio);

      // Exibir modal com relat√≥rio
      exibirRelatorioModal(solucoesOrdenadas);
    }

    // Fun√ß√£o para fechar modal de sele√ß√£o
    function fecharModalSelecaoRelatorio() {
      togglePainelSelecaoRelatorio();
    }

    // Fun√ß√£o para atualizar badge do bot√£o flutuante
    function atualizarBadgeBotaoFlutuante() {
      const badge = document.getElementById('badge-contador-painel');
      const botao = document.getElementById('btn-abrir-painel-relatorio');
      
      if (badge && botao) {
        if (solucoesSelecionadas.size > 0) {
          badge.textContent = solucoesSelecionadas.size;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }
    
    // Fun√ß√£o para mostrar bot√£o flutuante
    function mostrarBotaoFlutuante() {
      const botao = document.getElementById('btn-abrir-painel-relatorio');
      if (botao) {
        botao.style.setProperty('display', 'flex', 'important');
        botao.classList.remove('hidden');
      }
    }
    
    // Fun√ß√£o para ocultar bot√£o flutuante
    function ocultarBotaoFlutuante() {
      const botao = document.getElementById('btn-abrir-painel-relatorio');
      if (botao) {
        botao.style.setProperty('display', 'none', 'important');
        botao.classList.add('hidden');
      }
    }

    // Fun√ß√£o para gerar relat√≥rio com solu√ß√µes selecionadas ordenadas cronologicamente
    function gerarRelatorioSolucoes() {
      if (solucoesSelecionadas.size === 0) {
        showToast('Selecione pelo menos uma solu√ß√£o para gerar o relat√≥rio', 'error');
        return;
      }

      // Coletar todas as solu√ß√µes selecionadas
      const solucoesRelatorio = ultimosResultados.filter((sol, index) => {
        const solucaoId = sol.id || `sol_${index}`;
        return solucoesSelecionadas.has(solucaoId);
      });

      // Ordenar usando fun√ß√£o auxiliar
      const solucoesOrdenadas = ordenarSolucoes(solucoesRelatorio);

      // Exibir modal com relat√≥rio
      exibirRelatorioModal(solucoesOrdenadas);
    }

    // Fun√ß√£o para exibir modal com relat√≥rio formatado
    function exibirRelatorioModal(solucoes) {
      // Criar modal se n√£o existir
      let modal = document.getElementById('modal-relatorio');
      if (!modal) {
        criarModalRelatorio();
        // Buscar novamente ap√≥s criar
        modal = document.getElementById('modal-relatorio');
      }

      if (!modal) {
        console.error('Erro ao criar modal de relat√≥rio');
        return;
      }

      const conteudoRelatorio = document.getElementById('conteudo-relatorio');
      if (!conteudoRelatorio) {
        console.error('Erro: elemento conteudo-relatorio n√£o encontrado');
        return;
      }

      // Formatar data para exibi√ß√£o
      const formatarData = (dataStr) => {
        if (!dataStr || String(dataStr).trim() === '') return 'A definir';
        try {
          // Tentar parsear data no formato DD/MM/YYYY primeiro (formato brasileiro comum)
          const partesBR = String(dataStr).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
          let data;
          if (partesBR) {
            // Formato brasileiro DD/MM/YYYY
            data = new Date(parseInt(partesBR[3]), parseInt(partesBR[2]) - 1, parseInt(partesBR[1]));
          } else {
            // Tentar formato ISO (YYYY-MM-DD) ou outros formatos
            data = new Date(dataStr);
          }
          
          // Verificar se a data √© v√°lida
          if (isNaN(data.getTime())) {
            return 'A definir';
          }
          
          // Verificar se a data n√£o √© muito antiga ou muito futura (indicando erro de parse)
          const ano = data.getFullYear();
          if (ano < 1900 || ano > 2100) {
            return 'A definir';
          }
          
          return data.toLocaleDateString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric' 
          });
        } catch {
          return 'A definir';
        }
      };

      // Texto padr√£o do relat√≥rio
      const textoPadrao = `Ol√°, segue o Relat√≥rio:

Identificamos os pontos que j√° s√£o fortes e, principalmente, as oportunidades de crescimento que podem ser trabalhadas para aumentar a efici√™ncia e o faturamento da sua empresa.

Meu papel √© ser seu parceiro nesta jornada. este plano √© o mapa para transformarmos os desafios em resultados concretos com as Solu√ß√µes que temos aqui no Sebrae

O pr√≥ximo passo √© voc√™ me dar um "ok" sobre datas e organizarmos o calend√°rio das Etapas

Estou √† total disposi√ß√£o para conversarmos sobre este relat√≥rio, tirar qualquer d√∫vida e ajustarmos o que for necess√°rio.`;

      // Cor padr√£o para o fluxograma
      const corPadrao = '#00608B';
      
      // Gerar HTML do relat√≥rio com fluxograma
      const htmlRelatorio = `
        <!-- Texto padr√£o -->
        <div class="mb-8 p-6 rounded-xl bg-white border-l-4 shadow-md" style="border-color: ${corPadrao};">
          <div class="prose max-w-none">
            <p class="text-base leading-relaxed whitespace-pre-line" style="color: #333; font-family: 'Inter', sans-serif;">
              ${textoPadrao}
            </p>
          </div>
        </div>
        
        <!-- Fluxograma de Solu√ß√µes -->
        <div class="mb-6">
          <h3 class="text-xl font-bold mb-4" style="color: #00608B;">Plano de A√ß√£o - Solu√ß√µes Selecionadas</h3>
          <p class="text-sm mb-4" style="color: #666;">Total de ${solucoes.length} solu√ß√£o(√µes) ordenada(s) por data (mais pr√≥xima primeiro) ou valor (menor primeiro)</p>
          
          <div class="trilha-fluxograma" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 1.5rem; padding: 2rem 1rem; min-height: 300px; overflow-x: auto;">
            ${solucoes.map((sol, index) => {
              // Usar proxima_data diretamente da base, sem fallback para criado_em no relat√≥rio
              const dataExibicao = sol.proxima_data || null;
              const dataFormatada = dataExibicao ? formatarData(dataExibicao) : 'A definir';
              const v = sol.valor;
              const n = (v != null && v !== '') ? Number(v) : NaN;
              const temValor = !isNaN(n) && n > 0;
              const valorTexto = temValor ? ('R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2 })) : 'Gratuito';
              const valorBadgeColor = temValor ? '#B45309' : '#00A859';
              const valorBadgeBg = temValor ? '#FFEDD5' : '#E8F7F0';
              const isLast = index === solucoes.length - 1;
              const inst = (sol.instrumento && String(sol.instrumento).trim()) ? sol.instrumento : 'Solu√ß√£o';
              
              return `
                <div class="trilha-step fade-in" style="animation-delay: ${index * 0.1}s;">
                  ${!isLast ? `<div class="trilha-step-divider" style="background: linear-gradient(180deg, ${corPadrao} 0%, ${corPadrao}dd 100%);"></div>` : ''}
                  
                  <!-- Chevron ETAPA -->
                  <div class="trilha-assessoria-chevron" style="background: linear-gradient(135deg, ${corPadrao} 0%, ${corPadrao}dd 100%); --chevron-color: ${corPadrao};">
                    <div class="trilha-assessoria-text">ETAPA ${index + 1}</div>
                  </div>
                  
                  <!-- Linha tracejada e hex√°gono -->
                  <div class="trilha-dashed-line"></div>
                  <div class="trilha-hexagon" style="background: linear-gradient(135deg, ${corPadrao} 0%, ${corPadrao}dd 100%);"></div>
                  
                  <div class="trilha-step-content">
                    <div class="trilha-solucao-card p-5 mb-4 fade-in" style="--card-hexagon-color: ${corPadrao};">
                      <!-- Destaque: Pre√ßo e Tipo de Produto -->
                      <div class="flex items-center justify-between mb-4 p-3 rounded-lg" style="background: linear-gradient(135deg, #E3ECEE 0%, #A0C5CF 100%); border: 2px solid ${corPadrao};">
                        <div class="flex-1">
                          <p class="text-xs font-semibold mb-1" style="color: #00608B;">Tipo de Produto</p>
                          <p class="text-base font-bold" style="color: #00608B;">${inst}</p>
                        </div>
                        <div class="text-right ml-4">
                          <p class="text-xs font-semibold mb-1" style="color: #00608B;">Pre√ßo</p>
                          <span class="inline-block px-3 py-1 rounded-lg font-bold text-lg" style="background-color: ${valorBadgeBg}; color: ${valorBadgeColor};">
                            ${valorTexto}
                          </span>
                        </div>
                      </div>
                      
                      <h3 class="text-xl font-bold mb-3" style="color: #1F2937;">${sol.assessoria_nome || 'Sem nome'}</h3>
                      <p class="mb-4 leading-relaxed" style="color: #4B5563;">${sol.assessoria_descricao || 'Sem descri√ß√£o dispon√≠vel'}</p>
                      
                      <!-- Informa√ß√µes adicionais -->
                      <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
                        <div class="p-2 rounded-lg" style="background: #E8F7F0;">
                          <p class="font-semibold mb-1" style="color: #00A859;">üìÖ Data</p>
                          <p class="font-bold" style="color: #047857;">${dataFormatada}</p>
                        </div>
                        <div class="p-2 rounded-lg" style="background: #E8F7F0;">
                          <p class="font-semibold mb-1" style="color: #00A859;">üéØ Dor do Momento</p>
                          <p class="font-bold" style="color: #047857;">${sol.momento_empresarial || sol.crescimento_empresarial || 'N/A'}</p>
                        </div>
                        ${sol.area_conhecimento ? `
                        <div class="p-2 rounded-lg col-span-2" style="background: #FFF4E6;">
                          <p class="font-semibold mb-1" style="color: #B45309;">üìö √Årea de Conhecimento</p>
                          <p class="font-bold" style="color: #92400E;">${sol.area_conhecimento}</p>
                        </div>
                        ` : ''}
                        ${sol.carga_horaria ? `
                        <div class="p-2 rounded-lg col-span-2" style="background: #E0E7FF;">
                          <p class="font-semibold mb-1" style="color: #4F46E5;">‚è±Ô∏è Carga Hor√°ria</p>
                          <p class="font-bold" style="color: #3730A3;">${sol.carga_horaria}</p>
                        </div>
                        ` : ''}
                      </div>
                      
                      ${sol.link_direcionamento ? `
                        <div class="mt-4 p-3 rounded-lg border-2" style="background: #F0F9FF; border-color: #00608B;">
                          <p class="text-xs font-semibold mb-2" style="color: #00608B;">üîó Link de Acesso:</p>
                          <a href="${sol.link_direcionamento}" target="_blank" rel="noopener noreferrer" 
                             class="inline-block px-4 py-2 rounded-lg font-semibold transition-all hover:scale-105 break-all text-sm" 
                             style="background: linear-gradient(135deg, #00608B 0%, #0092BA 100%); color: white;">
                            ${sol.link_direcionamento}
                          </a>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                </div>
                ${!isLast ? `
                <div class="trilha-connector">
                  <div class="trilha-connector-line" style="background: linear-gradient(90deg, ${corPadrao} 0%, ${corPadrao}dd 100%);"></div>
                  <div class="trilha-connector-hexagon" style="background: linear-gradient(135deg, ${corPadrao} 0%, ${corPadrao}dd 100%);"></div>
                </div>
                ` : ''}
              `;
            }).join('')}
          </div>
        </div>
      `;

      conteudoRelatorio.innerHTML = htmlRelatorio;
      
      // Buscar modal novamente ap√≥s criar conte√∫do (caso tenha sido criado)
      modal = document.getElementById('modal-relatorio');
      
      // Sempre mostrar o modal (mesmo que j√° esteja aberto, garante que est√° vis√≠vel)
      if (modal) {
        // Remover classe hidden e garantir display flex com !important
        modal.classList.remove('hidden');
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.setProperty('align-items', 'center', 'important');
        modal.style.setProperty('justify-content', 'center', 'important');
        modal.style.setProperty('z-index', '60', 'important');
        
        // Scroll para o topo do conte√∫do
        const conteudo = modal.querySelector('#conteudo-relatorio');
        if (conteudo) {
          conteudo.scrollTop = 0;
        }
      } else {
        console.error('Modal de relat√≥rio n√£o encontrado ap√≥s cria√ß√£o');
        // Tentar criar novamente
        criarModalRelatorio();
        modal = document.getElementById('modal-relatorio');
        if (modal && conteudoRelatorio) {
          conteudoRelatorio.innerHTML = htmlRelatorio;
          modal.classList.remove('hidden');
          modal.style.setProperty('display', 'flex', 'important');
          modal.style.setProperty('align-items', 'center', 'important');
          modal.style.setProperty('justify-content', 'center', 'important');
        }
      }
    }

    // Fun√ß√£o para criar o modal de relat√≥rio se n√£o existir
    function criarModalRelatorio() {
      // Verificar se j√° existe
      if (document.getElementById('modal-relatorio')) {
        return;
      }
      
      const modalHTML = `
        <div id="modal-relatorio" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden" style="display: none !important;">
          <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col m-4" style="margin: 1rem;">
            <div class="p-6 border-b-2" style="border-color: #E5E7EB;">
              <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold" style="color: #00608B;">Relat√≥rio de Solu√ß√µes Selecionadas</h2>
                <button onclick="fecharRelatorioModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
              </div>
            </div>
            <div class="p-6 overflow-y-auto overflow-x-auto flex-1" id="conteudo-relatorio" style="max-height: calc(90vh - 200px);">
              <!-- Conte√∫do do relat√≥rio ser√° inserido aqui -->
            </div>
            <div class="p-6 border-t-2 flex justify-end gap-4" style="border-color: #E5E7EB;">
              <button onclick="exportarRelatorioDOCX()" class="px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105" style="background: #DC2626; color: white;">
                üìÑ Exportar Word (.docx)
              </button>
              <button onclick="fecharRelatorioModal()" class="px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105 bg-gray-200" style="color: #333;">
                Fechar
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // Fun√ß√£o para fechar modal de relat√≥rio
    function fecharRelatorioModal() {
      const modal = document.getElementById('modal-relatorio');
      if (modal) {
        modal.classList.add('hidden');
        modal.style.setProperty('display', 'none', 'important');
      }
    }

    // Fun√ß√£o para exportar relat√≥rio como PDF (simplificado - pode usar biblioteca como jsPDF)
    function exportarRelatorioDOCX() {
      const solucoes = Array.from(solucoesSelecionadas).map(id => {
        return ultimosResultados.find((sol, index) => {
          const solucaoId = sol.id || `sol_${index}`;
          return solucaoId === id;
        });
      }).filter(Boolean);

      // Usar a mesma fun√ß√£o de ordena√ß√£o do relat√≥rio (que considera ordem, data e valor)
      const solucoesOrdenadas = ordenarSolucoes(solucoes);

      // Texto padr√£o do relat√≥rio
      const textoPadrao = `Ol√°, segue o Relat√≥rio:

Identificamos os pontos que j√° s√£o fortes e, principalmente, as oportunidades de crescimento que podem ser trabalhadas para aumentar a efici√™ncia e o faturamento da sua empresa.

Meu papel √© ser seu parceiro nesta jornada. este plano √© o mapa para transformarmos os desafios em resultados concretos com as Solu√ß√µes que temos aqui no Sebrae

O pr√≥ximo passo √© voc√™ me dar um "ok" sobre datas e organizarmos o calend√°rio das Etapas

Estou √† total disposi√ß√£o para conversarmos sobre este relat√≥rio, tirar qualquer d√∫vida e ajustarmos o que for necess√°rio.`;

      // Criar conte√∫do HTML formatado para Word (.docx)
      // Word pode abrir HTML e salvar como .docx
      let conteudoDOCX = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office"
              xmlns:w="urn:schemas-microsoft-com:office:word"
              xmlns="http://www.w3.org/TR/REC-html40">
          <head>
            <meta charset="utf-8">
            <meta name="ProgId" content="Word.Document">
            <meta name="Generator" content="Microsoft Word">
            <meta name="Originator" content="Microsoft Word">
            <title>Relat√≥rio de Solu√ß√µes - ${new Date().toLocaleDateString('pt-BR')}</title>
            <!--[if gte mso 9]>
            <xml>
              <w:WordDocument>
                <w:View>Print</w:View>
                <w:Zoom>100</w:Zoom>
                <w:DoNotOptimizeForBrowser/>
              </w:WordDocument>
            </xml>
            <![endif]-->
            <style>
              @page {
                size: A4;
                margin: 2.5cm 2cm 2.5cm 2cm;
              }
              body { 
                font-family: 'Calibri', 'Arial', sans-serif; 
                font-size: 11pt;
                line-height: 1.5; 
                color: #000000;
              }
              h1 { 
                color: #00608B; 
                font-size: 18pt;
                font-weight: bold;
                margin-top: 0;
                margin-bottom: 20pt;
              }
              h2 { 
                color: #00608B; 
                font-size: 14pt;
                font-weight: bold;
                margin-top: 20pt; 
                margin-bottom: 10pt; 
              }
              h3 {
                font-size: 12pt;
                font-weight: bold;
                margin-top: 10pt;
                margin-bottom: 8pt;
              }
              .texto-padrao { 
                background: #f8f9fa; 
                padding: 15pt; 
                border-left: 4pt solid #00608B; 
                margin-bottom: 20pt; 
                white-space: pre-line;
                font-size: 11pt;
              }
              .etapa { 
                margin-bottom: 30pt; 
                padding: 15pt; 
                border: 1.5pt solid #00608B; 
                page-break-inside: avoid;
              }
              .etapa-numero { 
                display: inline-block; 
                background: #00608B; 
                color: white; 
                padding: 5pt 12pt; 
                font-weight: bold; 
                margin-bottom: 10pt;
                font-size: 11pt;
              }
              .info { 
                margin-top: 12pt;
              }
              .info-item { 
                padding: 6pt; 
                background: #f0f0f0; 
                margin-bottom: 6pt;
                font-size: 10pt;
              }
              .link { 
                color: #00608B; 
                text-decoration: underline;
              }
              p {
                margin: 6pt 0;
              }
            </style>
          </head>
          <body>
            <h1>Relat√≥rio de Solu√ß√µes Selecionadas</h1>
            
            <div class="texto-padrao">
              ${textoPadrao.replace(/\n/g, '<br>')}
            </div>
            
            <h2>Plano de A√ß√£o - Solu√ß√µes Selecionadas</h2>
            <p><strong>Total: ${solucoesOrdenadas.length} solu√ß√£o(√µes) ordenada(s) por data (mais pr√≥xima primeiro) ou valor (menor primeiro)</strong></p>
            <hr style="margin: 15pt 0; border: none; border-top: 1pt solid #ccc;">
      `;

      solucoesOrdenadas.forEach((sol, index) => {
        // Usar proxima_data diretamente da base, sem fallback para criado_em no relat√≥rio
        const dataExibicao = sol.proxima_data || null;
        const dataFormatada = dataExibicao ? (() => {
          if (!dataExibicao || String(dataExibicao).trim() === '') return 'A definir';
          try {
            // Tentar parsear data no formato DD/MM/YYYY primeiro
            const partesBR = String(dataExibicao).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            let data;
            if (partesBR) {
              // Formato brasileiro DD/MM/YYYY
              data = new Date(parseInt(partesBR[3]), parseInt(partesBR[2]) - 1, parseInt(partesBR[1]));
            } else {
              // Tentar formato ISO ou outros
              data = new Date(dataExibicao);
            }
            // Verificar se a data √© v√°lida
            if (isNaN(data.getTime())) {
              return 'A definir';
            }
            // Verificar se a data n√£o √© muito antiga ou muito futura
            const ano = data.getFullYear();
            if (ano < 1900 || ano > 2100) {
              return 'A definir';
            }
            return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
          } catch {
            return 'A definir';
          }
        })() : 'A definir';
        const v = sol.valor;
        const n = (v != null && v !== '') ? Number(v) : NaN;
        const valorTexto = !isNaN(n) && n > 0 ? ('R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2 })) : 'Gratuito';
        const inst = (sol.instrumento && String(sol.instrumento).trim()) ? sol.instrumento : 'Solu√ß√£o';
        
        conteudoDOCX += `
          <div class="etapa">
            <div class="etapa-numero">ETAPA ${index + 1}</div>
            <h3>${sol.assessoria_nome || 'Sem nome'}</h3>
            <p><strong>Tipo:</strong> ${inst}</p>
            <p>${(sol.assessoria_descricao || 'Sem descri√ß√£o').replace(/\n/g, '<br>')}</p>
            <div class="info">
              <div class="info-item"><strong>Data:</strong> ${dataFormatada}</div>
              <div class="info-item"><strong>Valor:</strong> ${valorTexto}</div>
              <div class="info-item"><strong>Dor do Momento:</strong> ${sol.momento_empresarial || sol.crescimento_empresarial || 'N/A'}</div>
              ${sol.area_conhecimento ? `<div class="info-item"><strong>√Årea de Conhecimento:</strong> ${sol.area_conhecimento}</div>` : ''}
              ${sol.carga_horaria ? `<div class="info-item"><strong>Carga Hor√°ria:</strong> ${sol.carga_horaria}</div>` : ''}
              ${sol.link_direcionamento ? `<div class="info-item"><strong>Link:</strong> <a href="${sol.link_direcionamento}" class="link">${sol.link_direcionamento}</a></div>` : ''}
            </div>
          </div>
        `;
      });

      conteudoDOCX += '</body></html>';

      // Criar Blob com HTML formatado para Word
      // Word pode abrir HTML e salvar como .docx
      const blob = new Blob(['\ufeff', conteudoDOCX], { 
        type: 'application/msword' 
      });
      
      // Criar link de download
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const dataAtual = new Date().toISOString().split('T')[0];
      link.download = `Relatorio_Solucoes_${dataAtual}.doc`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showToast('Relat√≥rio exportado! Abra o arquivo no Word e salve como .docx', 'success');
    }


    // Fun√ß√£o para buscar sugest√µes de ferramentas
    async function carregarSugestoes() {
      if (supabaseClient) {
        try {
          const { data, error } = await supabaseClient.from('sugestoes_ferramentas')
            .select('id, titulo, descricao, link, tipo_momento, crescimento_empresarial, porte, setor, restritivos, desconto, ordem, ativo, criado_em')
            .eq('ativo', true)
            .order('ordem', { ascending: true });
          if (error) throw error;
          sugestoesData = (data || []).map(s => {
            if (!s.__backendId) s.__backendId = s.id;
            return s;
          });
          return 'supabase';
        } catch (e) {
          console.warn('Supabase: erro ao carregar sugest√µes, usando localStorage:', e);
        }
      }
      try {
        const s = localStorage.getItem(STORAGE_KEY_SUGESTOES);
        sugestoesData = s ? JSON.parse(s) : [];
        sugestoesData.forEach(s => { if (!s.__backendId) s.__backendId = s.id; });
      } catch (e) {
        sugestoesData = [];
      }
      return 'local';
    }

    // Embaralha array (Fisher-Yates)
    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Fun√ß√£o para buscar e exibir at√© 5 sugest√µes de ferramentas, distribu√≠das pelas dores selecionadas (aleat√≥rio)
    async function buscarEExibirSugestao() {
      const boxSugestao = document.getElementById('box-sugestao-ferramenta');
      const conteudoSugestao = document.getElementById('sugestao-conteudo');
      const tituloSugestao = document.getElementById('sugestao-ferramenta-titulo');
      const subtituloSugestao = document.getElementById('sugestao-ferramenta-subtitulo');
      
      if (!selecao.tipoMomento || !selecao.porte || !selecao.setor) {
        boxSugestao.classList.add('hidden');
        return;
      }

      const sugestoesFiltradas = sugestoesData.filter(s => {
        if (!s.ativo) return false;
        if (s.tipo_momento && s.tipo_momento !== selecao.tipoMomento) return false;
        if (s.porte && s.porte !== selecao.porte) return false;
        if (s.setor) {
          let setorSugestao = s.setor;
          let setorSelecao = selecao.setor;
          if (setorSelecao === 'Com√©rcio') setorSelecao = 'Comercio';
          else if (setorSelecao === 'Ind√∫stria') setorSelecao = 'Industria';
          else if (setorSelecao === 'Servi√ßos') setorSelecao = 'Servicos';
          if (setorSugestao !== setorSelecao) return false;
        }
        const doresSelecionadas = selecao.categorias.filter(c => c !== 'Nenhuma');
        if (s.crescimento_empresarial) {
          if (doresSelecionadas.length > 0 && !doresSelecionadas.includes(s.crescimento_empresarial)) {
            return false;
          }
          if (doresSelecionadas.length === 0) return false;
        }
        return true;
      });

      if (sugestoesFiltradas.length === 0) {
        boxSugestao.classList.add('hidden');
        return;
      }

      const doresSelecionadas = selecao.categorias.filter(c => c !== 'Nenhuma');
      const MAX_FERRAMENTAS = 5;
      let selectedSugestoes = [];
      const nomesJaUsados = new Set(); // garante solu√ß√µes √∫nicas por nome (sem repeti√ß√£o)
      const normalizarNome = (titulo) => (titulo || '').trim().toLowerCase();

      if (doresSelecionadas.length === 0) {
        const shuffled = shuffleArray(sugestoesFiltradas);
        for (const t of shuffled) {
          if (selectedSugestoes.length >= MAX_FERRAMENTAS) break;
          const nome = normalizarNome(t.titulo);
          if (!nomesJaUsados.has(nome)) {
            nomesJaUsados.add(nome);
            selectedSugestoes.push(t);
          }
        }
      } else {
        const n = doresSelecionadas.length;
        const perDor = Math.floor(MAX_FERRAMENTAS / n);
        const remainder = MAX_FERRAMENTAS - perDor * n;

        for (let i = 0; i < n; i++) {
          const dor = doresSelecionadas[i];
          const count = perDor + (i === 0 ? remainder : 0);
          const toolsForDor = sugestoesFiltradas.filter(s => s.crescimento_empresarial === dor);
          const shuffled = shuffleArray(toolsForDor);
          let taken = 0;
          for (const t of shuffled) {
            if (taken >= count) break;
            const nome = normalizarNome(t.titulo);
            if (!nomesJaUsados.has(nome)) {
              nomesJaUsados.add(nome);
              selectedSugestoes.push(t);
              taken++;
            }
          }
        }
        selectedSugestoes = shuffleArray(selectedSugestoes).slice(0, MAX_FERRAMENTAS);
      }

      if (selectedSugestoes.length === 0) {
        boxSugestao.classList.add('hidden');
        return;
      }

      const esc = (t) => (t || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      const cardsHtml = selectedSugestoes.map(sugestao => `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h4 class="text-xl font-bold mb-3" style="color: #00608B;">${esc(sugestao.titulo)}</h4>
          ${sugestao.desconto ? `<p class="text-base mb-3" style="color: #059669;"><strong>Desconto:</strong> <span class="text-xl font-bold" style="color: #047857;">${esc(sugestao.desconto)}</span></p>` : ''}
          ${sugestao.descricao ? `<p class="text-gray-700 mb-4 leading-relaxed">${esc(sugestao.descricao)}</p>` : ''}
          ${sugestao.restritivos ? `<p class="text-sm mb-2" style="color: #B45309;"><strong>Restritivos:</strong> ${esc(sugestao.restritivos)}</p>` : ''}
          ${sugestao.link ? `
            <a href="${esc(sugestao.link)}" target="_blank" rel="noopener noreferrer" 
               class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105 shadow-lg" 
               style="background: linear-gradient(135deg, #00608B 0%, #6366F1 100%); color: white;">
              Acessar Ferramenta ‚Üí
            </a>
          ` : ''}
        </div>
      `).join('');

      conteudoSugestao.innerHTML = cardsHtml;
      if (tituloSugestao) tituloSugestao.textContent = selectedSugestoes.length > 1 ? 'Ferramentas Recomendadas' : 'Ferramenta Recomendada';
      if (subtituloSugestao) subtituloSugestao.textContent = selectedSugestoes.length > 1 ? 'At√© 5 sugest√µes para o seu perfil' : 'Uma sugest√£o especial para o seu perfil';
      boxSugestao.classList.remove('hidden');
    }

    // Fun√ß√µes de gest√£o de sugest√µes
    async function salvarSugestao() {
      const titulo = document.getElementById('sug-titulo').value.trim();
      if (!titulo) {
        showToast('Preencha o t√≠tulo da sugest√£o', 'error');
        return;
      }

      const tipoMomento = document.getElementById('sug-tipo-momento').value;
      const crescimentoValue = document.getElementById('sug-crescimento').value;
      
      // √Årea de Crescimento (Dor): para momento empresarial usa Gerencie/Planeje/etc.; para crescimento usa Marketing e Vendas/etc.
      const crescimento_empresarial = (crescimentoValue && crescimentoValue.trim() !== '') ? crescimentoValue : null;

      const sugestao = {
        titulo: titulo,
        descricao: document.getElementById('sug-descricao').value.trim() || null,
        link: document.getElementById('sug-link').value.trim() || null,
        tipo_momento: tipoMomento || null,
        crescimento_empresarial: crescimento_empresarial,
        porte: document.getElementById('sug-porte').value || null,
        setor: document.getElementById('sug-setor').value || null,
        ordem: parseInt(document.getElementById('sug-ordem').value) || 1,
        restritivos: document.getElementById('sug-restritivos').value.trim() || null,
        desconto: document.getElementById('sug-desconto').value.trim() || null,
        ativo: document.getElementById('sug-ativo').checked
      };

      if (supabaseClient) {
        try {
          const { data, error } = await supabaseClient.from('sugestoes_ferramentas').insert(sugestao).select().single();
          if (error) {
            showToast('Erro ao salvar: ' + error.message, 'error');
            return;
          }
          sugestoesData.push({ ...data, __backendId: data.id });
          showToast('‚úì Sugest√£o salva com sucesso!', 'success');
        } catch (e) {
          showToast('Erro ao salvar: ' + e.message, 'error');
          return;
        }
      } else {
        sugestao.id = 'sug-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        sugestao.__backendId = sugestao.id;
        sugestoesData.push(sugestao);
        localStorage.setItem(STORAGE_KEY_SUGESTOES, JSON.stringify(sugestoesData));
        showToast('‚úì Sugest√£o salva com sucesso!', 'success');
      }

      document.getElementById('form-sugestao').reset();
      atualizarCategoriasSugestao();
      document.getElementById('sug-ordem').value = '1';
      document.getElementById('sug-ativo').checked = true;
      atualizarListaSugestoes();
    }

    async function excluirSugestao(backendId) {
      const sugestao = sugestoesData.find(s => (s.__backendId || s.id) === backendId);
      if (!sugestao) return;

      if (!confirm(`Deseja realmente excluir a sugest√£o "${sugestao.titulo}"?`)) return;

      if (supabaseClient && backendId) {
        try {
          const { error } = await supabaseClient.from('sugestoes_ferramentas').delete().eq('id', backendId);
          if (error) {
            showToast('Erro ao excluir: ' + error.message, 'error');
            return;
          }
        } catch (e) {
          showToast('Erro ao excluir: ' + e.message, 'error');
          return;
        }
      }

      sugestoesData = sugestoesData.filter(s => (s.__backendId || s.id) !== backendId);
      if (!supabaseClient) {
        localStorage.setItem(STORAGE_KEY_SUGESTOES, JSON.stringify(sugestoesData));
      }

      showToast('‚úì Sugest√£o exclu√≠da!', 'success');
      atualizarListaSugestoes();
    }

    function editarSugestao(backendId) {
      const sugestao = sugestoesData.find(s => (s.__backendId || s.id) === backendId);
      if (!sugestao) return;

      document.getElementById('sug-titulo').value = sugestao.titulo || '';
      document.getElementById('sug-descricao').value = sugestao.descricao || '';
      document.getElementById('sug-link').value = sugestao.link || '';
      document.getElementById('sug-tipo-momento').value = sugestao.tipo_momento || '';
      // Atualizar op√ß√µes de crescimento baseado no tipo de momento
      atualizarCategoriasSugestao();
      // Definir √Årea de Crescimento (Dor) para ambos os tipos: empresarial (Gerencie, etc.) ou crescimento (Marketing e Vendas, etc.)
      if (sugestao.crescimento_empresarial) {
        document.getElementById('sug-crescimento').value = sugestao.crescimento_empresarial || '';
      } else {
        document.getElementById('sug-crescimento').value = '';
      }
      document.getElementById('sug-porte').value = sugestao.porte || '';
      document.getElementById('sug-setor').value = sugestao.setor || '';
      document.getElementById('sug-ordem').value = sugestao.ordem || 1;
      document.getElementById('sug-restritivos').value = sugestao.restritivos || '';
      document.getElementById('sug-desconto').value = sugestao.desconto || '';
      document.getElementById('sug-ativo').checked = sugestao.ativo !== false;

      const btnSalvar = document.getElementById('btn-salvar-sugestao');
      btnSalvar.textContent = 'üíæ Atualizar Sugest√£o';
      btnSalvar.onclick = async () => {
        await atualizarSugestao(backendId);
      };

      document.getElementById('form-sugestao').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function atualizarSugestao(backendId) {
      const titulo = document.getElementById('sug-titulo').value.trim();
      if (!titulo) {
        showToast('Preencha o t√≠tulo da sugest√£o', 'error');
        return;
      }

      const tipoMomento = document.getElementById('sug-tipo-momento').value;
      const crescimentoValue = document.getElementById('sug-crescimento').value;
      
      // √Årea de Crescimento (Dor): para momento empresarial usa Gerencie/Planeje/etc.; para crescimento usa Marketing e Vendas/etc.
      const crescimento_empresarial = (crescimentoValue && crescimentoValue.trim() !== '') ? crescimentoValue : null;

      const dadosAtualizados = {
        titulo: titulo,
        descricao: document.getElementById('sug-descricao').value.trim() || null,
        link: document.getElementById('sug-link').value.trim() || null,
        tipo_momento: tipoMomento || null,
        crescimento_empresarial: crescimento_empresarial,
        porte: document.getElementById('sug-porte').value || null,
        setor: document.getElementById('sug-setor').value || null,
        ordem: parseInt(document.getElementById('sug-ordem').value) || 1,
        restritivos: document.getElementById('sug-restritivos').value.trim() || null,
        desconto: document.getElementById('sug-desconto').value.trim() || null,
        ativo: document.getElementById('sug-ativo').checked
      };

      if (supabaseClient && backendId) {
        try {
          const { error } = await supabaseClient.from('sugestoes_ferramentas').update(dadosAtualizados).eq('id', backendId);
          if (error) {
            showToast('Erro ao atualizar: ' + error.message, 'error');
            return;
          }
        } catch (e) {
          showToast('Erro ao atualizar: ' + e.message, 'error');
          return;
        }
      }

      const index = sugestoesData.findIndex(s => (s.__backendId || s.id) === backendId);
      if (index >= 0) {
        sugestoesData[index] = { ...sugestoesData[index], ...dadosAtualizados };
        if (!supabaseClient) {
          localStorage.setItem(STORAGE_KEY_SUGESTOES, JSON.stringify(sugestoesData));
        }
      }

      showToast('‚úì Sugest√£o atualizada!', 'success');
      document.getElementById('form-sugestao').reset();
      atualizarCategoriasSugestao();
      document.getElementById('sug-ordem').value = '1';
      document.getElementById('sug-ativo').checked = true;

      const btnSalvar = document.getElementById('btn-salvar-sugestao');
      btnSalvar.textContent = 'üíæ Salvar Sugest√£o';
      btnSalvar.onclick = salvarSugestao;

      atualizarListaSugestoes();
    }

    function atualizarListaSugestoes() {
      const lista = document.getElementById('lista-sugestoes');
      if (!lista) return;

      if (sugestoesData.length === 0) {
        lista.innerHTML = '<p class="text-center py-4 text-gray-500">Nenhuma sugest√£o cadastrada ainda</p>';
        return;
      }

      const ordenadas = [...sugestoesData].sort((a, b) => (a.ordem || 0) - (b.ordem || 0));

      lista.innerHTML = ordenadas.map(sugestao => {
        const bid = String(sugestao.__backendId || sugestao.id);
        const filtros = [];
        if (sugestao.tipo_momento) filtros.push(`Momento: ${sugestao.tipo_momento === 'empresarial' ? 'Empresarial' : 'Crescimento'}`);
        if (sugestao.crescimento_empresarial) filtros.push(`Dor: ${sugestao.crescimento_empresarial}`);
        if (sugestao.porte) filtros.push(`Porte: ${sugestao.porte}`);
        if (sugestao.setor) filtros.push(`Setor: ${sugestao.setor}`);
        if (filtros.length === 0) filtros.push('Todos os perfis');

        return `
          <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 rounded-lg p-4" style="border-color: #A0C5CF;">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1">
                <div class="flex flex-wrap gap-2 mb-2">
                  ${sugestao.ativo ? '<span class="badge" style="background-color: #E8F7F0; color: #00A859; font-size: 0.7rem;">‚úì Ativo</span>' : '<span class="badge" style="background-color: #FEE2E2; color: #DC2626; font-size: 0.7rem;">‚úó Inativo</span>'}
                  <span class="badge" style="background-color: #E3ECEE; color: #00608B; font-size: 0.7rem;">Ordem ${sugestao.ordem || 1}</span>
                </div>
                <h5 class="font-bold text-base mb-1" style="color: #00608B;">${sugestao.titulo}</h5>
                ${sugestao.desconto ? `<p class="text-sm mb-1" style="color: #059669;"><strong>Desconto:</strong> <span class="font-bold">${(sugestao.desconto || '').replace(/</g, '&lt;')}</span></p>` : ''}
                ${sugestao.descricao ? `<p class="text-sm line-clamp-2 mb-2" style="color: #666;">${sugestao.descricao}</p>` : ''}
                <p class="text-xs mb-2" style="color: #999;">${filtros.join(' ‚Ä¢ ')}</p>
                ${sugestao.restritivos ? `<p class="text-xs mb-1" style="color: #B45309;"><strong>Restritivos:</strong> ${(sugestao.restritivos || '').replace(/</g, '&lt;')}</p>` : ''}
                ${sugestao.link ? `<p class="text-xs"><a href="${sugestao.link}" target="_blank" rel="noopener noreferrer" class="text-purple-600 hover:underline">üîó ${sugestao.link}</a></p>` : ''}
              </div>
              <div class="flex gap-2 flex-shrink-0">
                <button onclick="copiarSugestao('${bid}')" class="px-3 py-2 bg-green-50 hover:bg-green-100 rounded-lg transition-all" style="color: #00A859;" title="Copiar/Duplicar">
                  <span class="text-xl">üìã</span>
                </button>
                <button onclick="editarSugestao('${bid}')" class="px-3 py-2 bg-purple-50 hover:bg-purple-100 rounded-lg transition-all" style="color: #00608B;" title="Editar">
                  <span class="text-xl">‚úèÔ∏è</span>
                </button>
                <button onclick="excluirSugestao('${bid}')" class="px-3 py-2 bg-red-50 hover:bg-red-100 rounded-lg transition-all" style="color: #DC2626;" title="Excluir">
                  <span class="text-xl">üóëÔ∏è</span>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Fun√ß√£o para exportar ferramentas para Excel
    function exportarFerramentasParaExcel() {
      if (typeof XLSX === 'undefined') {
        showToast('Biblioteca Excel n√£o carregada. Recarregue a p√°gina.', 'error');
        return;
      }
      if (sugestoesData.length === 0) {
        showToast('Nenhuma ferramenta para exportar.', 'error');
        return;
      }
      const rows = sugestoesData.map(f => ({
        'T√≠tulo': f.titulo || '',
        'Descri√ß√£o': f.descricao || '',
        'Link': f.link || '',
        'Tipo de Momento': f.tipo_momento === 'empresarial' ? 'Momento Empresarial' : (f.tipo_momento === 'crescimento' ? 'Crescimento Empresarial' : ''),
        'Foco Principal da Dor': f.crescimento_empresarial || '',
        'Porte': f.porte || '',
        'Setor': f.setor || '',
        'Restritivos': f.restritivos || '',
        'Desconto': f.desconto || '',
        'Ordem': f.ordem || 1,
        'Ativo': f.ativo !== false ? 'Sim' : 'N√£o'
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ferramentas');
      XLSX.writeFile(wb, 'ferramentas_sebrae_' + new Date().toISOString().slice(0,10) + '.xlsx');
      showToast('‚úì Planilha de ferramentas exportada!', 'success');
    }

    // Fun√ß√£o para baixar modelo de planilha de ferramentas
    function baixarModeloPlanilhaFerramentas() {
      if (typeof XLSX === 'undefined') {
        showToast('Biblioteca Excel n√£o carregada. Recarregue a p√°gina.', 'error');
        return;
      }
      const modelo = [{
        'T√≠tulo': 'Calculadora de Precifica√ß√£o',
        'Descri√ß√£o': 'Ferramenta para calcular pre√ßos de produtos',
        'Link': 'https://www.sebrae.com.br/ferramenta',
        'Tipo de Momento': 'empresarial',
        'Foco Principal da Dor': 'Gerencie',
        'Porte': 'MEI',
        'Setor': 'Comercio',
        'Restritivos': 'Apenas para MEI',
        'Desconto': '10%',
        'Ordem': 1,
        'Ativo': 'Sim'
      }];
      const ws = XLSX.utils.json_to_sheet(modelo);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ferramentas');
      XLSX.writeFile(wb, 'modelo_ferramentas_sebrae.xlsx');
      showToast('‚úì Modelo de planilha baixado!', 'success');
    }

    // Fun√ß√£o para processar importa√ß√£o de ferramentas
    async function processarImportacaoFerramentas(event) {
      const file = event.target.files[0];
      if (!file) return;

      const statusDiv = document.getElementById('import-status-ferramentas');
      statusDiv.classList.remove('hidden');
      statusDiv.className = 'mt-4 p-4 rounded-lg bg-blue-50 text-blue-700 border-2 border-blue-200';

      try {
        let dados = [];
        const isExcel = /\.(xlsx|xls)$/i.test(file.name);

        if (isExcel && typeof XLSX !== 'undefined') {
          const ab = await file.arrayBuffer();
          const wb = XLSX.read(ab, { type: 'array', cellDates: true, cellNF: false });
          const ws = wb.Sheets[wb.SheetNames[0]] || wb.Sheets[0];
          if (!ws) throw new Error('Nenhuma planilha encontrada no arquivo.');
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false, dateNF: 'dd/mm/yyyy' });
          if (!rows || rows.length < 2) throw new Error('Planilha vazia ou sem dados.');
          const headers = (rows[0] || []).map(h => String(h || '').trim());
          for (let i = 1; i < rows.length; i++) {
            const values = rows[i] || [];
            if (values.every(v => v === undefined || v === null || v === '')) continue;
            const row = {};
            headers.forEach((h, j) => { 
              const val = values[j];
              if (val instanceof Date) {
                const day = String(val.getDate()).padStart(2, '0');
                const month = String(val.getMonth() + 1).padStart(2, '0');
                const year = val.getFullYear();
                row[h] = `${day}/${month}/${year}`;
              } else {
                row[h] = val !== undefined && val !== null ? String(val) : '';
              }
            });
            dados.push(row);
          }
        } else {
          const text = await file.text();
          const lines = text.split('\n').filter(line => line.trim());
          if (lines.length < 2) throw new Error('Arquivo vazio ou sem dados.');
          const parseCSVLine = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
              const char = line[i];
              if (char === '"') inQuotes = !inQuotes;
              else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
              else current += char;
            }
            result.push(current.trim());
            return result;
          };
          const headers = parseCSVLine(lines[0]);
          for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            if (values.every(v => !v || v.trim() === '')) continue;
            const row = {};
            headers.forEach((h, j) => { row[h] = values[j] || ''; });
            dados.push(row);
          }
        }

        if (dados.length === 0) {
          throw new Error('Nenhum dado v√°lido encontrado na planilha.');
        }

        // Fun√ß√£o auxiliar para buscar coluna com varia√ß√µes
        const buscarColuna = (row, variacoes) => {
          for (const variacao of variacoes) {
            if (row[variacao] !== undefined && row[variacao] !== null && String(row[variacao]).trim() !== '') {
              return String(row[variacao]).trim();
            }
          }
          return '';
        };

        // Fun√ß√£o auxiliar para normalizar campos de texto
        const normalizarTexto = (valor) => {
          if (valor === null || valor === undefined) return null;
          const str = String(valor).trim();
          return str === '' ? null : str;
        };

        let sucesso = 0;
        let erros = 0;
        const errosDetalhes = [];

        for (let idx = 0; idx < dados.length; idx++) {
          const row = dados[idx];
          try {
            // Mapear campos usando fun√ß√£o auxiliar
            const titulo = buscarColuna(row, ['T√≠tulo', 'Titulo', 'titulo', 'T√≠tulo da Ferramenta']);
            const descricao = buscarColuna(row, ['Descri√ß√£o', 'Descricao', 'descricao']);
            const link = buscarColuna(row, ['Link', 'link', 'URL', 'url']);
            const tipoMomento = buscarColuna(row, ['Tipo de Momento', 'Tipo Momento', 'tipo_momento', 'Tipo']);
            const crescimentoEmpresarial = buscarColuna(row, ['Foco Principal da Dor', '√Årea de Crescimento (Dor)', 'Foco Principal', 'crescimento_empresarial', 'Crescimento Empresarial', 'Dor']);
            const porte = buscarColuna(row, ['Porte', 'porte']);
            const setor = buscarColuna(row, ['Setor', 'setor']);
            const restritivos = buscarColuna(row, ['Restritivos', 'restritivos']);
            const desconto = buscarColuna(row, ['Desconto', 'desconto']);
            const ordemStr = buscarColuna(row, ['Ordem', 'ordem', 'Ordem de Exibi√ß√£o']);
            const ativoStr = buscarColuna(row, ['Ativo', 'ativo', 'Ativa']);

            // Valida√ß√£o
            if (!titulo) {
              erros++;
              errosDetalhes.push(`Linha ${idx + 2}: T√≠tulo obrigat√≥rio`);
              continue;
            }

            // Normalizar valores
            const tipoMomentoFinal = tipoMomento && ['empresarial', 'crescimento', ''].includes(tipoMomento.toLowerCase()) 
              ? tipoMomento.toLowerCase() 
              : (tipoMomento ? null : null);
            
            // Se tipo_momento √© "empresarial", crescimento_empresarial deve ser null
            const crescimentoFinal = (tipoMomentoFinal === 'empresarial') ? null : (normalizarTexto(crescimentoEmpresarial));

            // Normalizar setor
            let setorFinal = normalizarTexto(setor);
            if (setorFinal) {
              if (setorFinal === 'Com√©rcio') setorFinal = 'Comercio';
              else if (setorFinal === 'Ind√∫stria') setorFinal = 'Industria';
              else if (setorFinal === 'Servi√ßos') setorFinal = 'Servicos';
              else if (setorFinal === 'Multissetorial') setorFinal = 'Multissetorial';
              else if (!['Comercio', 'Industria', 'Servicos', 'Multissetorial'].includes(setorFinal)) {
                setorFinal = null;
              }
            }

            // Normalizar porte
            let porteFinal = normalizarTexto(porte);
            if (porteFinal && !['MEI', 'ME', 'EPP'].includes(porteFinal)) {
              porteFinal = null;
            }

            // Normalizar ordem
            const ordemFinal = ordemStr ? (parseInt(ordemStr, 10) || 1) : 1;

            // Normalizar ativo
            const ativoFinal = ativoStr ? (ativoStr.toLowerCase() === 'sim' || ativoStr.toLowerCase() === 'true' || ativoStr === '1') : true;

            const novaFerramenta = {
              titulo: titulo,
              descricao: normalizarTexto(descricao),
              link: normalizarTexto(link),
              tipo_momento: tipoMomentoFinal || null,
              crescimento_empresarial: crescimentoFinal,
              porte: porteFinal,
              setor: setorFinal,
              restritivos: normalizarTexto(restritivos),
              desconto: normalizarTexto(desconto),
              ordem: ordemFinal,
              ativo: ativoFinal
            };

            if (supabaseClient) {
              try {
                const { data, error } = await supabaseClient.from('sugestoes_ferramentas').insert(novaFerramenta).select().single();
                if (error) {
                  erros++;
                  errosDetalhes.push(`Linha ${idx + 2}: ${error.message}`);
                  continue;
                }
                sugestoesData.push({ ...data, __backendId: data.id });
                sucesso++;
              } catch (e) {
                erros++;
                errosDetalhes.push(`Linha ${idx + 2}: ${e.message}`);
              }
            } else {
              novaFerramenta.id = 'sug-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
              novaFerramenta.__backendId = novaFerramenta.id;
              sugestoesData.push(novaFerramenta);
              localStorage.setItem(STORAGE_KEY_SUGESTOES, JSON.stringify(sugestoesData));
              sucesso++;
            }
          } catch (err) {
            erros++;
            errosDetalhes.push(`Linha ${idx + 2}: ${err.message || 'Erro desconhecido'}`);
          }
        }

        if (erros > 0) {
          statusDiv.className = 'mt-4 p-4 rounded-lg bg-yellow-50 text-yellow-800 border-2 border-yellow-300';
          statusDiv.innerHTML = `
            <p class="font-bold">‚ö†Ô∏è Importa√ß√£o conclu√≠da com erros</p>
            <p>Sucesso: ${sucesso} | Erros: ${erros}</p>
            <details class="mt-2">
              <summary class="cursor-pointer font-semibold">Ver detalhes dos erros</summary>
              <ul class="list-disc list-inside mt-2 text-sm max-h-40 overflow-y-auto">
                ${errosDetalhes.map(e => `<li>${e}</li>`).join('')}
              </ul>
            </details>
          `;
        } else {
          statusDiv.className = 'mt-4 p-4 rounded-lg bg-green-50 text-green-800 border-2 border-green-300';
          statusDiv.innerHTML = `<p class="font-bold">‚úì Importa√ß√£o conclu√≠da com sucesso!</p><p>${sucesso} ferramenta(s) importada(s).</p>`;
        }

        atualizarListaSugestoes();
        event.target.value = '';
      } catch (error) {
        statusDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 text-red-800 border-2 border-red-300';
        statusDiv.innerHTML = `<p class="font-bold">‚úó Erro na importa√ß√£o</p><p>${error.message}</p>`;
        event.target.value = '';
      }
    }

    function copiarSugestao(backendId) {
      const sugestao = sugestoesData.find(s => (s.__backendId || s.id) === backendId);
      if (!sugestao) {
        showToast('Sugest√£o n√£o encontrada', 'error');
        return;
      }

      // Preencher formul√°rio com dados da sugest√£o (c√≥pia)
      const tituloOriginal = sugestao.titulo || '';
      const tituloComCopia = tituloOriginal.includes('(C√≥pia)') ? tituloOriginal : tituloOriginal + ' (C√≥pia)';
      document.getElementById('sug-titulo').value = tituloComCopia;
      document.getElementById('sug-descricao').value = sugestao.descricao || '';
      document.getElementById('sug-link').value = sugestao.link || '';
      document.getElementById('sug-tipo-momento').value = sugestao.tipo_momento || '';
      
      // Atualizar op√ß√µes de crescimento baseado no tipo de momento
      atualizarCategoriasSugestao();
      
      // Definir √Årea de Crescimento (Dor) para ambos os tipos: empresarial (Gerencie, etc.) ou crescimento (Marketing e Vendas, etc.)
      if (sugestao.crescimento_empresarial) {
        document.getElementById('sug-crescimento').value = sugestao.crescimento_empresarial || '';
      } else {
        document.getElementById('sug-crescimento').value = '';
      }
      
      document.getElementById('sug-porte').value = sugestao.porte || '';
      document.getElementById('sug-setor').value = sugestao.setor || '';
      document.getElementById('sug-ordem').value = sugestao.ordem || 1;
      document.getElementById('sug-restritivos').value = sugestao.restritivos || '';
      document.getElementById('sug-desconto').value = sugestao.desconto || '';
      document.getElementById('sug-ativo').checked = sugestao.ativo !== false;

      // Resetar bot√£o para "Salvar" (n√£o "Atualizar")
      const btnSalvar = document.getElementById('btn-salvar-sugestao');
      btnSalvar.textContent = 'üíæ Salvar Sugest√£o';
      btnSalvar.onclick = salvarSugestao;

      // Scroll para o formul√°rio
      document.getElementById('form-sugestao').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function voltarEtapa(etapa) {
      // Ocultar bot√£o flutuante ao voltar para outras etapas
      ocultarBotaoFlutuante();
      
      if (etapa === 'momento') {
        document.getElementById('cards-empresarial').classList.add('hidden');
        document.getElementById('cards-crescimento').classList.add('hidden');
        document.getElementById('step-momento').classList.remove('hidden');
        
        document.querySelectorAll('.card-option').forEach(card => card.classList.remove('selected'));
        document.getElementById('btn-avancar-momento').disabled = true;
        document.getElementById('btn-avancar-crescimento').disabled = true;
        
        selecao.categorias = [];
      } else if (etapa === 'cards') {
        document.getElementById('step-porte').classList.add('hidden');
        
        if (selecao.tipoMomento === 'empresarial') {
          document.getElementById('cards-empresarial').classList.remove('hidden');
        } else {
          document.getElementById('cards-crescimento').classList.remove('hidden');
        }
        
        document.getElementById('step-2').classList.remove('active', 'completed');
        document.getElementById('line-1').classList.remove('completed');
        document.getElementById('step-1').classList.add('active');
        document.getElementById('step-1').classList.remove('completed');
      } else if (etapa === 'porte') {
        document.getElementById('step-setor').classList.add('hidden');
        document.getElementById('step-porte').classList.remove('hidden');
        
        document.getElementById('step-3').classList.remove('active', 'completed');
        document.getElementById('line-2').classList.remove('completed');
        document.getElementById('step-2').classList.add('active');
        document.getElementById('step-2').classList.remove('completed');
        
        selecao.porte = null;
      }
    }

    function reiniciar() {
      selecao = {
        tipoMomento: null,
        categorias: [],
        porte: null,
        setor: null
      };
      
      document.getElementById('step-resultados').classList.add('hidden');
      document.getElementById('step-momento').classList.remove('hidden');
      
      // Ocultar bot√£o flutuante ao reiniciar
      ocultarBotaoFlutuante();
      
      // Limpar sele√ß√µes de solu√ß√µes
      solucoesSelecionadas.clear();
      
      // Ocultar bot√£o flutuante ao voltar para outras etapas
      ocultarBotaoFlutuante();
      
      document.querySelectorAll('.step-circle').forEach(circle => {
        circle.classList.remove('active', 'completed');
      });
      document.querySelectorAll('.step-line').forEach(line => {
        line.classList.remove('completed');
      });
      document.getElementById('step-1').classList.add('active');
      
      document.querySelectorAll('.card-option').forEach(card => card.classList.remove('selected'));
    }

    function atualizarCategorias() {
      const tipo = document.getElementById('cad-tipo-momento').value;
      const selectCategoria = document.getElementById('cad-categoria');
      
      if (tipo === 'empresarial') {
        selectCategoria.innerHTML = '<option value="">Selecione o foco da dor...</option>';
        momentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectCategoria.appendChild(option);
        });
      } else if (tipo === 'crescimento') {
        // Adicionar op√ß√£o "Nenhuma" primeiro
        selectCategoria.innerHTML = '<option value="">Nenhuma</option>';
        // Adicionar as outras op√ß√µes de crescimento
        crescimentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectCategoria.appendChild(option);
        });
      } else {
        selectCategoria.innerHTML = '<option value="">Selecione o momento empresarial primeiro</option>';
      }
    }

    function atualizarCategoriasSugestao() {
      const tipo = document.getElementById('sug-tipo-momento').value;
      const selectCrescimento = document.getElementById('sug-crescimento');
      
      if (tipo === 'empresarial') {
        // Momento Empresarial: permitir selecionar a √°rea/dor (Gerencie, Planeje, Organize, Lidere, Potencialize)
        selectCrescimento.innerHTML = '<option value="">Nenhuma</option>';
        momentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectCrescimento.appendChild(option);
        });
      } else if (tipo === 'crescimento') {
        // Adicionar op√ß√£o "Nenhuma" primeiro
        selectCrescimento.innerHTML = '<option value="">Nenhuma</option>';
        // Adicionar as outras op√ß√µes de crescimento
        crescimentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectCrescimento.appendChild(option);
        });
      } else {
        // Se "Todos" for selecionado, mostrar todas as op√ß√µes
        selectCrescimento.innerHTML = '<option value="">Todas</option>';
        // Adicionar op√ß√µes de momento empresarial
        momentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectCrescimento.appendChild(option);
        });
        // Adicionar op√ß√µes de crescimento
        crescimentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectCrescimento.appendChild(option);
        });
      }
    }

    async function handleCadastro(e) {
      e.preventDefault();

      if (assessoriasData.length >= 999) {
        showToast('Limite de 999 solu√ß√µes atingido. Exclua algumas para cadastrar novas.', 'error');
        return;
      }

      const btnCadastrar = document.getElementById('btn-cadastrar');
      btnCadastrar.disabled = true;
      btnCadastrar.textContent = '‚è≥ Cadastrando...';

      const tipoMomento = document.getElementById('cad-tipo-momento').value;
      const categoriaValue = document.getElementById('cad-categoria').value;
      // Se categoria vazia (value="") ou "Nenhuma", salvar como null
      const categoriaFinal = (categoriaValue && categoriaValue.trim() !== '' && categoriaValue !== 'Nenhuma' && categoriaValue !== '__nenhuma__') ? categoriaValue : null;
      
      const novaAssessoria = {
        id: `assess-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        codigo: document.getElementById('cad-codigo').value || '',
        momento_empresarial: tipoMomento === 'empresarial' ? categoriaFinal : null,
        crescimento_empresarial: tipoMomento === 'crescimento' ? categoriaFinal : null,
        porte: document.getElementById('cad-porte').value,
        setor: document.getElementById('cad-setor').value,
        assessoria_nome: document.getElementById('cad-nome').value,
        assessoria_descricao: document.getElementById('cad-descricao').value,
        segmento: document.getElementById('cad-segmento').value || '',
        area_conhecimento: document.getElementById('cad-area-conhecimento').value || '',
        temas: '',
        carga_horaria: document.getElementById('cad-carga-horaria').value || '',
        instrumento: document.getElementById('cad-instrumento').value || '',
        fornecedor: document.getElementById('cad-fornecedor').value || '',
        proxima_data: document.getElementById('cad-proxima-data').value || '',
        data_validade: document.getElementById('cad-data-validade').value || null,
        valor: (function(){ var v = parseFloat(document.getElementById('cad-valor').value); return (v >= 0 && !isNaN(v)) ? v : 0; })(),
        ordem: parseInt(document.getElementById('cad-ordem').value),
        link_direcionamento: document.getElementById('cad-link-direcionamento').value || null,
        criado_em: new Date().toISOString()
      };

      const result = await adicionarSolucao(novaAssessoria);

      btnCadastrar.disabled = false;
      btnCadastrar.textContent = '‚úì Cadastrar Solu√ß√£o';

      if (result && result.isOk) {
        showToast('‚úì Solu√ß√£o cadastrada com sucesso!', 'success');
        document.getElementById('cadastro-form').reset();
        document.getElementById('cad-valor').value = '0';
        atualizarListaAssessorias();
      } else {
        const errorMsg = result && result.error ? result.error : 'Erro desconhecido';
        console.error('Erro ao cadastrar:', errorMsg);
        showToast('‚úó Erro ao cadastrar solu√ß√£o: ' + errorMsg, 'error');
      }
    }

    // Fun√ß√£o para processar importa√ß√£o de planilha
    async function processarImportacao(event) {
      const file = event.target.files[0];
      if (!file) return;

      const statusDiv = document.getElementById('import-status');
      statusDiv.classList.remove('hidden');
      statusDiv.innerHTML = '<div class="flex items-center gap-2"><div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"></div><p class="text-sm">‚è≥ Processando arquivo...</p></div>';
      statusDiv.className = 'mt-4 p-4 rounded-lg bg-blue-50 text-blue-700 border-2 border-blue-200';

      try {
        let dados = [];
        const isExcel = /\.(xlsx|xls)$/i.test(file.name);

        if (isExcel && typeof XLSX !== 'undefined') {
          const ab = await file.arrayBuffer();
          const wb = XLSX.read(ab, { type: 'array', cellDates: true, cellNF: false });
          const ws = wb.Sheets[wb.SheetNames[0]] || wb.Sheets[0];
          if (!ws) throw new Error('Nenhuma planilha encontrada no arquivo.');
          // Usar raw: false para obter valores formatados, mas manter cellDates: true para datas
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false, dateNF: 'dd/mm/yyyy' });
          if (!rows || rows.length < 2) throw new Error('Planilha vazia ou sem dados.');
          const headers = (rows[0] || []).map(h => String(h || '').trim());
          for (let i = 1; i < rows.length; i++) {
            const values = rows[i] || [];
            if (values.every(v => v === undefined || v === null || v === '')) continue;
            const row = {};
            headers.forEach((h, j) => { 
              const val = values[j];
              // Se for um objeto Date, converter para string formatada
              if (val instanceof Date) {
                const day = String(val.getDate()).padStart(2, '0');
                const month = String(val.getMonth() + 1).padStart(2, '0');
                const year = val.getFullYear();
                row[h] = `${day}/${month}/${year}`;
              } else {
                row[h] = val !== undefined && val !== null ? String(val) : '';
              }
            });
            dados.push(row);
          }
        } else {
          const text = await file.text();
          const lines = text.split('\n').filter(line => line.trim());
          if (lines.length < 2) throw new Error('Arquivo vazio ou sem dados. Verifique se o arquivo cont√©m pelo menos um cabe√ßalho e uma linha de dados.');
          const parseCSVLine = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
              const char = line[i];
              if (char === '"') inQuotes = !inQuotes;
              else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
              else current += char;
            }
            result.push(current.trim());
            return result;
          };
          const headers = parseCSVLine(lines[0]).map(h => h.replace(/^"|"$/g, '').trim());
          for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]).map(v => v.replace(/^"|"$/g, '').trim());
            if (values.length === 0 || values.every(v => !v)) continue;
            const row = {};
            headers.forEach((header, index) => { row[header] = values[index] || ''; });
            dados.push(row);
          }
        }

        if (dados.length === 0) {
          throw new Error('Nenhum dado v√°lido encontrado no arquivo.');
        }

        // Fun√ß√£o auxiliar para buscar valor em coluna com varia√ß√µes de nome
        const buscarColuna = (row, variacoes) => {
          for (const variacao of variacoes) {
            if (row[variacao] !== undefined && row[variacao] !== null && String(row[variacao]).trim() !== '') {
              return String(row[variacao]).trim();
            }
          }
          // Busca case-insensitive e normalizando espa√ßos
          const rowKeys = Object.keys(row);
          for (const variacao of variacoes) {
            const variacaoNormalizada = variacao.toLowerCase().replace(/\s+/g, ' ').trim();
            const encontrado = rowKeys.find(k => k.toLowerCase().replace(/\s+/g, ' ').trim() === variacaoNormalizada);
            if (encontrado && row[encontrado] !== undefined && row[encontrado] !== null && String(row[encontrado]).trim() !== '') {
              return String(row[encontrado]).trim();
            }
          }
          return '';
        };

        // Mapear campos da planilha para o modelo
        let sucesso = 0;
        let erros = 0;
        const errosDetalhes = [];

        for (let idx = 0; idx < dados.length; idx++) {
          const row = dados[idx];
          try {
            // Mapear campos usando fun√ß√£o auxiliar
            const codigo = buscarColuna(row, ['C√≥digo', 'C√≥d', 'codigo']);
            const titulo = buscarColuna(row, ['T√≠tulo', 'Titulo', 'assessoria_nome', 'Nome', 'T√≠tulo/Nome da Solu√ß√£o']);
            const segmento = buscarColuna(row, ['Segmento', 'segmento']);
            const areaConhecimento = buscarColuna(row, ['√Årea de Conhecimento', 'Area de Conhecimento', 'area_conhecimento', '√Årea de conhecimento']);
            const temas = buscarColuna(row, ['Temas', 'temas']);
            const publicoAlvo = buscarColuna(row, ['P√∫blico Alvo', 'Publico Alvo', 'P√∫bli Alvo', 'Porte/P√∫blico Alvo']);
            // Mapear carga hor√°ria com v√°rias varia√ß√µes poss√≠veis
            const cargaHoraria = buscarColuna(row, ['Carga Hor√°ria', 'Carga hor√°ria', 'Car hor√°ria', 'Carga Horaria', 'carga_horaria', 'Carga Hor√°ria ']);
            const instrumento = buscarColuna(row, ['Instrumento', 'Instrumer', 'instrumento']);
            const fornecedor = buscarColuna(row, ['Fornecedor', 'Fornecedores Executores', 'fornecedor', 'Fornecedor Executor']);
            const proximaData = buscarColuna(row, ['Pr√≥xima data', 'Proxima data', 'proxima_data', 'Pr√≥xima Data']);
            let valor = parseFloat(buscarColuna(row, ['Valor', 'valor', 'Valor (R$)', 'Valor (R$)']));
            if (isNaN(valor) || valor < 0) { 
              const pago = buscarColuna(row, ['Pago', 'Pa', 'pago']);
              valor = (pago === 'Sim' || pago === 'sim' || pago === 'SIM') ? 1 : 0; 
            }
            const descricao = buscarColuna(row, ['Descri√ß√£o', 'Descricao', 'Descr', 'assessoria_descricao', 'Descri√ß√£o da Solu√ß√£o']) || titulo;

            // Determinar porte: coluna Porte (export) ou p√∫blico alvo
            let porte = (row['Porte'] || '').toString().trim();
            if (porte) porte = porte.toUpperCase();
            if (!porte) {
              if (publicoAlvo.includes('MEI')) porte = 'MEI';
              else if (publicoAlvo.includes('ME')) porte = 'ME';
              else if (publicoAlvo.includes('EPP')) porte = 'EPP';
            }
            if (porte && !['MEI','ME','EPP'].includes(porte)) porte = '';
            
            // Normalizar setor para valores do enum
            let setor = (row['Setor'] || '').toString().trim();
            if (setor === 'Com√©rcio') setor = 'Comercio';
            else if (setor === 'Ind√∫stria') setor = 'Industria';
            else if (setor === 'Servi√ßos') setor = 'Servicos';
            else if (setor === 'Multissetorial') setor = 'Multissetorial';

            // Determinar tipo de momento e categoria; usar sempre IDs v√°lidos para aparecer na consulta
            // Primeiro verificar se os campos foram exportados diretamente
            var momento_empresarial = (row['Momento Empresarial'] || row['momento_empresarial'] || '').toString().trim();
            var crescimento_empresarial = (row['Foco Principal da Dor'] || row['crescimento_empresarial'] || '').toString().trim();
            
            // Se n√£o encontrados diretamente, tentar determinar pelo tipo de momento
            if (!momento_empresarial && !crescimento_empresarial) {
              var tipoStrImp = (row['Tipo Momento'] || row['Tipo de Momento'] || 'empresarial').toString().toLowerCase();
              var isCrescImp = tipoStrImp.indexOf('crescimento') >= 0;
              var categoria = (row['Categoria'] || areaConhecimento || temas || 'Gerencie').toString().trim();
              
              if (isCrescImp) {
                // Se categoria vazia ou "Nenhuma", deixar null
                if (!categoria || categoria === 'Nenhuma' || categoria.trim() === '') {
                  crescimento_empresarial = null;
                } else {
                  crescimento_empresarial = (VALID_CRESCIMENTO && VALID_CRESCIMENTO.indexOf(categoria) >= 0) ? categoria : 'Marketing e Vendas';
                }
              } else {
                momento_empresarial = (VALID_EMPRESARIAL && VALID_EMPRESARIAL.indexOf(categoria) >= 0) ? categoria : 'Gerencie';
              }
            } else {
              // Validar valores se foram encontrados diretamente
              if (momento_empresarial && VALID_EMPRESARIAL && VALID_EMPRESARIAL.indexOf(momento_empresarial) < 0) {
                momento_empresarial = '';
              }
              if (crescimento_empresarial && (!VALID_CRESCIMENTO || VALID_CRESCIMENTO.indexOf(crescimento_empresarial) < 0)) {
                crescimento_empresarial = '';
              }
              // Converter strings vazias para null
              if (momento_empresarial === '') momento_empresarial = null;
              if (crescimento_empresarial === '') crescimento_empresarial = null;
            }

            // Valida√ß√£o
            if (!titulo) {
              erros++;
              errosDetalhes.push(`Linha ${idx + 2}: T√≠tulo obrigat√≥rio`);
              continue;
            }
            if (!porte) {
              erros++;
              errosDetalhes.push(`Linha ${idx + 2}: Porte n√£o identificado (MEI/ME/EPP)`);
              continue;
            }
            if (!setor) {
              erros++;
              errosDetalhes.push(`Linha ${idx + 2}: Setor obrigat√≥rio`);
              continue;
            }

            const ordemVal = parseInt(row['Ordem'], 10);
            
            // Fun√ß√£o auxiliar para normalizar campos de texto (preservar string vazia como null)
            const normalizarTexto = (valor) => {
              if (valor === null || valor === undefined) return null;
              const str = String(valor).trim();
              return str === '' ? null : str;
            };
            
            // Fun√ß√£o auxiliar para normalizar data (aceita v√°rios formatos)
            const normalizarData = (valor) => {
              if (!valor || valor === null || valor === undefined) return null;
              
              // Se for um objeto Date, converter diretamente
              if (valor instanceof Date) {
                if (isNaN(valor.getTime())) return null;
                const day = String(valor.getDate()).padStart(2, '0');
                const month = String(valor.getMonth() + 1).padStart(2, '0');
                const year = valor.getFullYear();
                return `${day}/${month}/${year}`;
              }
              
              const str = String(valor).trim();
              if (str === '' || str.toLowerCase() === 'a definir' || str.toLowerCase() === 'a definir' || str.toLowerCase() === 'a definir') {
                return null;
              }
              
              // Tentar converter diferentes formatos de data do Excel
              // Excel pode retornar n√∫meros (dias desde 1900-01-01) ou strings formatadas
              const numVal = Number(str);
              if (!isNaN(numVal) && numVal > 0 && numVal < 100000) {
                // Pode ser um n√∫mero serial do Excel (dias desde 1900-01-01)
                // Converter para data
                try {
                  // Excel usa 1 de janeiro de 1900 como dia 1, mas tem um bug: considera 1900 como bissexto
                  // Ent√£o usamos 30 de dezembro de 1899 como base
                  const excelEpoch = new Date(1899, 11, 30); // 30 de dezembro de 1899
                  const days = numVal;
                  const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
                  if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                    // Formatar como DD/MM/YYYY
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                  }
                } catch (e) {
                  // Se falhar, continuar para outros formatos
                }
              }
              
              // Tentar parsear como data ISO (YYYY-MM-DD ou YYYY-MM-DDTHH:mm:ss)
              if (str.match(/^\d{4}-\d{2}-\d{2}/)) {
                try {
                  const date = new Date(str);
                  if (!isNaN(date.getTime())) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                  }
                } catch (e) {
                  // Se falhar, continuar
                }
              }
              
              // Tentar parsear formato brasileiro (DD/MM/YYYY)
              if (str.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                // Validar se √© uma data v√°lida
                try {
                  const parts = str.split('/');
                  if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
                      return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
                    }
                  }
                } catch (e) {
                  // Se falhar, retornar o valor original
                }
                return str; // J√° est√° no formato correto
              }
              
              // Tentar parsear formato americano (MM/DD/YYYY)
              if (str.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                try {
                  const parts = str.split('/');
                  if (parts.length === 3) {
                    const month = parseInt(parts[0]);
                    const day = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    // Se m√™s > 12, provavelmente √© formato brasileiro
                    if (month > 12) {
                      return str; // J√° est√° no formato brasileiro
                    }
                    const date = new Date(year, month - 1, day);
                    if (!isNaN(date.getTime()) && date.getDate() === day && date.getMonth() === month - 1) {
                      return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
                    }
                  }
                } catch (e) {
                  // Se falhar, retornar o valor original
                }
              }
              
              // Tentar parsear como data gen√©rica (pode ser qualquer formato reconhecido pelo JavaScript)
              try {
                const date = new Date(str);
                if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                  const day = String(date.getDate()).padStart(2, '0');
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const year = date.getFullYear();
                  return `${day}/${month}/${year}`;
                }
              } catch (e) {
                // Se falhar, retornar o valor original
              }
              
              // Se n√£o conseguir parsear, retornar o valor original (pode ser texto como "A definir")
              return str;
            };
            
            const novaAssessoria = {
              id: `assess-${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${idx}`,
              codigo: normalizarTexto(codigo),
              momento_empresarial: normalizarTexto(momento_empresarial),
              crescimento_empresarial: normalizarTexto(crescimento_empresarial),
              porte: porte,
              setor: setor,
              assessoria_nome: titulo.trim(),
              assessoria_descricao: normalizarTexto(descricao),
              segmento: normalizarTexto(segmento),
              area_conhecimento: normalizarTexto(areaConhecimento),
              temas: normalizarTexto(temas),
              carga_horaria: normalizarTexto(cargaHoraria),
              instrumento: normalizarTexto(instrumento),
              fornecedor: normalizarTexto(fornecedor),
              proxima_data: normalizarData(proximaData),
              valor: valor,
              ordem: !isNaN(ordemVal) ? ordemVal : 1,
              link_direcionamento: normalizarTexto(buscarColuna(row, ['Link de Direcionamento', 'Link', 'link_direcionamento'])),
              criado_em: new Date().toISOString()
            };

            const result = await adicionarSolucao(novaAssessoria);
            if (result && result.isOk) {
              sucesso++;
            } else {
              erros++;
              errosDetalhes.push(`Linha ${idx + 2}: Erro ao salvar - ${(result && result.error) || 'Erro desconhecido'}`);
            }
          } catch (err) {
            erros++;
            errosDetalhes.push(`Linha ${idx + 2}: ${err.message || 'Erro ao processar'}`);
            console.error('Erro ao processar linha:', err);
          }
        }

        // Feedback detalhado
        let feedbackHTML = `
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <span class="text-2xl">${sucesso > 0 ? '‚úì' : '‚ö†Ô∏è'}</span>
              <div>
                <p class="text-sm font-bold">Importa√ß√£o conclu√≠da!</p>
                <p class="text-xs">${sucesso} solu√ß√£o(√µes) importada(s) com sucesso</p>
                ${erros > 0 ? `<p class="text-xs text-red-600">${erros} erro(s) encontrado(s)</p>` : ''}
              </div>
            </div>
        `;

        if (errosDetalhes.length > 0 && errosDetalhes.length <= 10) {
          feedbackHTML += `
            <details class="mt-2">
              <summary class="text-xs cursor-pointer font-semibold text-red-600">Ver detalhes dos erros</summary>
              <ul class="mt-2 text-xs space-y-1 list-disc list-inside">
                ${errosDetalhes.map(e => `<li>${e}</li>`).join('')}
              </ul>
            </details>
          `;
        }

        feedbackHTML += '</div>';

        statusDiv.innerHTML = feedbackHTML;
        
        if (sucesso > 0 && erros === 0) {
          statusDiv.className = 'mt-4 p-4 rounded-lg bg-green-50 text-green-700 border-2 border-green-200';
          showToast(`‚úì ${sucesso} solu√ß√£o(√µes) importada(s) com sucesso!`, 'success');
        } else if (sucesso > 0 && erros > 0) {
          statusDiv.className = 'mt-4 p-4 rounded-lg bg-yellow-50 text-yellow-700 border-2 border-yellow-200';
          showToast(`‚ö†Ô∏è ${sucesso} importada(s), ${erros} erro(s)`, 'error');
        } else {
          statusDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 text-red-700 border-2 border-red-200';
          showToast(`‚úó Nenhuma solu√ß√£o foi importada. Verifique os erros.`, 'error');
        }

        atualizarListaAssessorias();
        event.target.value = ''; // Reset file input

      } catch (error) {
        statusDiv.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="text-2xl">‚úó</span>
            <div>
              <p class="text-sm font-bold">Erro ao processar arquivo</p>
              <p class="text-xs">${error.message}</p>
            </div>
          </div>
        `;
        statusDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 text-red-700 border-2 border-red-200';
        showToast(`‚úó Erro: ${error.message}`, 'error');
      }
    }

    // Fun√ß√£o para baixar modelo de planilha
    function baixarModeloPlanilha() {
      const headers = [
        'C√≥d', 'T√≠tulo', 'Descr', 'Setor', 'Segmento', 'Porte', 'P√∫bli Alvo',
        '√Årea de Conhecimento', 'Temas', 'Car hor√°ria', 'Instrumer', 'Valor', 'Fornecedores Executores', 'Pr√≥xima data', 'Ordem', 'Link de Direcionamento'
      ];

      const exemplo = [
        '6174', 'Aprenda a ajustar e reformar roupas (Presencial)',
        'Curso do Sebrae', 'Industria', 'Vestu√°rio', 'MEI', 'MEI, Poten',
        'Gest√£o da Produ√ß√£o', 'Gest√£o da Qualidade', '14', 'Cursos Presenciais', '0', 'SENAI', '15/03/2026', '1', 'https://www.sebrae.com.br/solucao'
      ];

      const csv = [headers.join(','), exemplo.join(',')].join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'modelo_solucoes_sebrae.csv';
      link.click();
      showToast('‚úì Modelo de planilha baixado!', 'success');
    }

    // Exportar dados atuais para Excel
    function exportarParaExcel() {
      if (typeof XLSX === 'undefined') {
        showToast('Biblioteca Excel n√£o carregada. Recarregue a p√°gina.', 'error');
        return;
      }
      if (assessoriasData.length === 0) {
        showToast('Nenhuma solu√ß√£o para exportar.', 'error');
        return;
      }
      const rows = assessoriasData.map(a => ({
        'C√≥digo': a.codigo || '',
        'Momento Empresarial': a.momento_empresarial || '',
        'Foco Principal da Dor': a.crescimento_empresarial || '',
        'T√≠tulo': a.assessoria_nome || '',
        'Descri√ß√£o': a.assessoria_descricao || '',
        'Porte': a.porte || '',
        'Setor': a.setor || '',
        'Segmento': a.segmento || '',
        '√Årea de Conhecimento': a.area_conhecimento || '',
        'Temas': a.temas || '',
        'Carga Hor√°ria': a.carga_horaria || '',
        'Instrumento': a.instrumento || '',
        'Fornecedor': a.fornecedor || '',
        'Pr√≥xima data': a.proxima_data || '',
        'Valor': (function(){ var v = a.valor; var n = (v != null && v !== '') ? Number(v) : NaN; return (!isNaN(n) && n >= 0) ? n : 0; })(),
        'Ordem': a.ordem || 1,
        'Link de Direcionamento': a.link_direcionamento || ''
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Solu√ß√µes');
      XLSX.writeFile(wb, 'solucoes_sebrae_' + new Date().toISOString().slice(0,10) + '.xlsx');
      showToast('‚úì Planilha exportada!', 'success');
    }

    // Vari√°vel para armazenar dados filtrados
    let assessoriasFiltradas = [];

    function aplicarFiltroData() {
      const dataInicial = document.getElementById('filtro-data-inicial').value;
      const dataFinal = document.getElementById('filtro-data-final').value;
      
      assessoriasFiltradas = assessoriasData.filter(assessoria => {
        if (!assessoria.proxima_data || assessoria.proxima_data.trim() === '') {
          return false; // N√£o mostrar solu√ß√µes sem pr√≥xima_data quando h√° filtro
        }
        
        // Converter proxima_data para Date
        let dataObj = null;
        const dataStr = assessoria.proxima_data.trim();
        
        // Tentar formato brasileiro DD/MM/YYYY
        if (dataStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
          const [dia, mes, ano] = dataStr.split('/');
          dataObj = new Date(ano, mes - 1, dia);
        } 
        // Tentar formato ISO YYYY-MM-DD
        else if (dataStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
          dataObj = new Date(dataStr);
        }
        // Tentar parse direto
        else {
          dataObj = new Date(dataStr);
        }
        
        if (!dataObj || isNaN(dataObj.getTime())) {
          return false;
        }
        
        // Aplicar filtros de data
        if (dataInicial) {
          const inicio = new Date(dataInicial);
          inicio.setHours(0, 0, 0, 0);
          if (dataObj < inicio) return false;
        }
        
        if (dataFinal) {
          const fim = new Date(dataFinal);
          fim.setHours(23, 59, 59, 999);
          if (dataObj > fim) return false;
        }
        
        return true;
      });
      
      atualizarListaAssessorias();
    }

    function limparFiltroData() {
      document.getElementById('filtro-data-inicial').value = '';
      document.getElementById('filtro-data-final').value = '';
      assessoriasFiltradas = [];
      atualizarListaAssessorias();
    }

    function atualizarListaAssessorias() {
      const lista = document.getElementById('lista-assessorias');
      const listaVazia = document.getElementById('lista-vazia');
      const totalElement = document.getElementById('total-assessorias');
      const barraMassa = document.getElementById('barra-exclusao-massa');
      
      // Usar dados filtrados se houver filtro ativo, sen√£o usar todos
      const filtroInicial = document.getElementById('filtro-data-inicial');
      const filtroFinal = document.getElementById('filtro-data-final');
      const dataInicial = filtroInicial ? filtroInicial.value : '';
      const dataFinal = filtroFinal ? filtroFinal.value : '';
      const temFiltro = dataInicial || dataFinal;
      const dadosParaExibir = temFiltro ? assessoriasFiltradas : assessoriasData;
      
      totalElement.textContent = dadosParaExibir.length;
      
      if (dadosParaExibir.length === 0) {
        lista.innerHTML = '';
        if (barraMassa) barraMassa.classList.add('hidden');
        listaVazia.classList.remove('hidden');
        if (temFiltro) {
          listaVazia.innerHTML = '<p style="color: #999;">Nenhuma solu√ß√£o encontrada com os filtros de data selecionados</p>';
        } else {
          listaVazia.innerHTML = '<p style="color: #999;">Nenhuma solu√ß√£o cadastrada ainda</p>';
        }
        return;
      }
      
      listaVazia.classList.add('hidden');
      if (barraMassa) barraMassa.classList.remove('hidden');
      const cbTodas = document.getElementById('cb-selecionar-todas');
      if (cbTodas) cbTodas.checked = false;
      
      const ordenadas = [...dadosParaExibir].sort((a, b) => {
        const momentoA = a.momento_empresarial || a.crescimento_empresarial;
        const momentoB = b.momento_empresarial || b.crescimento_empresarial;
        return momentoA.localeCompare(momentoB) || a.ordem - b.ordem;
      });
      
      lista.innerHTML = ordenadas.map(assessoria => {
        const momento = assessoria.momento_empresarial || assessoria.crescimento_empresarial;
        const tipoMomento = assessoria.momento_empresarial ? 'Empresarial' : 'Crescimento';
        const v = assessoria.valor; const n = (v != null && v !== '') ? Number(v) : NaN;
        const temValor = !isNaN(n) && n > 0;
        const legadoPago = assessoria.pago === 'Sim';
        const valorTexto = temValor ? ('R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })) : (legadoPago ? 'Pago' : 'üÜì Gratuito');
        const valorBadgeColor = (temValor || legadoPago) ? '#B45309' : '#00A859';
        const valorBadgeBg = (temValor || legadoPago) ? '#FFEDD5' : '#E8F7F0';
        const bid = String(assessoria.__backendId || assessoria.id);
        return `
          <div class="bg-gradient-to-r from-blue-50 to-white border-2 rounded-lg p-4" style="border-color: #E0E0E0;">
            <div class="flex items-start justify-between gap-3">
              <input type="checkbox" class="cb-excluir-assessoria h-4 w-4 mt-1 flex-shrink-0" value="${bid}" onchange="atualizarBotaoExcluirSelecionadas()" title="Selecionar para exclus√£o">
              <div class="flex-1 min-w-0">
                <div class="flex flex-wrap gap-2 mb-2">
                  <span class="badge" style="background-color: #E3ECEE; color: #00608B; font-size: 0.7rem;">${tipoMomento}</span>
                  <span class="badge" style="background-color: #E3ECEE; color: #00608B; font-size: 0.7rem;">${momento}</span>
                  <span class="badge" style="background-color: #E8F7F0; color: #00A859; font-size: 0.7rem;">${assessoria.porte}</span>
                  <span class="badge" style="background-color: #FFF4E6; color: #FF8C00; font-size: 0.7rem;">${assessoria.setor}</span>
                  <span class="badge" style="background-color: ${valorBadgeBg}; color: ${valorBadgeColor}; font-size: 0.7rem;">${valorTexto}</span>
                  <span class="badge" style="background-color: #00608B; color: white; font-size: 0.7rem;">Ordem ${assessoria.ordem}</span>
                </div>
                <h5 class="font-bold text-base mb-1" style="color: #00608B;">${assessoria.assessoria_nome}</h5>
                <p class="text-sm line-clamp-2" style="color: #666;">${assessoria.assessoria_descricao}</p>
                ${assessoria.proxima_data ? `<p class="text-xs mt-1" style="color: #666;"><strong>Pr√≥xima data:</strong> ${assessoria.proxima_data}</p>` : ''}
                ${assessoria.link_direcionamento ? `<p class="text-xs mt-2"><a href="${assessoria.link_direcionamento}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">üîó ${assessoria.link_direcionamento}</a></p>` : ''}
              </div>
              <div class="flex gap-2 flex-shrink-0">
                <button onclick="copiarAssessoria('${bid}')" class="px-3 py-2 bg-green-50 hover:bg-green-100 rounded-lg transition-all" style="color: #00A859;" title="Copiar/Duplicar">
                  <span class="text-xl">üìã</span>
                </button>
                <button onclick="editarAssessoria('${bid}')" class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded-lg transition-all" style="color: #00608B;" title="Editar">
                  <span class="text-xl">‚úèÔ∏è</span>
                </button>
                <button onclick="excluirAssessoria('${bid}')" class="px-3 py-2 bg-red-50 hover:bg-red-100 rounded-lg transition-all" style="color: #DC2626;" title="Excluir">
                  <span class="text-xl">üóëÔ∏è</span>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      atualizarBotaoExcluirSelecionadas();
    }

    function marcarDesmarcarTodas(checked) {
      document.querySelectorAll('.cb-excluir-assessoria').forEach(cb => { cb.checked = checked; });
      const cbAll = document.getElementById('cb-selecionar-todas');
      if (cbAll) cbAll.checked = checked;
      atualizarBotaoExcluirSelecionadas();
    }

    function atualizarBotaoExcluirSelecionadas() {
      const cbs = document.querySelectorAll('.cb-excluir-assessoria');
      const n = document.querySelectorAll('.cb-excluir-assessoria:checked').length;
      const btn = document.getElementById('btn-excluir-selecionadas');
      const cbAll = document.getElementById('cb-selecionar-todas');
      if (btn) { btn.disabled = n === 0; btn.textContent = n > 0 ? 'Excluir selecionadas (' + n + ')' : 'Excluir selecionadas'; }
      if (cbAll && cbs.length) cbAll.checked = n === cbs.length;
    }

    async function excluirSelecionadas() {
      const ids = Array.from(document.querySelectorAll('.cb-excluir-assessoria:checked')).map(cb => cb.value);
      if (ids.length === 0) return;
      const toRemove = ids.map(id => assessoriasData.find(a => (a.__backendId || a.id) === id)).filter(Boolean);
      if (toRemove.length === 0) return;
      const div = document.createElement('div');
      div.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in';
      div.innerHTML = '<div class="bg-white rounded-xl shadow-2xl p-8 max-w-md mx-4"><h3 class="text-2xl font-bold mb-4" style="color: #DC2626;">Exclus√£o em massa</h3><p class="mb-6" style="color: #666;">Deseja excluir <strong>' + toRemove.length + ' solu√ß√£o(√µes)</strong> selecionada(s)?</p><div class="flex gap-3"><button id="btn-confirmar-massa" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg">Sim, Excluir</button><button id="btn-cancelar-massa" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 font-bold rounded-lg" style="color: #333;">Cancelar</button></div></div>';
      document.body.appendChild(div);
      document.getElementById('btn-confirmar-massa').onclick = async function() {
        document.getElementById('btn-confirmar-massa').disabled = true;
        document.getElementById('btn-confirmar-massa').textContent = 'Excluindo...';
        for (const a of toRemove) await removerSolucao(a);
        div.remove();
        showToast(toRemove.length + ' solu√ß√£o(√µes) exclu√≠da(s).', 'success');
        atualizarListaAssessorias();
      };
      document.getElementById('btn-cancelar-massa').onclick = function() { div.remove(); };
    }

    async function excluirAssessoria(backendId) {
      const assessoria = assessoriasData.find(a => (a.__backendId || a.id) === backendId);
      
      if (!assessoria) return;

      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md mx-4">
          <h3 class="text-2xl font-bold mb-4" style="color: #DC2626;">‚ö†Ô∏è Confirmar Exclus√£o</h3>
          <p class="mb-6" style="color: #666;">Deseja realmente excluir a solu√ß√£o "<strong>${assessoria.assessoria_nome}</strong>"?</p>
          <div class="flex gap-3">
            <button id="btn-confirmar-exclusao" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-all">
              Sim, Excluir
            </button>
            <button id="btn-cancelar-exclusao" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 font-bold rounded-lg transition-all" style="color: #333;">
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmDiv);
      
      document.getElementById('btn-confirmar-exclusao').addEventListener('click', async () => {
        document.getElementById('btn-confirmar-exclusao').disabled = true;
        document.getElementById('btn-confirmar-exclusao').textContent = 'Excluindo...';
        
        const result = await removerSolucao(assessoria);
        
        confirmDiv.remove();
        
        if (result && result.isOk) {
          showToast('‚úì Solu√ß√£o exclu√≠da com sucesso!', 'success');
          atualizarListaAssessorias();
        } else {
          showToast('‚úó Erro ao excluir solu√ß√£o.', 'error');
        }
      });
      
      document.getElementById('btn-cancelar-exclusao').addEventListener('click', () => {
        confirmDiv.remove();
      });
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-xl text-white font-semibold z-50 fade-in';
      toast.style.backgroundColor = type === 'success' ? '#00A859' : '#DC2626';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3500);
    }

    function trocarAba(aba) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.sidebar-nav-item').forEach(b => b.classList.remove('active'));
      const navBusca = document.getElementById('nav-busca');
      const navJornadas = document.getElementById('nav-jornadas');
      const navFerramentas = document.getElementById('nav-ferramentas');
      const navCalendario = document.getElementById('nav-calendario');
      const navGestao = document.getElementById('nav-gestao');
      if (aba === 'consulta') {
        document.getElementById('aba-consulta').classList.add('active');
        if (navBusca) { navBusca.classList.add('active'); navBusca.setAttribute('aria-current','page'); }
        if (navJornadas) navJornadas.removeAttribute('aria-current');
        if (navFerramentas) navFerramentas.removeAttribute('aria-current');
        if (navCalendario) navCalendario.removeAttribute('aria-current');
        if (navGestao) navGestao.removeAttribute('aria-current');
      } else if (aba === 'jornadas') {
        document.getElementById('aba-jornadas').classList.add('active');
        carregarTodasJornadas();
        if (navJornadas) { navJornadas.classList.add('active'); navJornadas.setAttribute('aria-current','page'); }
        if (navBusca) { navBusca.classList.remove('active'); navBusca.removeAttribute('aria-current'); }
        if (navFerramentas) navFerramentas.removeAttribute('aria-current');
        if (navCalendario) navCalendario.removeAttribute('aria-current');
        if (navGestao) navGestao.removeAttribute('aria-current');
      } else if (aba === 'ferramentas') {
        document.getElementById('aba-ferramentas').classList.add('active');
        atualizarFiltroDorFerramentas();
        renderListaFerramentas();
        if (navFerramentas) { navFerramentas.classList.add('active'); navFerramentas.setAttribute('aria-current','page'); }
        if (navBusca) { navBusca.classList.remove('active'); navBusca.removeAttribute('aria-current'); }
        if (navJornadas) navJornadas.classList.remove('active'); navJornadas.removeAttribute('aria-current');
        if (navCalendario) navCalendario.removeAttribute('aria-current');
        if (navGestao) navGestao.removeAttribute('aria-current');
      } else if (aba === 'calendario') {
        document.getElementById('aba-calendario').classList.add('active');
        // Carregar calend√°rio quando a aba for aberta
        setTimeout(() => {
          carregarCalendario();
        }, 100);
        if (navCalendario) { navCalendario.classList.add('active'); navCalendario.setAttribute('aria-current','page'); }
        if (navBusca) { navBusca.classList.remove('active'); navBusca.removeAttribute('aria-current'); }
        if (navJornadas) navJornadas.classList.remove('active'); navJornadas.removeAttribute('aria-current');
        if (navFerramentas) navFerramentas.removeAttribute('aria-current');
        if (navGestao) navGestao.removeAttribute('aria-current');
      } else if (aba === 'gerenciamento') {
        document.getElementById('aba-gerenciamento').classList.add('active');
        atualizarListaAssessorias();
        if (navGestao) { navGestao.classList.add('active'); navGestao.setAttribute('aria-current','page'); }
        if (navBusca) { navBusca.classList.remove('active'); navBusca.removeAttribute('aria-current'); }
        if (navJornadas) navJornadas.classList.remove('active'); navJornadas.removeAttribute('aria-current');
        if (navFerramentas) navFerramentas.removeAttribute('aria-current');
        if (navCalendario) navCalendario.removeAttribute('aria-current');
      }
    }

    function atualizarFiltroDorFerramentas() {
      const tipo = (document.getElementById('ferramentas-tipo-momento') || {}).value || '';
      const selectDor = document.getElementById('ferramentas-dor');
      if (!selectDor) return;
      if (tipo === 'empresarial') {
        selectDor.innerHTML = '<option value="">Todas</option>';
        momentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectDor.appendChild(option);
        });
      } else if (tipo === 'crescimento') {
        selectDor.innerHTML = '<option value="">Todas</option>';
        crescimentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectDor.appendChild(option);
        });
      } else {
        selectDor.innerHTML = '<option value="">Todas</option>';
        momentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectDor.appendChild(option);
        });
        crescimentoEmpresarial.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.titulo;
          selectDor.appendChild(option);
        });
      }
    }

    function renderListaFerramentas() {
      const lista = document.getElementById('lista-ferramentas');
      const vazia = document.getElementById('ferramentas-vazia');
      if (!lista) return;
      const tipo = (document.getElementById('ferramentas-tipo-momento') || {}).value || '';
      const dor = (document.getElementById('ferramentas-dor') || {}).value || '';
      const filtradas = sugestoesData.filter(s => {
        if (!s.ativo) return false;
        if (tipo && s.tipo_momento && s.tipo_momento !== tipo) return false;
        if (dor && s.crescimento_empresarial !== dor) return false;
        return true;
      });
      const ordenadas = filtradas.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
      if (ordenadas.length === 0) {
        lista.innerHTML = '';
        if (vazia) vazia.classList.remove('hidden');
        return;
      }
      if (vazia) vazia.classList.add('hidden');
      lista.innerHTML = ordenadas.map(s => {
        const momentoLabel = s.tipo_momento === 'empresarial' ? 'Momento Empresarial' : (s.tipo_momento === 'crescimento' ? 'Crescimento Empresarial' : '');
        const dorLabel = s.crescimento_empresarial || '';
        return `
          <div class="bg-white rounded-xl shadow-lg p-6 border-2 hover:shadow-xl transition-all" style="border-color: #E0E0E0;">
            <div class="flex flex-wrap gap-2 mb-3">
              ${momentoLabel ? `<span class="badge" style="background-color: #E3ECEE; color: #00608B; font-size: 0.75rem;">${momentoLabel}</span>` : ''}
              ${dorLabel ? `<span class="badge" style="background-color: #E8F7F0; color: #00A859; font-size: 0.75rem;">${dorLabel}</span>` : ''}
            </div>
            <h4 class="text-xl font-bold mb-2" style="color: #00608B;">${(s.titulo || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h4>
            ${s.desconto ? `<p class="text-sm mb-2" style="color: #059669;"><strong>Desconto:</strong> <span class="text-lg font-bold" style="color: #047857;">${(s.desconto || '').replace(/</g, '&lt;')}</span></p>` : ''}
            ${s.descricao ? `<p class="text-sm mb-4" style="color: #666;">${(s.descricao || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').substring(0, 200)}${(s.descricao || '').length > 200 ? '...' : ''}</p>` : ''}
            ${s.restritivos ? `<p class="text-xs mb-2" style="color: #B45309;"><strong>Restritivos:</strong> ${(s.restritivos || '').replace(/</g, '&lt;')}</p>` : ''}
            ${s.link ? `<a href="${s.link.replace(/"/g, '&quot;')}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-white transition-all hover:scale-105" style="background: linear-gradient(135deg, #00608B 0%, #0092BA 100%);">Acessar ferramenta</a>` : ''}
          </div>
        `;
      }).join('');
    }

    function naoPresisoMelhorar() {
      selecao.categorias = ['Nenhuma'];
      
      const btnId = selecao.tipoMomento === 'empresarial' ? 'btn-avancar-momento' : 'btn-avancar-crescimento';
      document.getElementById(btnId).disabled = false;
      
      avancarParaPorte();
    }

    // Fun√ß√£o para copiar/duplicar solu√ß√£o
    function copiarAssessoria(backendId) {
      const assessoria = assessoriasData.find(a => (a.__backendId || a.id) === backendId);
      if (!assessoria) {
        showToast('Solu√ß√£o n√£o encontrada', 'error');
        return;
      }

      // Preencher formul√°rio com dados da solu√ß√£o (c√≥pia)
      document.getElementById('cad-codigo').value = assessoria.codigo || '';
      // Adicionar sufixo "(C√≥pia)" ao nome se n√£o tiver j√°
      const nomeOriginal = assessoria.assessoria_nome || '';
      const nomeComCopia = nomeOriginal.includes('(C√≥pia)') ? nomeOriginal : nomeOriginal + ' (C√≥pia)';
      document.getElementById('cad-nome').value = nomeComCopia;
      document.getElementById('cad-descricao').value = assessoria.assessoria_descricao || '';
      document.getElementById('cad-porte').value = assessoria.porte || '';
      document.getElementById('cad-setor').value = assessoria.setor || '';
      document.getElementById('cad-segmento').value = assessoria.segmento || '';
      document.getElementById('cad-area-conhecimento').value = assessoria.area_conhecimento || '';
      document.getElementById('cad-carga-horaria').value = assessoria.carga_horaria || '';
      document.getElementById('cad-instrumento').value = assessoria.instrumento || '';
      document.getElementById('cad-fornecedor').value = assessoria.fornecedor || '';
      document.getElementById('cad-proxima-data').value = assessoria.proxima_data || '';
      document.getElementById('cad-valor').value = assessoria.valor || 0;
      document.getElementById('cad-ordem').value = assessoria.ordem || 1;
      document.getElementById('cad-link-direcionamento').value = assessoria.link_direcionamento || '';

      // Determinar tipo de momento e categoria
      if (assessoria.momento_empresarial) {
        document.getElementById('cad-tipo-momento').value = 'empresarial';
        atualizarCategorias();
        document.getElementById('cad-categoria').value = assessoria.momento_empresarial || '';
      } else {
        // Se n√£o tem momento_empresarial, √© crescimento (pode ser null para "Nenhuma")
        document.getElementById('cad-tipo-momento').value = 'crescimento';
        atualizarCategorias();
        // Se crescimento_empresarial √© null ou vazio, selecionar "Nenhuma" (value="")
        document.getElementById('cad-categoria').value = assessoria.crescimento_empresarial || '';
      }

      // Garantir que o bot√£o est√° como "Cadastrar" (n√£o "Atualizar")
      const btnCadastrar = document.getElementById('btn-cadastrar');
      btnCadastrar.textContent = '‚úì Cadastrar Solu√ß√£o';
      btnCadastrar.type = 'submit';
      btnCadastrar.onclick = null; // Remover qualquer handler de atualiza√ß√£o
      btnCadastrar.disabled = false;

      // Trocar para a aba de cadastro se n√£o estiver nela
      trocarAba('gerenciamento');
      
      // Scroll para o formul√°rio
      setTimeout(() => {
        document.getElementById('cadastro-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
      showToast('‚úì Dados copiados! Edite e clique em "Cadastrar Solu√ß√£o" para criar uma nova solu√ß√£o.', 'success');
    }

    // Fun√ß√£o para editar solu√ß√£o
    async function editarAssessoria(backendId) {
      const assessoria = assessoriasData.find(a => (a.__backendId || a.id) === backendId);
      if (!assessoria) return;

      // Preencher formul√°rio com dados da solu√ß√£o
      document.getElementById('cad-codigo').value = assessoria.codigo || '';
      document.getElementById('cad-nome').value = assessoria.assessoria_nome || '';
      document.getElementById('cad-descricao').value = assessoria.assessoria_descricao || '';
      document.getElementById('cad-porte').value = assessoria.porte || '';
      document.getElementById('cad-setor').value = assessoria.setor || '';
      document.getElementById('cad-segmento').value = assessoria.segmento || '';
      document.getElementById('cad-area-conhecimento').value = assessoria.area_conhecimento || '';
      document.getElementById('cad-carga-horaria').value = assessoria.carga_horaria || '';
      document.getElementById('cad-instrumento').value = assessoria.instrumento || '';
      document.getElementById('cad-fornecedor').value = assessoria.fornecedor || '';
      document.getElementById('cad-proxima-data').value = assessoria.proxima_data || '';
      document.getElementById('cad-valor').value = assessoria.valor || 0;
      document.getElementById('cad-ordem').value = assessoria.ordem || 1;
      document.getElementById('cad-link-direcionamento').value = assessoria.link_direcionamento || '';

      // Determinar tipo de momento e categoria
      if (assessoria.momento_empresarial) {
        document.getElementById('cad-tipo-momento').value = 'empresarial';
        atualizarCategorias();
        document.getElementById('cad-categoria').value = assessoria.momento_empresarial || '';
      } else {
        // Se n√£o tem momento_empresarial, √© crescimento (pode ser null para "Nenhuma")
        document.getElementById('cad-tipo-momento').value = 'crescimento';
        atualizarCategorias();
        // Se crescimento_empresarial √© null ou vazio, selecionar "Nenhuma" (value="")
        document.getElementById('cad-categoria').value = assessoria.crescimento_empresarial || '';
      }

      // Alterar bot√£o para "Atualizar"
      const btnCadastrar = document.getElementById('btn-cadastrar');
      btnCadastrar.textContent = 'üíæ Atualizar Solu√ß√£o';
      btnCadastrar.type = 'button';
      btnCadastrar.onclick = async (e) => {
        e.preventDefault();
        await atualizarAssessoria(backendId, e);
      };

      // Scroll para o formul√°rio
      document.getElementById('cadastro-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
      showToast('Formul√°rio preenchido. Edite e clique em "Atualizar Solu√ß√£o"', 'success');
    }

    // Fun√ß√£o para atualizar solu√ß√£o
    async function atualizarAssessoria(backendId, e) {
      e.preventDefault();
      const assessoria = assessoriasData.find(a => (a.__backendId || a.id) === backendId);
      if (!assessoria) {
        showToast('Solu√ß√£o n√£o encontrada', 'error');
        return;
      }

      const btnCadastrar = document.getElementById('btn-cadastrar');
      btnCadastrar.disabled = true;
      btnCadastrar.textContent = '‚è≥ Atualizando...';

      const tipoMomento = document.getElementById('cad-tipo-momento').value;
      const categoriaValue = document.getElementById('cad-categoria').value;
      // Se categoria vazia (value="") ou "Nenhuma", salvar como null
      const categoriaFinal = (categoriaValue && categoriaValue.trim() !== '' && categoriaValue !== 'Nenhuma' && categoriaValue !== '__nenhuma__') ? categoriaValue : null;

      const dadosAtualizados = {
        codigo: document.getElementById('cad-codigo').value || null,
        momento_empresarial: tipoMomento === 'empresarial' ? categoriaFinal : null,
        crescimento_empresarial: tipoMomento === 'crescimento' ? categoriaFinal : null,
        porte: document.getElementById('cad-porte').value,
        setor: document.getElementById('cad-setor').value,
        assessoria_nome: document.getElementById('cad-nome').value,
        assessoria_descricao: document.getElementById('cad-descricao').value,
        segmento: document.getElementById('cad-segmento').value || null,
        area_conhecimento: document.getElementById('cad-area-conhecimento').value || null,
        carga_horaria: document.getElementById('cad-carga-horaria').value || null,
        instrumento: document.getElementById('cad-instrumento').value || null,
        fornecedor: document.getElementById('cad-fornecedor').value || null,
        proxima_data: document.getElementById('cad-proxima-data').value || null,
        data_validade: document.getElementById('cad-data-validade').value || null,
        valor: parseFloat(document.getElementById('cad-valor').value) || 0,
        ordem: parseInt(document.getElementById('cad-ordem').value) || 1,
        link_direcionamento: document.getElementById('cad-link-direcionamento').value || null
      };

      try {
        if (supabaseClient && backendId) {
          const { error } = await supabaseClient.from('solucoes').update(dadosAtualizados).eq('id', backendId);
          if (error) throw error;
        }

        // Atualizar no array local
        const index = assessoriasData.findIndex(a => (a.__backendId || a.id) === backendId);
        if (index >= 0) {
          assessoriasData[index] = { ...assessoriasData[index], ...dadosAtualizados };
          if (!supabaseClient) persistirDados();
        }

        showToast('‚úì Solu√ß√£o atualizada com sucesso!', 'success');
        document.getElementById('cadastro-form').reset();
        atualizarListaAssessorias();

        // Restaurar bot√£o
        btnCadastrar.textContent = '‚úì Cadastrar Solu√ß√£o';
        btnCadastrar.type = 'submit';
        btnCadastrar.onclick = null;
      } catch (error) {
        showToast('‚úó Erro ao atualizar: ' + (error.message || 'Erro desconhecido'), 'error');
      } finally {
        btnCadastrar.disabled = false;
      }
    }

    // ============================================
    // FUN√á√ïES DO CALEND√ÅRIO
    // ============================================
    let calendarioDataAtual = new Date();
    let calendarioSolucoes = [];

    const monthNames = [
      'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];

    const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

    async function carregarCalendario() {
      const container = document.getElementById('calendario-container');
      container.innerHTML = '<div class="text-center py-12"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2" style="border-color: var(--primary-blue);"></div><p class="mt-4" style="color: #666;">Carregando calend√°rio...</p></div>';

      try {
        if (supabaseClient) {
          // Buscar todas as solu√ß√µes primeiro para debug
          const { data: allData, error: allError } = await supabaseClient
            .from('solucoes')
            .select('id, codigo, assessoria_nome, assessoria_descricao, proxima_data, porte, setor, valor, link_direcionamento');
          
          console.log('üìÖ Todas as solu√ß√µes:', allData);
          
          // Filtrar apenas as que t√™m proxima_data (n√£o vazia e n√£o nula)
          const solutionsWithDate = (allData || []).filter(s => {
            const data = s.proxima_data;
            return data && data !== null && data !== '' && data.trim() !== '';
          });
          
          console.log('üìÖ Solu√ß√µes com proxima_data:', solutionsWithDate);
          
          if (allError) {
            throw allError;
          }
          
          // Converter e ordenar por data
          calendarioSolucoes = solutionsWithDate
            .map(s => {
              // Tentar converter proxima_data para Date
              // proxima_data pode estar no formato "DD/MM/YYYY" ou "YYYY-MM-DD"
              let dateObj = null;
              const dataStr = s.proxima_data.trim();
              
              // Tentar formato brasileiro DD/MM/YYYY
              if (dataStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const [dia, mes, ano] = dataStr.split('/');
                dateObj = new Date(ano, mes - 1, dia);
              } 
              // Tentar formato ISO YYYY-MM-DD
              else if (dataStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                dateObj = new Date(dataStr);
              }
              // Tentar parse direto
              else {
                dateObj = new Date(dataStr);
              }
              
              return {
                ...s,
                _dataParsed: dateObj,
                _dataStr: dataStr
              };
            })
            .filter(s => s._dataParsed && !isNaN(s._dataParsed.getTime()))
            .sort((a, b) => a._dataParsed - b._dataParsed);
          
          console.log('üìÖ Solu√ß√µes ordenadas:', calendarioSolucoes);
        } else {
          console.warn('‚ö†Ô∏è Supabase client n√£o dispon√≠vel');
          calendarioSolucoes = [];
        }

        console.log('üìÖ Total de solu√ß√µes para calend√°rio:', calendarioSolucoes.length);
        
        if (calendarioSolucoes.length === 0) {
          console.warn('‚ö†Ô∏è Nenhuma solu√ß√£o com data de validade encontrada');
        }
        
        atualizarEstatisticasCalendario();
        renderizarCalendario();
      } catch (error) {
        console.error('‚ùå Erro ao carregar calend√°rio:', error);
        
        // Erro gen√©rico
        container.innerHTML = `
          <div class="glass-card rounded-xl p-8 text-center border-2" style="border-color: #e74c3c;">
            <div class="text-6xl mb-4">‚ùå</div>
            <h3 class="text-2xl font-bold mb-4" style="color: #e74c3c;">Erro ao Carregar Calend√°rio</h3>
            <p class="text-lg mb-4" style="color: #666;">${error.message || 'Erro desconhecido'}</p>
            <p class="text-sm mb-4" style="color: #999;">Verifique se h√° solu√ß√µes cadastradas com <strong>pr√≥xima_data</strong> preenchida.</p>
            <button onclick="carregarCalendario()" class="btn-modern px-6 py-3 text-white font-semibold rounded-xl" style="background: var(--primary-blue);">
              üîÑ Tentar Novamente
            </button>
          </div>
        `;
      }
    }

    function atualizarEstatisticasCalendario() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const sevenDaysFromNow = new Date(today);
      sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);

      const valid = calendarioSolucoes.filter(s => {
        if (!s._dataParsed) return false;
        const validade = new Date(s._dataParsed);
        if (isNaN(validade.getTime())) return false;
        validade.setHours(0, 0, 0, 0);
        return validade >= today;
      }).length;

      const expiringSoon = calendarioSolucoes.filter(s => {
        if (!s._dataParsed) return false;
        const validade = new Date(s._dataParsed);
        if (isNaN(validade.getTime())) return false;
        validade.setHours(0, 0, 0, 0);
        return validade >= today && validade <= sevenDaysFromNow;
      }).length;

      const expired = calendarioSolucoes.filter(s => {
        if (!s._dataParsed) return false;
        const validade = new Date(s._dataParsed);
        if (isNaN(validade.getTime())) return false;
        validade.setHours(0, 0, 0, 0);
        return validade < today;
      }).length;

      // Atualizar estat√≠sticas na sidebar
      const statsSidebar = document.getElementById('calendario-stats-sidebar');
      if (statsSidebar) {
        statsSidebar.innerHTML = `
          <div class="text-xs">
            <div class="font-semibold" style="color: var(--primary-blue);">Total:</div>
            <div class="text-lg font-bold" style="color: #666;">${calendarioSolucoes.length}</div>
          </div>
          <div class="text-xs">
            <div class="font-semibold" style="color: var(--accent-green);">V√°lidas:</div>
            <div class="text-lg font-bold" style="color: #666;">${valid}</div>
          </div>
          <div class="text-xs">
            <div class="font-semibold" style="color: #f39c12;">Expirando:</div>
            <div class="text-lg font-bold" style="color: #666;">${expiringSoon}</div>
          </div>
          <div class="text-xs">
            <div class="font-semibold" style="color: #e74c3c;">Expiradas:</div>
            <div class="text-lg font-bold" style="color: #666;">${expired}</div>
          </div>
        `;
      }
    }

    function renderizarCalendario() {
      const year = calendarioDataAtual.getFullYear();
      const month = calendarioDataAtual.getMonth();

      document.getElementById('calendario-mes-atual').textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const prevMonthLastDay = new Date(year, month, 0).getDate();

      let calendarHTML = '<div class="bg-white rounded-xl border-2 overflow-hidden w-full" style="border-color: #A0C5CF;"><table class="w-full" style="table-layout: fixed; border-collapse: collapse; width: 100%;"><thead><tr>';
      weekDays.forEach(day => {
        calendarHTML += `<th style="width: calc(100% / 7); padding: 0.5rem; text-align: center; font-weight: bold; color: white; background: var(--primary-blue); border-right: 1px solid rgba(255,255,255,0.2); box-sizing: border-box;">${day}</th>`;
      });
      calendarHTML += '</tr></thead><tbody>';

      // Primeira linha - dias do m√™s anterior
      calendarHTML += '<tr>';
      for (let i = startDay - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        calendarHTML += `<td class="bg-gray-50" style="width: calc(100% / 7); height: 140px; min-height: 140px; max-height: 140px; padding: 0.5rem; vertical-align: top; overflow: hidden; box-sizing: border-box; border: 1px solid #e5e7eb;"><div class="text-xs md:text-sm font-semibold text-gray-400 mb-1">${day}</div><div class="eventos-container" style="max-height: calc(140px - 2rem); overflow-y: auto;"></div></td>`;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Dias do m√™s atual
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const currentDay = new Date(year, month, day);
        currentDay.setHours(0, 0, 0, 0);
        
        const isToday = currentDay.getTime() === today.getTime();
        const dayBgClass = isToday ? 'bg-blue-50' : 'bg-white';
        const dayBorderStyle = isToday ? 'border-4' : 'border';
        const dayBorderColor = isToday ? 'border-black' : 'border-gray-200';
        const dayTextStyle = isToday ? 'font-bold text-lg text-blue-700' : 'font-semibold text-gray-700';

        const daySolutions = calendarioSolucoes.filter(s => {
          if (!s._dataParsed) return false;
          try {
            const validade = new Date(s._dataParsed);
            if (isNaN(validade.getTime())) return false;
            validade.setHours(0, 0, 0, 0);
            return validade.getTime() === currentDay.getTime();
          } catch (e) {
            console.warn('Erro ao processar proxima_data:', s.proxima_data, e);
            return false;
          }
        });

        const borderWidth = isToday ? '4px' : '1px';
        const borderColor = isToday ? '#000000' : '#e5e7eb';
        calendarHTML += `<td class="${dayBgClass}" style="width: calc(100% / 7); height: 140px; min-height: 140px; max-height: 140px; padding: 0.5rem; vertical-align: top; overflow: hidden; box-sizing: border-box; border: ${borderWidth} solid ${borderColor};"><div class="text-sm md:text-base mb-1 ${dayTextStyle}">${day}</div><div class="eventos-container" style="max-height: calc(140px - 2.5rem); overflow-y: auto; width: 100%;">`;

        // Mostrar eventos do dia (solu√ß√µes)
        if (daySolutions.length > 0) {
          daySolutions.forEach(solution => {
            const validade = solution._dataParsed ? new Date(solution._dataParsed) : null;
            if (!validade || isNaN(validade.getTime())) return;
            
            validade.setHours(0, 0, 0, 0);
            
            let bgColor = '';
            let textColor = '#fff';
            if (validade < today) {
              bgColor = '#e74c3c'; // Vermelho para data passada
            } else {
              const daysUntilExpiry = Math.ceil((validade - today) / (1000 * 60 * 60 * 24));
              if (daysUntilExpiry <= 7) {
                bgColor = '#f39c12'; // Laranja para pr√≥ximo (7 dias)
              } else {
                bgColor = '#00A859'; // Verde para v√°lida (mais de 7 dias)
              }
            }

            const nome = solution.assessoria_nome || 'Sem nome';
            const nomeTruncado = nome.length > 30 ? nome.substring(0, 30) + '...' : nome;
            
            calendarHTML += `<div class="evento-dia mb-1 p-1 rounded text-white cursor-pointer transition-all hover:shadow-lg text-[10px] md:text-xs font-medium leading-tight" 
              onclick="mostrarDetalhesSolucao('${solution.id}')" 
              style="background: ${bgColor}; color: ${textColor};"
              title="${nome}">
              ${nomeTruncado}
            </div>`;
          });
        }
        calendarHTML += '</div>';
        calendarHTML += '</td>';

        // Nova linha a cada domingo
        if ((startDay + day) % 7 === 0) {
          calendarHTML += '</tr>';
          if (day < lastDay.getDate()) {
            calendarHTML += '<tr>';
          }
        }
      }

      // Preencher √∫ltimos dias do m√™s seguinte
      const remainingDays = 7 - ((startDay + lastDay.getDate()) % 7);
      if (remainingDays < 7 && remainingDays > 0) {
        for (let day = 1; day <= remainingDays; day++) {
          calendarHTML += `<td class="bg-gray-50" style="width: calc(100% / 7); height: 140px; min-height: 140px; max-height: 140px; padding: 0.5rem; vertical-align: top; overflow: hidden; box-sizing: border-box; border: 1px solid #e5e7eb;"><div class="text-xs md:text-sm font-semibold text-gray-400 mb-1">${day}</div><div class="eventos-container" style="max-height: calc(140px - 2rem); overflow-y: auto;"></div></td>`;
        }
        calendarHTML += '</tr>';
      } else if ((startDay + lastDay.getDate()) % 7 !== 0) {
        calendarHTML += '</tr>';
      }

      calendarHTML += '</tbody></table></div>';
      
      // Adicionar mensagem se n√£o houver solu√ß√µes
      if (calendarioSolucoes.length === 0) {
        calendarHTML += `
          <div class="mt-4 text-center p-6 bg-yellow-50 rounded-lg border-2 border-yellow-200">
            <div class="text-4xl mb-3">üìÖ</div>
            <p class="text-sm font-semibold text-yellow-800 mb-2">Nenhuma solu√ß√£o com data de validade encontrada</p>
            <p class="text-xs text-yellow-700">Cadastre solu√ß√µes com <strong>pr√≥xima data</strong> na aba <strong>Gest√£o</strong> para visualiz√°-las no calend√°rio.</p>
          </div>
        `;
      }
      
      document.getElementById('calendario-container').innerHTML = calendarHTML;
      
      console.log('‚úÖ Calend√°rio renderizado com sucesso');
    }

    function calendarioMesAnterior() {
      calendarioDataAtual.setMonth(calendarioDataAtual.getMonth() - 1);
      renderizarCalendario();
    }

    function calendarioProximoMes() {
      calendarioDataAtual.setMonth(calendarioDataAtual.getMonth() + 1);
      renderizarCalendario();
    }


    function mostrarDetalhesSolucao(id) {
      const solution = calendarioSolucoes.find(s => s.id === id);
      if (!solution) return;

      const validade = solution._dataParsed ? new Date(solution._dataParsed) : null;
      if (!validade || isNaN(validade.getTime())) {
        alert('Data inv√°lida para esta solu√ß√£o');
        return;
      }
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      validade.setHours(0, 0, 0, 0);

      const daysUntilExpiry = Math.ceil((validade - today) / (1000 * 60 * 60 * 24));
      let statusText = '';
      let statusClass = '';

      if (validade < today) {
        statusText = `Data passada h√° ${Math.abs(daysUntilExpiry)} dia(s)`;
        statusClass = 'text-red-600';
      } else if (daysUntilExpiry <= 7) {
        statusText = `Pr√≥xima data em ${daysUntilExpiry} dia(s)`;
        statusClass = 'text-orange-600';
      } else {
        statusText = `Pr√≥xima data: ${validade.toLocaleDateString('pt-BR')}`;
        statusClass = 'text-green-600';
      }

      const modalHTML = `
        <div id="modal-calendario-detalhes" class="modal-overlay" onclick="fecharModalCalendario(event)">
          <div class="modal-content max-w-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-2xl font-bold" style="color: var(--primary-blue);">${solution.assessoria_nome || 'Sem nome'}</h3>
              <button onclick="fecharModalCalendario(event)" class="text-2xl font-bold text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            ${solution.codigo ? `<p class="mb-2"><strong style="color: var(--primary-blue);">C√≥digo:</strong> ${solution.codigo}</p>` : ''}
            ${solution.assessoria_descricao ? `<p class="mb-4"><strong style="color: var(--primary-blue);">Descri√ß√£o:</strong><br>${solution.assessoria_descricao}</p>` : ''}
            <p class="mb-2"><strong style="color: var(--primary-blue);">Pr√≥xima Data:</strong> ${solution.proxima_data || solution._dataStr || 'N/A'}</p>
            <p class="mb-2"><strong style="color: var(--primary-blue);">Status:</strong> <span class="${statusClass} font-semibold">${statusText}</span></p>
            ${solution.porte ? `<p class="mb-2"><strong style="color: var(--primary-blue);">Porte:</strong> ${solution.porte}</p>` : ''}
            ${solution.setor ? `<p class="mb-2"><strong style="color: var(--primary-blue);">Setor:</strong> ${solution.setor}</p>` : ''}
            ${solution.valor !== undefined ? `<p class="mb-2"><strong style="color: var(--primary-blue);">Valor:</strong> ${solution.valor > 0 ? `R$ ${parseFloat(solution.valor).toFixed(2)}` : 'Gratuito'}</p>` : ''}
            ${solution.link_direcionamento ? `<p class="mt-4"><a href="${solution.link_direcionamento}" target="_blank" rel="noopener noreferrer" class="btn-modern px-6 py-3 text-white font-semibold rounded-lg inline-block" style="background: var(--primary-blue);">üîó Acessar Solu√ß√£o ‚Üí</a></p>` : ''}
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function fecharModalCalendario(event) {
      const modal = document.getElementById('modal-calendario-detalhes');
      if (modal) {
        modal.remove();
      }
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c296652c4c836f6',t:'MTc2OTE5MzQxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
